---
title: "figure_3"
author: "Tabea M. Soelter"
date: '2023-10-16'
output: html_document
---
**Plotting Main Figure 3**

__Goal__: This is a script for generating figure 3 of my manuscript.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.5
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 85GB per CPU

__Data__:
*MultiNicheNet output*
* Name: geo_multinichenet_output.rds
* Location: data/ccc/
*Jaccard Index outputs*
* Name: jaccard_results_ligands.rds, jaccard_results_receptors.rds, jaccard_results_targets.rds, jaccard_receptors.rds, jaccard_targets.rds
* Location: results/intermediate_outputs/geo/ccc/
 
__Analysis Plan__:
* Load necessary packages 
* Load data
  * MultiNicheNet output
* Plot individual panels
  * A: stacked barplot of interactions in AD and CTRL, colored by receiver cell type
  * B: lollipop plot of JI for receptors and targets in receivers
  * C: corr plot of JI of ligands in senders by receiver cell types
  * D: corr plot of JI of receptors by receiver and sender cell types
  * E: corr plot of JI of targets by receiver and sender cell types
* Compile figure
* Save figure

# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(multinichenetr)
  library(patchwork)
  library(cowplot)
  library(ggcorrplot)
  library(ggpubr)
  library(grid)
  library(here)
  library(styler)
  library(lintr)
})

source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
# MultiNicheNet output
output <- readRDS(here("data", "ccc", "geo_multinichenet_output.rds"))

# Jaccard Similarity Index
jaccard_results_ligands <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "jaccard_ligands_senders.rds"
))

jaccard_results_receptors <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "jaccard_receptors_senders.rds"
))

jaccard_results_targets <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "jaccard_targets_senders.rds"
))

jaccard_receptors <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "jaccard_receptors_receivers.rds"
))

jaccard_targets <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "jaccard_targets_receivers.rds"
))
```

# Colors
```{r}
colors <- c(
  "lightblue",
  "royalblue",
  "darkred",
  "darksalmon",
  "goldenrod1"
)
```

# Set Filtering Criteria
* These are the same as previously
```{r}
# number of targets
top_n_target <- 250

# contrast table
contrast_tbl <- tibble(
  contrast = c("AD-CTRL", "CTRL-AD"),
  group = c("AD", "CTRL")
)

# set receiver and sender cell types of interest
receiver_oi <- c("Excitatory.Neurons", "Inhibitory.Neurons")
sender_oi <- c("Astrocytes", "Microglia", "OPCs", "Oligodendrocytes")
```

# Panel 3A
```{r}
# pull all interactions up-regulated in CTRL (inferred as down/lost in AD)
group_oi <- "CTRL"

prior <- filter_nichenet(output)

prior_filt_ctrl <- prior %>%
  select("id_target", "sender", "receiver") %>%
  mutate(condition = "CTRL")

# pull all interactions up-regulated in AD
group_oi <- "AD"

prior <- filter_nichenet(output)

prior_filt_ad <- prior %>%
  select("id_target", "sender", "receiver") %>%
  mutate(condition = "AD")

# combine into 1 dataframe
combined <- rbind(prior_filt_ad, prior_filt_ctrl)

# aggregate numbers by sender and condition
prior_num <- combined %>%
  group_by(sender, receiver) %>%
  summarize(interactions = n_distinct(id_target))

prior_num$receiver <- ifelse(
  prior_num$receiver == "Inhibitory.Neurons",
  "Inhibitory Neurons",
  "Excitatory Neurons"
)

# Plot stacked barplot
panel_a <- ggplot(prior_num, aes(
  x = sender,
  y = interactions,
  fill = receiver
)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Sender") +
  ylab("Number of Interactions") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_discrete(name = "Receiver") +
  theme_bw() +
  geom_text(aes(label = interactions),
    position = "stack",
    vjust = 2,
    fontface = "bold"
  ) +
  scale_fill_manual(values = c(
    `Excitatory Neurons` = "slateblue3",
    `Inhibitory Neurons` = "darkslategray3"
  )) +
  labs(fill = "Receiver") +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold", size = 12)) +
  theme(
    axis.title = element_text(face = "bold", size = 14),
    legend.title = element_text(face = "bold", size = 12),
    text = element_text(face = "bold")
  )

panel_a
```

# Panel 3B
```{r}
jaccard_receptors$type <- "Receptors"
jaccard_targets$type <- "Targets"

jaccard_all <- rbind(jaccard_receptors, jaccard_targets)



panel_b <- jaccard_all %>%
  ggplot() +
  geom_linerange(
    aes(
      x = reorder(sender, desc(sender)),
      ymin = 0,
      ymax = jaccard_index,
      colour = type
    ),
    position = position_dodge(width = 0.2), size = 1
  ) +
  geom_point(
    aes(
      x = reorder(sender, desc(sender)),
      y = jaccard_index,
      colour = type
    ),
    position = position_dodge(width = 0.2), size = 2
  ) +
  coord_flip() +
  scale_color_manual(
    values = c(
      "Receptors" = "salmon",
      "Targets" = "tomato4"
    ),
    name = "Type"
  ) +
  theme_bw() +
  labs(x = "Sender", y = "JI") +
  ylim(0, 0.5) +
  theme(
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
    legend.text = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 14)
  )

panel_b
```

# Panel 3C
```{r}
jaccard_ligands_df <- data.frame(
  cell_types = names(jaccard_results_ligands),
  jaccard_index = unlist(jaccard_results_ligands),
  stringsAsFactors = FALSE
)

jaccard_ligands_df <- jaccard_ligands_df %>%
  separate(cell_types,
    into = c(
      "receiver",
      "celltype1",
      "celltype2"
    ),
    sep = "_"
  )

jaccard_ligands_df <- jaccard_ligands_df %>%
  spread(
    key = celltype2,
    value = jaccard_index
  )

# prep ex neuron input
jaccard_ligands_ex <- jaccard_ligands_df %>%
  filter(receiver == "Excitatory Neurons")

jaccard_ex_mat <- as.matrix(jaccard_ligands_ex[-c(1:2)])
rownames(jaccard_ex_mat) <- jaccard_ligands_ex[[2]]

jaccard_ligands_in <- jaccard_ligands_df %>%
  filter(receiver == "Inhibitory Neurons")

jaccard_in_mat <- as.matrix(jaccard_ligands_in[-c(1:2)])
rownames(jaccard_in_mat) <- jaccard_ligands_in[[2]]

jaccard_ex_mat[lower.tri(jaccard_ex_mat)] <-
  jaccard_in_mat[lower.tri(jaccard_in_mat)]

panel_c <- ggcorrplot(jaccard_ex_mat,
  outline.color = "white",
  lab = TRUE,
  lab_size = 5
) +
  scale_fill_gradientn(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2),
    colors = colors,
    name = "JI"
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(angle = 90, size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    panel.grid.major = element_blank()
  ) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Ligands")

panel_c
```

# Panel 3D
```{r}
jaccard_receptors_df <- data.frame(
  cell_types = names(jaccard_results_receptors),
  jaccard_index = unlist(jaccard_results_receptors),
  stringsAsFactors = FALSE
)

jaccard_receptors_df <- jaccard_receptors_df %>%
  separate(cell_types,
    into = c(
      "receiver",
      "celltype1",
      "celltype2"
    ),
    sep = "_"
  )

jaccard_receptors_df <- jaccard_receptors_df %>%
  spread(
    key = celltype2,
    value = jaccard_index
  )
# prep ex neuron input
jaccard_receptors_ex <- jaccard_receptors_df %>%
  filter(receiver == "Excitatory Neurons")

jaccard_ex_mat <- as.matrix(jaccard_receptors_ex[-c(1:2)])
rownames(jaccard_ex_mat) <- jaccard_receptors_ex[[2]]

jaccard_receptors_in <- jaccard_receptors_df %>%
  filter(receiver == "Inhibitory Neurons")

jaccard_in_mat <- as.matrix(jaccard_receptors_in[-c(1:2)])
rownames(jaccard_in_mat) <- jaccard_receptors_in[[2]]

jaccard_ex_mat[lower.tri(jaccard_ex_mat)] <-
  jaccard_in_mat[lower.tri(jaccard_in_mat)]

panel_d <- ggcorrplot(jaccard_ex_mat,
  outline.color = "white",
  lab = TRUE,
  lab_size = 5
) +
  scale_fill_gradientn(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2),
    colors = colors,
    name = "JI"
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(angle = 90, size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    panel.grid.major = element_blank()
  ) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Receptors")

panel_d
```

# Panel 3E
```{r}
jaccard_targets_df <- data.frame(
  cell_types = names(jaccard_results_targets),
  jaccard_index = unlist(jaccard_results_targets),
  stringsAsFactors = FALSE
)

jaccard_targets_df <- jaccard_targets_df %>%
  separate(cell_types,
    into = c(
      "receiver",
      "celltype1",
      "celltype2"
    ),
    sep = "_"
  )

jaccard_targets_df <- jaccard_targets_df %>%
  spread(
    key = celltype2,
    value = jaccard_index
  )

# prep ex neuron input
jaccard_targets_ex <- jaccard_targets_df %>%
  filter(receiver == "Excitatory Neurons")

jaccard_ex_mat <- as.matrix(jaccard_targets_ex[-c(1:2)])
rownames(jaccard_ex_mat) <- jaccard_targets_ex[[2]]

jaccard_targets_in <- jaccard_targets_df %>%
  filter(receiver == "Inhibitory Neurons")

jaccard_in_mat <- as.matrix(jaccard_targets_in[-c(1:2)])
rownames(jaccard_in_mat) <- jaccard_targets_in[[2]]

jaccard_ex_mat[lower.tri(jaccard_ex_mat)] <-
  jaccard_in_mat[lower.tri(jaccard_in_mat)]

panel_e <- ggcorrplot(jaccard_ex_mat,
  outline.color = "white",
  lab = TRUE,
  lab_size = 5
) +
  scale_fill_gradientn(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2),
    colors = colors,
    name = "JI"
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(angle = 90, size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.text = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 14),
    panel.grid.major = element_blank()
  ) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Targets")

panel_e
```

# Compile Figure
```{r}
bottom <- ggarrange(panel_c,
  panel_d,
  panel_e,
  ncol = 3,
  common.legend = TRUE,
  legend = "right",
  labels = c("C", "D", "E")
)


top <- plot_grid(panel_a,
  panel_b,
  labels = c("A", "B")
)


fig3 <- plot_grid(top,
  bottom,
  ncol = 1
)

fig3
```

# Save Figure
```{r}
png(
  here(
    "results",
    "figures",
    "figure3.png"
  ),
  width = 375,
  height = 250,
  units = "mm",
  res = 300
)
fig3
dev.off()
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2          styler_1.9.1         here_1.0.1           ggpubr_0.6.0         ggcorrplot_0.1.4    
 [6] cowplot_1.1.1        patchwork_1.1.2      multinichenetr_1.0.0 lubridate_1.9.2      forcats_1.0.0       
[11] stringr_1.5.0        dplyr_1.1.3          purrr_1.0.2          readr_2.1.4          tidyr_1.3.0         
[16] tibble_3.2.1         ggplot2_3.4.2        tidyverse_2.0.0     

loaded via a namespace (and not attached):
  [1] rsvd_1.0.5                  Hmisc_5.1-0                 ica_1.0-3                   ps_1.7.5                   
  [5] class_7.3-20                rprojroot_2.0.3             foreach_1.5.2               lmtest_0.9-40              
  [9] crayon_1.5.2                rbibutils_2.2.13            MASS_7.3-55                 nlme_3.1-155               
 [13] backports_1.4.1             sva_3.42.0                  rlang_1.1.1                 XVector_0.34.0             
 [17] caret_6.0-94                ROCR_1.0-11                 irlba_2.3.5.1               callr_3.7.3                
 [21] nloptr_2.0.3                limma_3.50.3                scater_1.22.0               BiocParallel_1.28.3        
 [25] rjson_0.2.21                bit64_4.0.5                 glue_1.6.2                  sctransform_0.3.5.9006     
 [29] processx_3.8.1              pbkrtest_0.5.2              parallel_4.1.3              vipor_0.4.5                
 [33] spatstat.sparse_3.0-2       AnnotationDbi_1.56.2        BiocGenerics_0.40.0         UpSetR_1.4.0               
 [37] muscat_1.8.2                spatstat.geom_3.2-2         tidyselect_1.2.0            SummarizedExperiment_1.24.0
 [41] SeuratObject_4.1.3          fitdistrplus_1.1-11         variancePartition_1.24.1    XML_3.99-0.14              
 [45] zoo_1.8-12                  xtable_1.8-4                magrittr_2.0.3              evaluate_0.21              
 [49] Rdpack_2.4                  scuttle_1.4.0               cli_3.6.1                   zlibbioc_1.40.0            
 [53] rstudioapi_0.14             miniUI_0.1.1.1              sp_2.0-0                    rpart_4.1.16               
 [57] aod_1.3.2                   locfdr_1.1-8                shiny_1.7.4.1               BiocSingular_1.10.0        
 [61] xfun_0.40                   clue_0.3-64                 cluster_2.1.2               caTools_1.18.2             
 [65] tidygraph_1.2.3             KEGGREST_1.34.0             ggrepel_0.9.3               listenv_0.9.0              
 [69] Biostrings_2.62.0           png_0.1-8                   future_1.33.0               ipred_0.9-14               
 [73] withr_2.5.0                 bitops_1.0-7                ggforce_0.4.1               plyr_1.8.8                 
 [77] hardhat_1.3.0               dqrng_0.3.0                 e1071_1.7-13                pROC_1.18.2                
 [81] coda_0.19-4                 pillar_1.9.0                nichenetr_2.0.0             gplots_3.1.3               
 [85] GlobalOptions_0.1.2         cachem_1.0.8                GetoptLong_1.0.5            DelayedMatrixStats_1.16.0  
 [89] vctrs_0.6.3                 ellipsis_0.3.2              generics_0.1.3              lava_1.7.2.1               
 [93] tools_4.1.3                 foreign_0.8-82              beeswarm_0.4.0              munsell_0.5.0              
 [97] tweenr_2.0.2                emmeans_1.8.6               proxy_0.4-27                DelayedArray_0.20.0        
[101] fastmap_1.1.1               compiler_4.1.3              abind_1.4-5                 httpuv_1.6.11              
[105] plotly_4.10.2               GenomeInfoDbData_1.2.7      prodlim_2023.03.31          gridExtra_2.3              
[109] glmmTMB_1.1.7               edgeR_3.36.0                lattice_0.20-45             ggnewscale_0.4.9           
[113] deldir_1.0-9                visNetwork_2.1.2            utf8_1.2.3                  later_1.3.1                
[117] recipes_1.0.6               jsonlite_1.8.7              scales_1.2.1                ScaledMatrix_1.2.0         
[121] carData_3.0-5               pbapply_1.7-2               sparseMatrixStats_1.6.0     estimability_1.4.1         
[125] genefilter_1.76.0           lazyeval_0.2.2              promises_1.2.0.1            car_3.1-2                  
[129] doParallel_1.0.17           R.utils_2.12.2              goftest_1.2-3               spatstat.utils_3.0-3       
[133] reticulate_1.30             checkmate_2.2.0             cyclocomp_1.1.0             rmarkdown_2.25             
[137] blme_1.0-5                  statmod_1.5.0               Rtsne_0.16                  Biobase_2.54.0             
[141] uwot_0.1.16                 igraph_1.5.1                survival_3.3-1              numDeriv_2016.8-1.1        
[145] htmltools_0.5.6             memoise_2.0.1               Seurat_4.3.0.9011           locfit_1.5-9.8             
[149] graphlayouts_1.0.0          IRanges_2.28.0              viridisLite_0.4.2           digest_0.6.33              
[153] RhpcBLASctl_0.23-42         mime_0.12                   RSQLite_2.3.1               future.apply_1.11.0        
[157] remotes_2.4.2               data.table_1.14.8           blob_1.2.4                  R.oo_1.25.0                
[161] S4Vectors_0.32.4            DiagrammeR_1.0.10           labeling_0.4.2              splines_4.1.3              
[165] Formula_1.2-5               RCurl_1.98-1.12             broom_1.0.5                 hms_1.1.3                  
[169] colorspace_2.1-0            base64enc_0.1-3             ggbeeswarm_0.7.2            GenomicRanges_1.46.1       
[173] shape_1.4.6                 nnet_7.3-17                 Rcpp_1.0.11                 RANN_2.6.1                 
[177] mvtnorm_1.2-2               circlize_0.4.15             fansi_1.0.4                 tzdb_0.4.0                 
[181] parallelly_1.36.0           ModelMetrics_1.2.2.2        R6_2.5.1                    factoextra_1.0.7           
[185] ggridges_0.5.4              lifecycle_1.0.3             bluster_1.4.0               ggsignif_0.6.4             
[189] minqa_1.2.5                 leiden_0.4.3                Matrix_1.5-4                desc_1.4.2                 
[193] RcppAnnoy_0.0.21            RColorBrewer_1.1-3          iterators_1.0.14            spatstat.explore_3.2-1     
[197] TMB_1.9.4                   gower_1.0.1                 R.cache_0.16.0              htmlwidgets_1.6.2          
[201] beachmat_2.10.0             polyclip_1.10-4             shadowtext_0.1.2            timechange_0.2.0           
[205] mgcv_1.8-39                 ComplexHeatmap_2.10.0       globals_0.16.2              htmlTable_2.4.1            
[209] spatstat.random_3.1-5       progressr_0.13.0            codetools_0.2-18            matrixStats_1.0.0          
[213] metapod_1.2.0               randomForest_4.7-1.1        gtools_3.9.4                prettyunits_1.2.0          
[217] SingleCellExperiment_1.16.0 R.methodsS3_1.8.2           GenomeInfoDb_1.30.1         gtable_0.3.3               
[221] DBI_1.1.3                   stats4_4.1.3                tensor_1.5                  httr_1.4.7                 
[225] KernSmooth_2.23-20          stringi_1.7.12              progress_1.2.2              reshape2_1.4.4             
[229] farver_2.1.1                annotate_1.72.0             viridis_0.6.3               rex_1.2.1                  
[233] fdrtool_1.2.17              timeDate_4022.108           xml2_1.3.5                  boot_1.3-28                
[237] BiocNeighbors_1.12.0        lme4_1.1-33                 geneplotter_1.72.0          scattermore_1.2            
[241] scran_1.22.1                DESeq2_1.34.0               bit_4.0.5                   MatrixGenerics_1.6.0       
[245] spatstat.data_3.0-1         ggraph_2.1.0                pkgconfig_2.0.3             lmerTest_3.1-3             
[249] rstatix_0.7.2               knitr_1.44

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: < 5 minutes
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "manuscript_figures",
  "figure_3.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "manuscript_figures",
  "figure_3.Rmd"
))
```

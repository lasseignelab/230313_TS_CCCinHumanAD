---
title: "02_figure_2"
author: "Tabea M. Soelter"
date: '2023-05-19'
output: html_document
---
This is a script for generating figure 2 of my manuscript.
- A: Jaccard index correlation plot - ligands
- B: Jaccard index correlation plot - receptors
- C: Jaccard index correlation plot - targets
- D: Scaled Ligand activity heatmap
- E: Jaccard index lollipop plot between ex and in neurons - receptors
- F: Jaccard index lollipop plot between ex and in neurons - targets

order might change here.
- might consider talking about all ligand plots first, then rec, then targets

# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(multinichenetr)
  library(circlize)
  library(ComplexHeatmap)
  library(RColorBrewer)
  library(reshape2)
  library(patchwork)
  library(cowplot)
  library(here)
  library(styler)
  library(lintr)
})
```

# Load data
```{r}
# MultiNicheNet output
output <- readRDS(here("data", "ccc", "geo_multinichenet_output.rds"))

# Jaccard Similarity Index  
saveRDS(
  jaccard_results_ligands,
  here(
    "results",
    "intermediate_outputs",
    "geo",
    "ccc",
    "jaccard_ligands_senders.rds"
  )
)

saveRDS(
  jaccard_results_receptors,
  here(
    "results",
    "intermediate_outputs",
    "geo",
    "ccc",
    "jaccard_receptors_senders.rds"
  )
)

saveRDS(
  jaccard_results_targets,
  here(
    "results",
    "intermediate_outputs",
    "geo",
    "ccc",
    "jaccard_targets_senders.rds"
  )
)

saveRDS(
  jaccard_receptors,
  here(
    "results",
    "intermediate_outputs",
    "geo",
    "ccc",
    "jaccard_receptors_receivers.rds"
  )
)

saveRDS(
  jaccard_targets,
  here(
    "results",
    "intermediate_outputs",
    "geo",
    "ccc",
    "jaccard_targets_receivers.rds"
  )
)
```

# Figure 1A
Jaccard Index correlation plot, where 1 half is excitatory neurons and the other is inhibitory neurons for ligands
```{r}
ggcorrplot(jaccard_ex_mat) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "Jaccard Index") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Ligands")
```

# Figure 1B
Jaccard Index correlation plot, where 1 half is excitatory neurons and the other is inhibitory neurons for receptors
```{r}
ggcorrplot(jaccard_ex_mat) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "Jaccard Index") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Receptors")
```

# Figure 1C
Jaccard Index correlation plot, where 1 half is excitatory neurons and the other is inhibitory neurons for targets
```{r}
ggcorrplot(jaccard_ex_mat) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "Jaccard Index") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Targets")
```

# Figure 1D
heatmap of scaled ligand activity split by sender cell type 
```{r}
group_oi <- "AD"
receiver_oi <- c("Excitatory.Neurons", "Inhibitory.Neurons")
sender_oi <- c("Astrocytes", "Oligodendrocytes", "OPCs", "Microglia")

df <- output$prioritization_tables$group_prioritization_tbl %>%
  filter(group == top_group & fraction_expressing_ligand_receptor > 0) %>%
  distinct(group, sender, receiver, ligand, receptor, receiver, id, prioritization_score) %>%
  filter(group == group_oi) %>%
  filter(sender %in% sender_oi) %>%
  filter(receiver %in% receiver_oi)








  
prioritization_tbl_oi = prioritization_tables$group_prioritization_tbl %>% 
    dplyr::filter(group == top_group & fraction_expressing_ligand_receptor > 
                    0) %>% dplyr::distinct(group, sender, receiver, ligand, 
                                           receptor, receiver, id, prioritization_score)
  if (!is.null(groups_oi)) {
    prioritization_tbl_oi = prioritization_tbl_oi %>% dplyr::filter(group %in% 
                                                                      groups_oi)
  }
  if (!is.null(senders_oi)) {
    prioritization_tbl_oi = prioritization_tbl_oi %>% dplyr::filter(sender %in% 
                                                                      senders_oi)
  }
  if (!is.null(receivers_oi)) {
    prioritization_tbl_oi = prioritization_tbl_oi %>% dplyr::filter(receiver %in% 
                                                                      receivers_oi)
  }
  if (rank_per_group == TRUE) {
    prioritization_tbl_oi = prioritization_tbl_oi %>% dplyr::group_by(group) %>% 
      dplyr::mutate(prioritization_rank = rank(desc(prioritization_score))) %>% 
      dplyr::filter(prioritization_rank <= top_n)
  } else {
    prioritization_tbl_oi = prioritization_tbl_oi %>% dplyr::mutate(prioritization_rank = rank(desc(prioritization_score))) %>% 
      dplyr::filter(prioritization_rank <= top_n)}








group_oi = "AD"
receiver_oi = "Excitatory.Neurons"
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_M_10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
pdf("combined_plot_ex.pdf", width = 20, height = 10)
combined_plot
dev.off()
```

# Figure 1E
Lollipop plot for jaccard index between receptors in ex and in neurons across sender cells.
```{r}
jaccard_receptors %>%
  arrange(jaccard_index) %>%
  mutate(sender = factor(sender, levels = sender)) %>%
  ggplot(aes(x = sender, y = jaccard_index)) +
  geom_segment(aes(xend = sender, yend = 0)) + 
  geom_point(size = 4, color = "#6a3d9a") +
  coord_flip() +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        panel.grid.major = element_blank()) +
  xlab("Sender Cells") +
  ylab("Jaccard Similarity between Excitatory and Inhibitory Neurons") +
  ylim(0, 0.5) +
  ggtitle("Receptors")
```

# Figure 1F
Lollipop plot for jaccard index between targets in ex and in neurons across sender cells.
```{r}
jaccard_targets %>%
  arrange(jaccard_index) %>%
  mutate(sender = factor(sender, levels = sender)) %>%
  ggplot(aes(x = sender, y = jaccard_index)) +
  geom_segment(aes(xend = sender, yend = 0)) + 
  geom_point(size = 4, color = "#cab2d6") +
  coord_flip() +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        panel.grid.major = element_blank()) +
  xlab("Sender Cells") +
  ylab("Jaccard Similarity between Excitatory and Inhibitory Neurons") +
  ylim(0, 0.5) +
  ggtitle("Targets")
```

# Compile figure 2
```{r}
library(ggpubr)
library(grid)
bottom <- ggarrange(panel_C,
                  panel_D,
                  panel_E, 
                  ncol = 3,
                  common.legend = T,
                  legend = "right",
                  labels = c("C", "D", "E"))


top <- plot_grid(panel_A,
                 panel_B,
                 labels = c("A", "B"))


fig2 <- plot_grid(top,
                  bottom,
                  ncol = 1)


fig2 <- plot_grid(panel_A,
                  panel_B,
                  panel_C,
                  panel_D,
                  panel_E,
                  panel_F,
                  labels = c("A", "B", "C", "D", "E", "F"),
                  ncol = 3)

png(here("results", "figures", "figure2.png"), width = 1000, height = 600)
fig2
dev.off()
```


```{r}
output <- readRDS(here("data", "ccc", "geo_multinichenet_output.rds"))

```

# colors
```{r}
colors <- c(
  `Oligodendrocytes` = "royalblue4",
  `Microglia` = "orchid3",
  `OPCs` = "mediumpurple1",
  `Astrocytes` = "cornflowerblue",
  `Excitatory Neurons` = "slateblue3",
  `Inhibitory Neurons` = "darkslategray3",
  `Pericytes` = "deepskyblue3",
  `Endothelial cells` = "darkolivegreen4")
```




## overview of interactions in geo 
```{r}
top_n_target <- 250

# total
contrast_tbl <- tibble(contrast = c("AD-CTRL", "CTRL-AD"),
                       group = c("AD", "CTRL"))

group_oi = "AD"

total <- output$lr_target_prior_cor %>%
  inner_join(output$ligand_activities_targets_DEgenes$ligand_activities %>%
               distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl)  %>%
  filter(group == group_oi)

total_filt <- total %>%
  select("id_target", "sender") 

total_num <- total_filt %>%
  group_by(sender) %>%
  summarize(interactions = n_distinct(id_target)) %>%
  mutate(type = print("total"))

ggplot(total_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity") +
  xlab("Sender") +
  ylab("Number of Unique Interactions") +
  theme_bw() +
  geom_text(aes(label = interactions), position = "stack", vjust = 2) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold")) +
  scale_fill_manual(values = c(`Oligodendrocytes` = "royalblue4",
                               `Microglia` = "orchid3",
                               `OPCs` = "mediumpurple1",
                               `Astrocytes` = "cornflowerblue",
                               `Excitatory.Neurons` = "slateblue3",
                               `Inhibitory.Neurons` = "darkslategray3",
                               `Pericytes` = "deepskyblue3",
                               `Endothelial.cells` = "darkolivegreen4"),
                    name = "Sender") 


receiver_oi = c("Excitatory.Neurons", "Inhibitory.Neurons")
sender_oi <- c("Astrocytes", "Microglia", "OPCs", "Oligodendrocytes")

oi <- output$lr_target_prior_cor %>%
  inner_join(output$ligand_activities_targets_DEgenes$ligand_activities %>%
               distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl) %>%
  filter(group == group_oi, receiver %in% receiver_oi, sender %in% sender_oi)

oi_filt <- oi %>%
  select("id_target", "sender")

oi_num <- oi_filt %>%
  group_by(sender) %>%
  summarize(interactions = n_distinct(id_target)) %>%
  mutate(type = print("oi"))

ggplot(oi_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity") +
  xlab("Sender") +
  ylab("Number of Unique Interactions") +
  theme_bw() +
  geom_text(aes(label = interactions), position = "stack", vjust = 2) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold")) +
  scale_fill_manual(values = c(`Oligodendrocytes` = "royalblue4",
                               `Microglia` = "orchid3",
                               `OPCs` = "mediumpurple1",
                               `Astrocytes` = "cornflowerblue"),
                    name = "Sender") 


lr_target_prior_cor_filtered = output$lr_target_prior_cor %>%
  inner_join(output$ligand_activities_targets_DEgenes$ligand_activities %>%
               distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl) %>%
  filter(group == group_oi, receiver %in% receiver_oi, sender %in% sender_oi)

lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "up") %>%
  filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))

lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "down") %>%
  filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))

prior <- bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)

prior_filt <- prior %>%
  select("id_target", "sender")

prior_num <- prior_filt %>%
  group_by(sender) %>%
  summarize(interactions = n_distinct(id_target)) %>%
  mutate(type = print("prior"))

ggplot(prior_num, aes(x = sender, y = interactions)) +
  geom_bar(stat = "identity") +
  xlab("Sender") +
  ylab("Number of Unique Interactions")

## combine into 1
combined_df <- bind_rows(
  total = total_num,
  senders_oi = oi_num,
  senders_oi_prior = prior_num
)

# Create a stacked barplot
ggplot(combined_df, aes(x = reorder(type, -interactions), y = interactions, fill = sender)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Cell Types") +
  ylab("Number of Unique Interactions") +
  #ggtitle("Number of Unique Genes in Each Condition for Different Contexts") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_discrete(name = "Context") +
  theme_bw() +
  geom_text(aes(label = interactions), position = "stack", vjust = 2)

combined_df <- bind_rows(
  #total = total_num,
  senders_oi = oi_num,
  senders_oi_prior = prior_num
)

ggplot(combined_df, aes(x = reorder(type, -interactions), y = interactions, fill = sender)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Cell Types") +
  ylab("Number of Unique Interactions") +
  #ggtitle("Number of Unique Genes in Each Condition for Different Contexts") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_discrete(name = "Sender") +
  theme_bw()+
  geom_text(aes(label = interactions), position = "stack", vjust = 2) +
  scale_fill_manual(values = c(`Astrocytes` = "cornflowerblue",
                               `Microglia` = "orchid3",
                               `Oligodendrocytes` = "royalblue4",
                               `OPCs` = "mediumpurple1"))


ggplot(prior_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Cell Types") +
  ylab("Number of Unique Interactions") +
  #ggtitle("Number of Unique Genes in Each Condition for Different Contexts") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_discrete(name = "Sender") +
  theme_bw()+
  geom_text(aes(label = interactions), position = "stack", vjust = 2) +
  scale_fill_manual(values = c(`Astrocytes` = "cornflowerblue",
                               `Microglia` = "orchid3",
                               `Oligodendrocytes` = "royalblue4",
                               `OPCs` = "mediumpurple1"))



prior_filt2 <- prior %>%
  select("id_target", "sender", "receiver")

prior_filt2$receiver <- ifelse(
  prior_filt2$receiver == "Inhibitory.Neurons",
  "Inhibitory Neurons",
  "Excitatory Neurons")

prior_num2 <- prior_filt2 %>%
  group_by(sender, receiver) %>%
  summarize(interactions = n_distinct(id_target)) %>%
  mutate(type = print("prior"))

ggplot(prior_num2, aes(x = sender, y = interactions, fill = receiver)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Sender") +
  ylab("Number of Interactions") +
  #ggtitle("Number of Unique Genes in Each Condition for Different Contexts") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_discrete(name = "Receiver") +
  theme_bw()+
  geom_text(aes(label = interactions), position = "stack", vjust = 2) +
  scale_fill_manual(values = c(`Excitatory Neurons` = "slateblue3",
                               `Inhibitory Neurons` = "darkslategray3")) +
  labs(fill = "Receiver") +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"))
```






```{r}
top_n_target <- 250

group_oi = "AD"
receiver_oi = c("Excitatory.Neurons", "Inhibitory.Neurons")
sender_oi <- c("Astrocytes", "Microglia", "OPCs", "Oligodendrocytes")

contrast_tbl <- tibble(contrast = c("AD-CTRL", "CTRL-AD"),
                       group = c("AD", "CTRL"))

lr_target_prior_cor_filtered = output$lr_target_prior_cor %>%
  inner_join(output$ligand_activities_targets_DEgenes$ligand_activities %>%
               distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl) %>%
  filter(group == group_oi, receiver %in% receiver_oi, sender %in% sender_oi)

lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "up") %>%
  filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))

lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "down") %>%
  filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50))

lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)


```


### Supplemental Figures ###
```{r}
panelA <-
ggplot(total_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity") +
  xlab("Sender") +
  ylab("Number of Unique Interactions") +
  theme_bw() +
  geom_text(aes(label = interactions), position = "stack", vjust = 2) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold")) +
  scale_fill_manual(values = c(`Oligodendrocytes` = "royalblue4",
                               `Microglia` = "orchid3",
                               `OPCs` = "mediumpurple1",
                               `Astrocytes` = "cornflowerblue",
                               `Excitatory.Neurons` = "slateblue3",
                               `Inhibitory.Neurons` = "darkslategray3",
                               `Pericytes` = "deepskyblue3",
                               `Endothelial.cells` = "darkolivegreen4"),
                    name = "Sender") 

panelB <-
ggplot(oi_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity") +
  xlab("Sender") +
  ylab("Number of Unique Interactions") +
  theme_bw() +
  geom_text(aes(label = interactions), position = "stack", vjust = 2) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold")) +
  scale_fill_manual(values = c(`Oligodendrocytes` = "royalblue4",
                               `Microglia` = "orchid3",
                               `OPCs` = "mediumpurple1",
                               `Astrocytes` = "cornflowerblue"),
                    name = "Sender") 

panelC <-
ggplot(prior_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Cell Types") +
  ylab("Number of Unique Interactions") +
  scale_fill_discrete(name = "Sender") +
  theme_bw()+
  geom_text(aes(label = interactions), position = "stack", vjust = 2) +
  scale_fill_manual(values = c(`Astrocytes` = "cornflowerblue",
                               `Microglia` = "orchid3",
                               `Oligodendrocytes` = "royalblue4",
                               `OPCs` = "mediumpurple1")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold")) 

supp_fig2 <- plot_grid(panelA,
                       panelB,
                       panelC,
                       labels = c("A", "B", "C"),
                       ncol = 3)

png(here("results", "figures", "supp_figure2.png"), width = 1200, height = 600)
supp_fig2
dev.off()
```

###### JI plotting prep and plotting code #######

# plotting
```{r}
colors <- c(
  "lightblue",
  "royalblue",
  "darkred",
  "darksalmon",
  "goldenrod1")

jaccard_ligands_df <- data.frame(cell_types = names(jaccard_results_ligands),
                                 jaccard_index = unlist(jaccard_results_ligands),
                                 stringsAsFactors = FALSE)

jaccard_ligands_df <- jaccard_ligands_df %>%
  separate(cell_types,
           into = c(
             "receiver",
             "celltype1",
             "celltype2"),
           sep = "_")

jaccard_ligands_df <- jaccard_ligands_df %>%
  spread(key = celltype2,
         value = jaccard_index)
# prep ex neuron input
jaccard_ligands_ex <- jaccard_ligands_df %>%
  filter(receiver == "Excitatory Neurons")

jaccard_ex_mat <- as.matrix(jaccard_ligands_ex[-c(1:2)])
rownames(jaccard_ex_mat) <- jaccard_ligands_ex[[2]]

jaccard_ligands_in <- jaccard_ligands_df %>%
  filter(receiver == "Inhibitory Neurons")

jaccard_in_mat <- as.matrix(jaccard_ligands_in[-c(1:2)])
rownames(jaccard_in_mat) <- jaccard_ligands_in[[2]]

corrplot::corrplot(jaccard_ex_mat, method = "circle", is.corr = FALSE, type = "lower", diag = FALSE)
corrplot::corrplot(jaccard_in_mat, method = "circle", is.corr = FALSE, type = "lower", diag = FALSE)

jaccard_ex_mat[lower.tri(jaccard_ex_mat)] <- jaccard_in_mat[lower.tri(jaccard_in_mat)]

ggcorrplot(jaccard_ex_mat, outline.color = "white", lab = TRUE) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "JI") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Ligands")

#### removing labels to combine
panel_C <- ggcorrplot(jaccard_ex_mat, outline.color = "white", lab = TRUE) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "JI") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Ligands")
```

receptors
```{r}
jaccard_receptors_df <- data.frame(cell_types = names(jaccard_results_receptors),
                                 jaccard_index = unlist(jaccard_results_receptors),
                                 stringsAsFactors = FALSE)

jaccard_receptors_df <- jaccard_receptors_df %>%
  separate(cell_types,
           into = c(
             "receiver",
             "celltype1",
             "celltype2"),
           sep = "_")

jaccard_receptors_df <- jaccard_receptors_df %>%
  spread(key = celltype2,
         value = jaccard_index)
# prep ex neuron input
jaccard_receptors_ex <- jaccard_receptors_df %>%
  filter(receiver == "Excitatory Neurons")

jaccard_ex_mat <- as.matrix(jaccard_receptors_ex[-c(1:2)])
rownames(jaccard_ex_mat) <- jaccard_receptors_ex[[2]]

jaccard_receptors_in <- jaccard_receptors_df %>%
  filter(receiver == "Inhibitory Neurons")

jaccard_in_mat <- as.matrix(jaccard_receptors_in[-c(1:2)])
rownames(jaccard_in_mat) <- jaccard_receptors_in[[2]]

corrplot::corrplot(jaccard_ex_mat, method = "circle", is.corr = FALSE, type = "lower", diag = FALSE)
corrplot::corrplot(jaccard_in_mat, method = "circle", is.corr = FALSE, type = "lower", diag = FALSE)

jaccard_ex_mat[lower.tri(jaccard_ex_mat)] <- jaccard_in_mat[lower.tri(jaccard_in_mat)]

ggcorrplot(jaccard_ex_mat, outline.color = "white", lab = TRUE) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "JI") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Receptors")

#### remove some labels for combining plots
panel_D <- ggcorrplot(jaccard_ex_mat, outline.color = "white", lab = TRUE) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "JI") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Receptors")
```

targets
```{r}
jaccard_targets_df <- data.frame(cell_types = names(jaccard_results_targets),
                                 jaccard_index = unlist(jaccard_results_targets),
                                 stringsAsFactors = FALSE)

jaccard_targets_df <- jaccard_targets_df %>%
  separate(cell_types,
           into = c(
             "receiver",
             "celltype1",
             "celltype2"),
           sep = "_")

jaccard_targets_df <- jaccard_targets_df %>%
  spread(key = celltype2,
         value = jaccard_index)
# prep ex neuron input
jaccard_targets_ex <- jaccard_targets_df %>%
  filter(receiver == "Excitatory Neurons")

jaccard_ex_mat <- as.matrix(jaccard_targets_ex[-c(1:2)])
rownames(jaccard_ex_mat) <- jaccard_targets_ex[[2]]

jaccard_targets_in <- jaccard_targets_df %>%
  filter(receiver == "Inhibitory Neurons")

jaccard_in_mat <- as.matrix(jaccard_targets_in[-c(1:2)])
rownames(jaccard_in_mat) <- jaccard_targets_in[[2]]

corrplot::corrplot(jaccard_ex_mat, method = "circle", is.corr = FALSE, type = "lower", diag = FALSE)

corrplot::corrplot(jaccard_in_mat, method = "circle", is.corr = FALSE, type = "upper", diag = FALSE)

jaccard_ex_mat[lower.tri(jaccard_ex_mat)] <- jaccard_in_mat[lower.tri(jaccard_in_mat)]

ggcorrplot(jaccard_ex_mat, outline.color = "white", lab = TRUE) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "JI") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Targets")

### remove some labels to combine with other plots
panel_E <- ggcorrplot(jaccard_ex_mat, outline.color = "white", lab = TRUE) +
  scale_fill_gradientn(limits = c(0, 1),
                       breaks = seq(0, 1, by = 0.2),
                       colors = colors,
                       name = "JI") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(angle = 90, size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid.major = element_blank()) +
  labs(x = "Excitatory Neurons", y = "Inhibitory Neurons") +
  ggtitle("Targets")

panel_B <- jaccard_all %>%
  ggplot() +
    geom_linerange(aes(x = reorder(sender, desc(sender)), ymin = 0, ymax = jaccard_index, colour = type), 
                   position = position_dodge(width = 0.2), size = 1)+
    geom_point(aes(x = reorder(sender, desc(sender)), y = jaccard_index, colour = type),
               position = position_dodge(width = 0.2), size = 2)+
    coord_flip() +
  scale_color_manual(values = c("Receptors" = "salmon", "Targets" = "tomato4"), name = "Type") +
  theme_bw() +
  labs(x = "Sender", y = "JI") +
  ylim(0, 0.5) +
  theme(axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
        legend.text = element_text(face = "bold"),
        legend.title = element_text(face = "bold"))
```

---
title: "01_figure_1"
author: "Tabea M. Soelter"
date: '2023-05-19'
output: html_document
---
This is a script for generating figure 1 of my manuscript.
- A: Study overview
- B: UMAP w cell type assignments
- C: Violin plot with expression of marker genes 
- D: UMAP split by condition
- E: Split barplot of cell types

# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(Seurat)
  library(circlize)
  library(ComplexHeatmap)
  library(RColorBrewer)
  library(reshape2)
  library(patchwork)
  library(cowplot)
  library(here)
  library(styler)
  library(lintr)
})
```

# Load in object
```{r}
geo_object <- readRDS(here(
  "data",
  "seurat_preprocessing",
  "geo_processed_seurat.rds"))
```

# Set color palette
```{r}
colors <- c(
  `Oligodendrocytes` = "royalblue4",
  `Microglia` = "orchid3",
  `OPCs` = "mediumpurple1",
  `Astrocytes` = "cornflowerblue",
  `Excitatory Neurons` = "slateblue3",
  `Inhibitory Neurons` = "darkslategray3",
  `Pericytes` = "deepskyblue3",
  `Endothelial cells` = "darkolivegreen4")
```

# Figure 1B
UMAP of assigned cell types
```{r}
UMAP_1 <- DimPlot(geo_object,
                  cols = colors,
                  label = TRUE,
                  label.box = TRUE,
                  label.color = "white",
                  label.size = 4,
                  repel = TRUE) +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold")) +
  NoLegend()

png(here(
  "results",
  "final_outputs", 
  "geo", 
  "UMAP_final2.png"), 
  width = 600, 
  height = 600)
UMAP_1
dev.off()
```

# Figure 1C
Violin plot of the marker gene expression of the assigned cell types
```{r}
markers <- c(
  "MBP",
  "ST18",
  "QDPR",
  "DOCK8",
  "APBB1IP",
  "ARHGAP15",
  "PCDH15",
  "PDGFRA",
  "ADGRV1",
  "AQP4",
  "GFAP",
  "RALYL",
  "IL1RAPL2",
  "NXPH1",
  "GRIK1",
  "PDGFRB",
  "FLT1",
  "VWF")

violin <- VlnPlot(geo_object,
                  markers,
                  stack = TRUE,
                  sort = FALSE,
                  flip = TRUE,
                  assay = "RNA",
                  fill.by = "ident",
                  cols = colors) +
  labs(fill = "Cell Type") +
  theme_minimal() +
  theme(legend.position = "left") +
  theme(axis.text.x = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(strip.text.y.right = element_text(angle = 0, face = "bold")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold")) +
  ylab("Marker Gene Expression")

png(here(
  "results",
  "final_outputs",
  "geo",
  "markers_violin_final.png"),
  width = 500,
  height = 700)
violin
dev.off()
```

# Figure 1D
UMAP split by condition
```{r}
UMAP_2 <- DimPlot(geo_object,
                  group.by = "orig.ident",
                  cols = "Paired",
                  shuffle = TRUE,
                  seed = 42) +
  theme(legend.title = element_text(face = "bold")) +
  labs(color = "Condition") +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold"))

UMAP_2 <- UMAP_2 + ggtitle(NULL)

png(here(
  "results",
  "final_outputs",
  "geo",
  "UMAP_condition_final.png"),
  width = 620,
  height = 600)
UMAP_2
dev.off()
```

# Figure 1E
Stacked barplot of cell type proportion distribution across conditions
```{r}
df <- table(Idents(geo_object), geo_object$orig.ident) %>% as.data.frame()
    
df$Var1 <- as.character(df$Var1)

barplot <- ggplot(df, aes(x = fct_rev(Var1), y = Freq, fill = Var2)) +
  theme_bw(base_size = 15) +
  geom_col(position = "fill", width = 0.5) +
  xlab("Cell Type") +
  ylab("Proportion") +
  scale_fill_manual(values = brewer.pal(12, "Paired")) +
  theme(legend.title = element_text(face = "bold")) +
  theme(axis.title = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold")) +
  theme(legend.text = element_text(face = "bold")) +
  coord_flip() +
  labs(fill = "Condition")

png(here(
  "results",
  "final_outputs",
  "geo",
  "stacked_barplot_final.png"),
  width = 600,
  height = 900)
barplot
dev.off()
```

# Compile figure 1
```{r}
fig1 <- plot_grid(UMAP_1,
                  UMAP_2,
                  violin,
                  barplot,
                  labels = c("A", "C", "B", "D"),
                  rel_heights = c(1, 2))

png(here("results", "figures", "figure1.png"), width = 300, height = 300, units = 'mm', res = 300)
fig1
dev.off()
```



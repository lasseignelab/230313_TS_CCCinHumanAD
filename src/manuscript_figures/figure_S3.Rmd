---
title: "figure_S3"
author: "Tabea M. Soelter"
date: '2023-10-15'
output: html_document
---
**Plotting Supplemental Figure 3**

__Goal__: This is a script for generating supplemental figure 3 of my manuscript.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.5
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 85GB per CPU

__Data__:
*MultiNicheNet output*
* Name: geo_multinichenet_output.rds
* Location: data/ccc/
 
__Analysis Plan__:
* Load necessary packages 
* Load data
  * MultiNicheNet output
* Plot individual panels
  * A: barplot of all interactions
  * B: barplot of interactions filtered by sender and receiver cell types
  * C: barplot of filtered interactions filtered by interaction strength
      * colored by the condition that they are up-regulated in
* Compile figure
* Save figure

# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(patchwork)
  library(cowplot)
  library(here)
  library(styler)
  library(lintr)
})

source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
output <- readRDS(here("data", "ccc", "geo_multinichenet_output_final.rds"))
```

# Colors
```{r}
colors <- c(
  `Oligodendrocytes` = "royalblue4",
  `Microglia` = "orchid3",
  `OPCs` = "mediumpurple1",
  `Astrocytes` = "cornflowerblue",
  `Excitatory Neurons` = "slateblue3",
  `Inhibitory Neurons` = "darkslategray3",
  `Pericytes` = "deepskyblue3",
  `Endothelial cells` = "darkolivegreen4"
)
```

# Set Filtering Criteria
* These are the same as previously
```{r}
# number of targets
top_n_target <- 250

# contrast table
contrast_tbl <- tibble(
  contrast = c("AD-CTRL", "CTRL-AD"),
  group = c("AD", "CTRL")
)

# set receiver and sender cell types of interest
receiver_oi <- c("Excitatory.Neurons", "Inhibitory.Neurons")
sender_oi <- c("Astrocytes", "Microglia", "OPCs", "Oligodendrocytes")
```

# Figure S3A
* plot all predicted interactions
```{r}
# filter MultiNicheNet output
total <- output$lr_target_prior_cor %>%
  inner_join(output$ligand_activities_targets_DEgenes$ligand_activities %>%
    distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl)

# filter for needed columns
total_filt <- total %>%
  select("id_target", "sender")

# compile number of interactions by sender
total_num <- total_filt %>%
  group_by(sender) %>%
  summarize(interactions = n_distinct(id_target)) %>%
  mutate(type = print("total"))

# replace names to removed periods
total_num$sender <- ifelse(
  total_num$sender == "Inhibitory.Neurons",
  "Inhibitory Neurons",
  ifelse(total_num$sender == "Excitatory.Neurons",
    "Excitatory Neurons",
    ifelse(total_num$sender == "Endothelial.cells",
      "Endothelial cells", total_num$sender
    )
  )
)

# plot barplot of all interactions
panel_a <-
  ggplot(total_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity") +
  xlab("Sender") +
  ylab("Number of Unique Interactions") +
  theme_bw() +
  geom_text(aes(label = interactions),
    position = "stack",
    vjust = 2,
    fontface = "bold"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12)) +
  theme(legend.text = element_text(face = "bold", size = 12)) +
  theme(axis.text = element_text(face = "bold", size = 12)) +
  theme(
    axis.title = element_text(face = "bold", size = 14),
    legend.title = element_text(face = "bold", size = 14)
  ) +
  scale_fill_manual(
    values = c(
      `Oligodendrocytes` = "royalblue4",
      `Microglia` = "orchid3",
      `OPCs` = "mediumpurple1",
      `Astrocytes` = "cornflowerblue",
      `Excitatory Neurons` = "slateblue3",
      `Inhibitory Neurons` = "darkslategray3",
      `Pericytes` = "deepskyblue3",
      `Endothelial cells` = "darkolivegreen4"
    ),
    name = "Sender"
  )

panel_a
```

# Figure S3B
```{r}
# filter MultiNicheNet output and select columns needed for plotting
oi <- output$lr_target_prior_cor %>%
  inner_join(output$ligand_activities_targets_DEgenes$ligand_activities %>%
    distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl) %>%
  filter(receiver %in% receiver_oi, sender %in% sender_oi)

oi_filt <- oi %>%
  select("id_target", "sender")

# aggregate by sender
oi_num <- oi_filt %>%
  group_by(sender) %>%
  summarize(interactions = n_distinct(id_target)) %>%
  mutate(type = print("oi"))

# plot barplot of interactions with specified sender and receiver cell types
panel_b <-
  ggplot(oi_num, aes(x = sender, y = interactions, fill = sender)) +
  geom_bar(stat = "identity") +
  xlab("Sender") +
  ylab("Number of Unique Interactions") +
  theme_bw() +
  geom_text(aes(label = interactions),
    position = "stack",
    vjust = 2,
    fontface = "bold"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12)) +
  theme(legend.text = element_text(face = "bold", size = 12)) +
  theme(axis.text = element_text(face = "bold", size = 12)) +
  theme(
    axis.title = element_text(face = "bold", size = 14),
    legend.title = element_text(face = "bold", size = 14)
  ) +
  scale_fill_manual(
    values = c(
      `Oligodendrocytes` = "royalblue4",
      `Microglia` = "orchid3",
      `OPCs` = "mediumpurple1",
      `Astrocytes` = "cornflowerblue"
    ),
    name = "Sender"
  )

panel_b
```

# Figure S3C
```{r}
# pull all interactions up-regulated in CTRL (inferred as down/lost in AD)
group_oi <- "CTRL"

prior <- filter_nichenet(output)

prior_filt_ctrl <- prior %>%
  select("id_target", "sender") %>%
  mutate(condition = "CTRL")

# pull all interactions up-regulated in AD
group_oi <- "AD"

prior <- filter_nichenet(output)

prior_filt_ad <- prior %>%
  select("id_target", "sender") %>%
  mutate(condition = "AD")

# combine into 1 dataframe
combined <- rbind(prior_filt_ad, prior_filt_ctrl)

# aggregate numbers by sender and condition
prior_num <- combined %>%
  group_by(sender, condition) %>%
  summarize(interactions = n_distinct(id_target))

# plot stacked barplot, split by condition (AD vs CTRL)
panel_c <-
  ggplot(prior_num, aes(x = sender, y = interactions, fill = condition)) +
  geom_bar(stat = "identity", position = "stack") +
  xlab("Sender") +
  ylab("Number of Interactions") +
  # ggtitle("Number of Unique Genes in Each Condition for Different Contexts") +
  scale_fill_discrete(name = "Condition") +
  theme_bw() +
  geom_text(aes(label = interactions),
    position = "stack",
    vjust = 2,
    fontface = "bold"
  ) +
  scale_fill_manual(values = c(
    `AD` = "#A6CEE3",
    `CTRL` = "#1F78B4"
  )) +
  labs(fill = "Condition") +
  theme(legend.text = element_text(face = "bold")) +
  theme(axis.text = element_text(face = "bold", size = 12)) +
  theme(
    axis.title = element_text(face = "bold", size = 14),
    legend.title = element_text(face = "bold", size = 12),
    text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12)
  )

panel_c
```

# Compile figure
```{r}
supp_fig3 <- plot_grid(
  panel_a,
  panel_b,
  panel_c,
  labels = c("A", "B", "C"),
  ncol = 3
)

supp_fig3
```

# Save figure
```{r}
png(here("results", "figures", "supp_figure3.png"),
  width = 500,
  height = 200,
  units = "mm",
  res = 300
)
supp_fig3
dev.off()
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2     styler_1.9.1    here_1.0.1      cowplot_1.1.1   patchwork_1.1.2
 [6] lubridate_1.9.2 forcats_1.0.0   stringr_1.5.0   dplyr_1.1.3     purrr_1.0.2    
[11] readr_2.1.4     tidyr_1.3.0     tibble_3.2.1    ggplot2_3.4.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.0   xfun_0.40          remotes_2.4.2      colorspace_2.1-0  
 [5] vctrs_0.6.3        generics_0.1.3     utf8_1.2.3         rlang_1.1.1       
 [9] R.oo_1.25.0        pillar_1.9.0       glue_1.6.2         withr_2.5.0       
[13] R.utils_2.12.2     lifecycle_1.0.3    R.cache_0.16.0     munsell_0.5.0     
[17] gtable_0.3.3       R.methodsS3_1.8.2  labeling_0.4.2     knitr_1.44        
[21] tzdb_0.4.0         callr_3.7.3        ps_1.7.5           rex_1.2.1         
[25] fansi_1.0.4        scales_1.2.1       desc_1.4.2         farver_2.1.1      
[29] xmlparsedata_1.0.5 hms_1.1.3          digest_0.6.33      stringi_1.7.12    
[33] processx_3.8.1     grid_4.1.3         rprojroot_2.0.3    cli_3.6.1         
[37] tools_4.1.3        magrittr_2.0.3     lazyeval_0.2.2     crayon_1.5.2      
[41] pkgconfig_2.0.3    xml2_1.3.5         cyclocomp_1.1.0    timechange_0.2.0  
[45] rstudioapi_0.14    R6_2.5.1           compiler_4.1.3

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: < 5 minutes
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "manuscript_figures",
  "figure_S3.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "manuscript_figures",
  "figure_S3.Rmd"
))
```

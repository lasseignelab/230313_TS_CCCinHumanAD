---
title: "figure_4"
author: "Tabea M. Soelter"
date: '2023-10-17'
output: html_document
---
**Plotting Main Figure 4**

__Goal__: This is a script for generating figure 4 of my manuscript.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.5
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 85GB per CPU

__Data__:
*MultiNicheNet outputs*
* Name: geo_multinichenet_output.rds, gse_multinichenet_output.rds
* Location: data/ccc/
 
__Analysis Plan__:
* Load necessary packages 
* Load data
  * MultiNicheNet outputs
* Plot individual panels
  * A: alluvial plots of LRs for each sender colored by receiver
  * B: alluvial plot of high confidence LRTs colored by sender
  * C: heatmap of pseudo-bulk expression of target genes
* Compile figure
* Save figure

# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(ggalluvial)
  library(reshape2)
  library(ComplexHeatmap)
  library(ggpubr)
  library(cowplot)
  library(RColorBrewer)
  library(circlize)
  library(here)
  library(styler)
  library(lintr)
})

source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
geo_multinichenet_output <- readRDS(here(
  "data",
  "ccc",
  "geo_multinichenet_output_final.rds"
))

gse_multinichenet_output <- readRDS(here(
  "data",
  "ccc",
  "gse_multinichenet_output_final.rds"
))

multinichenet_objects <- tibble::lst(
  geo_multinichenet_output,
  gse_multinichenet_output
)
```

# Colors
```{r}
colors <- c(
  `Oligodendrocytes` = "royalblue4",
  `Microglia` = "orchid3",
  `OPCs` = "mediumpurple1",
  `Astrocytes` = "cornflowerblue",
  `Excitatory Neurons` = "slateblue3",
  `Inhibitory Neurons` = "darkslategray3",
  `Pericytes` = "deepskyblue3",
  `Endothelial cells` = "darkolivegreen4"
)
```

# Set filtering parameters
* NOTE: These are the same as in previous analyses.
```{r}
top_n_target <- 250

receiver_oi <- c("Excitatory.Neurons", "Inhibitory.Neurons")

sender_oi <- c("Astrocytes", "Microglia", "OPCs", "Oligodendrocytes")

contrast_tbl <- tibble(
  contrast = c("AD-CTRL", "CTRL-AD"),
  group = c("AD", "CTRL")
)
```

# Filter MultiNicheNet outputs
```{r}
filtered_objects <- filter_multinichenet(
  object_list = multinichenet_objects,
  sender_oi = sender_oi,
  receiver_oi = receiver_oi,
  contrast_tbl = contrast_tbl
)

list2env(filtered_objects, globalenv())

# Rename receiver cell types
geo_lr_target_prior_cor_filtered$receiver <- ifelse(
  geo_lr_target_prior_cor_filtered$receiver == "Inhibitory.Neurons",
  "Inhibitory Neurons",
  "Excitatory Neurons"
)

gse_lr_target_prior_cor_filtered$receiver <- ifelse(
  gse_lr_target_prior_cor_filtered$receiver == "Inhibitory.Neurons",
  "Inhibitory Neurons",
  "Excitatory Neurons"
)
```

# Get overlapping LRs
```{r}
geo_id <- geo_lr_target_prior_cor_filtered$id %>% unique()

gse_id <- gse_lr_target_prior_cor_filtered$id %>% unique()

overlap <- intersect(geo_id, gse_id)

length(overlap) # 55
```

# Combine filtered objects
```{r}
geo_ccc <- geo_lr_target_prior_cor_filtered %>%
  dplyr::select(sender, receiver, ligand, target, receptor, id) %>%
  filter(id %in% overlap) %>%
  mutate(origin = "geo")

gse_ccc <- gse_lr_target_prior_cor_filtered %>%
  dplyr::select(sender, receiver, ligand, target, receptor, id) %>%
  filter(id %in% overlap) %>%
  mutate(origin = "gse")

ccc_combined <- rbind(geo_ccc, gse_ccc) %>%
  select(sender, receiver, ligand, receptor, id) %>%
  unique()
```

# Panel 4A
* Alluvial plots by sender:
OPCs
```{r}
ccc_opc <- ccc_combined %>%
  filter(sender == "OPCs")

# factorize and reorder columns for plotting purposes
ccc_opc$ligand <- factor(ccc_opc$ligand,
  levels = as.character(unique(ccc_opc$ligand))
)
ccc_opc$receptor <- factor(ccc_opc$receptor,
  levels = as.character(unique(ccc_opc$receptor))
)

ccc_opc$ligand <- reorder(ccc_opc$ligand, desc(ccc_opc$receiver))
ccc_opc$receptor <- reorder(ccc_opc$receptor, desc(ccc_opc$receiver))

opc <- ggplot(ccc_opc, aes(axis1 = ligand, axis2 = receptor), label = stratum) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  xlab("Type") +
  geom_alluvium() +
  stat_alluvium(lode.guidance = "frontback") +
  geom_stratum(aes(fill = receiver)) +
  geom_label(
    stat = "stratum",
    fill = "white",
    aes(label = after_stat(stratum)),
    size = 2,
    fontface = "bold"
  ) +
  geom_flow(aes(fill = receiver), stat = "alluvium", color = "black") +
  scale_fill_manual(values = colors) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  theme_void() +
  theme(
    axis.text.x = element_text(vjust = 2, face = "bold", size = 12),
    legend.position = c(0.9, 0.5),
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14)
  ) +
  guides(fill = guide_legend(title = "Receiver")) +
  ggtitle("OPCs")

opc
```

Astrocytes
```{r}
ccc_astro <- ccc_combined %>%
  filter(sender == "Astrocytes")

# factor and reorder columns
ccc_astro$ligand <- factor(ccc_astro$ligand,
  levels = as.character(unique(ccc_astro$ligand))
)
ccc_astro$receptor <- factor(ccc_astro$receptor,
  levels = as.character(unique(ccc_astro$receptor))
)

ccc_astro$ligand <- reorder(ccc_astro$ligand, desc(ccc_astro$receiver))
ccc_astro$receptor <- reorder(ccc_astro$receptor, desc(ccc_astro$receiver))

# plot alluvial
astro <- ggplot(ccc_astro,
  aes(axis1 = ligand, axis2 = receptor),
  label = stratum
) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  xlab("Type") +
  geom_alluvium() +
  stat_alluvium(lode.guidance = "frontback") +
  geom_stratum(aes(fill = receiver)) +
  geom_label(
    stat = "stratum",
    fill = "white",
    aes(
      label = after_stat(stratum),
      fontface = "bold"
    )
  ) +
  geom_flow(aes(fill = receiver), stat = "alluvium", color = "black") +
  scale_fill_manual(values = colors) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  theme_void() +
  theme(
    axis.text.x = element_text(vjust = 2, face = "bold", size = 12),
    legend.position = c(0.9, 0.5),
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14)
  ) +
  guides(fill = guide_legend(title = "Receiver")) +
  ggtitle("Astrocytes")

astro
```

Microglia
```{r}
ccc_micro <- ccc_combined %>%
  filter(sender == "Microglia")

# factorize and reorder columns for plotting
ccc_micro$ligand <- factor(ccc_micro$ligand,
  levels = as.character(unique(ccc_micro$ligand))
)
ccc_micro$receptor <- factor(ccc_micro$receptor,
  levels = as.character(unique(ccc_micro$receptor))
)

ccc_micro$ligand <- reorder(ccc_micro$ligand, desc(ccc_micro$receiver))
ccc_micro$receptor <- reorder(ccc_micro$receptor, desc(ccc_micro$receiver))

# generate alluvial plot
micro <- ggplot(ccc_micro,
  aes(axis1 = ligand, axis2 = receptor),
  label = stratum
) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  xlab("Type") +
  geom_alluvium() +
  stat_alluvium(lode.guidance = "frontback") +
  geom_stratum(aes(fill = receiver)) +
  geom_label(
    stat = "stratum",
    fill = "white",
    fontface = "bold",
    aes(label = after_stat(stratum))
  ) +
  geom_flow(aes(fill = receiver), stat = "alluvium", color = "black") +
  scale_fill_manual(values = colors) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  theme_void() +
  theme(
    axis.text.x = element_text(vjust = 2, face = "bold", size = 12),
    legend.position = c(0.9, 0.5),
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14)
  ) +
  guides(fill = guide_legend(title = "Receiver")) +
  ggtitle("Microglia")

micro
```

Oligodendrocytes
```{r}
ccc_oligo <- ccc_combined %>%
  filter(sender == "Oligodendrocytes")

# factorize and reorder columns for plotting
ccc_oligo$ligand <- factor(ccc_oligo$ligand,
  levels = as.character(unique(ccc_oligo$ligand))
)
ccc_oligo$receptor <- factor(ccc_oligo$receptor,
  levels = as.character(unique(ccc_oligo$receptor))
)

ccc_oligo$ligand <- reorder(ccc_oligo$ligand, desc(ccc_oligo$receiver))
ccc_oligo$receptor <- reorder(ccc_oligo$receptor, desc(ccc_oligo$receiver))

# plot alluvial plot
oligo <- ggplot(ccc_oligo,
  aes(axis1 = ligand, axis2 = receptor),
  label = stratum
) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  xlab("Type") +
  geom_alluvium() +
  stat_alluvium(lode.guidance = "frontback") +
  geom_stratum(aes(fill = receiver)) +
  geom_label(
    stat = "stratum",
    fill = "white",
    fontface = "bold",
    aes(label = after_stat(stratum))
  ) +
  geom_flow(aes(fill = receiver), stat = "alluvium", color = "black") +
  scale_fill_manual(values = colors) +
  scale_x_discrete(limits = c("Ligand", "Receptor")) +
  theme_void() +
  theme(
    axis.text.x = element_text(vjust = 2, face = "bold", size = 12),
    legend.position = c(0.9, 0.5),
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14)
  ) +
  guides(fill = guide_legend(title = "Receiver")) +
  ggtitle("Oligodendrocytes")

oligo
```

# Panel 4B
```{r}
# Determine LRT overlap
geo_id_target <- geo_lr_target_prior_cor_filtered$id_target %>% unique()

gse_id_target <- gse_lr_target_prior_cor_filtered$id_target %>% unique()

overlap2 <- intersect(geo_id_target, gse_id_target)

# Filter both datasets by LRT overlap and combine into one df
geo_ccc <- geo_lr_target_prior_cor_filtered %>%
  dplyr::select(sender, receiver, ligand, target, receptor, id_target) %>%
  filter(id_target %in% overlap2) %>%
  mutate(origin = "geo")

gse_ccc <- gse_lr_target_prior_cor_filtered %>%
  dplyr::select(sender, receiver, ligand, target, receptor, id_target) %>%
  filter(id_target %in% overlap2) %>%
  mutate(origin = "gse")

ccc_combined <- rbind(geo_ccc, gse_ccc) %>%
  select(sender, receiver, ligand, receptor, target) %>%
  unique()

# Factorize columns of interest
ccc_combined$ligand <- factor(
  ccc_combined$ligand,
  levels = as.character(unique(ccc_combined$ligand))
)
ccc_combined$receptor <- factor(
  ccc_combined$receptor,
  levels = as.character(unique(ccc_combined$receptor))
)
ccc_combined$target <- factor(
  ccc_combined$target,
  levels = as.character(unique(ccc_combined$target))
)

# Reorder columns of interest by the sender to aid with legibility
ccc_combined$ligand <- reorder(
  ccc_combined$ligand,
  desc(ccc_combined$sender)
)
ccc_combined$receptor <- reorder(
  ccc_combined$receptor,
  desc(ccc_combined$sender)
)
ccc_combined$target <- reorder(
  ccc_combined$target,
  desc(ccc_combined$sender)
)

# Plot LRT alluvial
lrt <- ggplot(ccc_combined,
  aes(axis1 = ligand, axis2 = receptor, axis3 = target),
  label = stratum
) +
  xlab("Type") +
  geom_alluvium() +
  stat_alluvium(lode.guidance = "frontback") +
  geom_stratum(aes(fill = sender)) +
  geom_label(
    stat = "stratum",
    fill = "white",
    aes(label = after_stat(stratum)),
    fontface = "bold"
  ) +
  geom_flow(aes(fill = sender), stat = "alluvium", color = "black") +
  scale_fill_manual(values = colors) +
  scale_x_discrete(limits = c("Ligand", "Receptor", "Target")) +
  theme_void() +
  theme(
    axis.text.x = element_text(vjust = 2, face = "bold", size = 12),
    legend.position = "bottom",
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 14)
  ) +
  guides(fill = guide_legend(title = "Sender"))

lrt
```

# Panel 4C
* Plot only targets that had overlapping l-r pairs
```{r}
# Get differentially expressed genes from MultiNicheNet
de_genes_geo <-
  geo_multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df
de_genes_gse <-
  gse_multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df

# Filter by receiver cell type and contrast of interest
de_genes_filt_geo <- de_genes_geo %>%
  filter(receiver %in% receiver_oi, contrast == "AD-CTRL")

de_genes_filt_gse <- de_genes_gse %>%
  filter(receiver %in% receiver_oi, contrast == "AD-CTRL")

# Create vector of target genes
targets <- c("LMO1", "CCND1", "PRLR")

# Filter DEGs by targets
de_genes_filt_geo <- de_genes_filt_geo %>%
  filter(gene %in% targets) %>%
  select(gene, receiver, logFC) %>%
  unique() %>%
  mutate(dataset = "geo")

de_genes_filt_gse <- de_genes_filt_gse %>%
  filter(gene %in% targets) %>%
  select(gene, receiver, logFC) %>%
  unique() %>%
  mutate(dataset = "gse")

# Combine DEG information into 1 df
de_genes_filt <- rbind(de_genes_filt_geo, de_genes_filt_gse)

# Arrange dataframe for plotting
heatmap_matrix <- dcast(de_genes_filt,
  gene ~ receiver + dataset,
  value.var = "logFC"
) %>%
  column_to_rownames("gene")

# Replace any NAs with 0
heatmap_matrix[is.na(heatmap_matrix)] <- 0

# Prepare annotation
meta <- as.data.frame(colnames(heatmap_matrix))
rownames(meta) <- meta$`colnames(heatmap_matrix)`

receiver <- c(
  "Excitatory.Neurons",
  "Excitatory.Neurons",
  "Inhibitory.Neurons",
  "Inhibitory.Neurons"
)

dataset <- c("geo", "gse", "geo", "gse")

met <- cbind(dataset, receiver)
rownames(met) <- rownames(meta)
met <- as.data.frame(met)

# Set annotation colors
anno_cols <- list(
  "receiver" = c(
    "Excitatory.Neurons" = "slateblue3",
    "Inhibitory.Neurons" = "darkslategray3"
  ),
  "dataset" = c(
    "geo" = "grey75",
    "gse" = "grey36"
  )
)

# Make annotation
anno <- HeatmapAnnotation(
  df = met,
  show_annotation_name = FALSE,
  col = anno_cols,
  annotation_legend_param = list(
    dataset = list(
      title = "Dataset",
      direction = "horizontal",
      title_gp = gpar(fontface = "bold", fontsize = 12),
      labels = c("Morabito", "Lau"),
      labels_gp = gpar(
        fontface = "bold",
        fontsize = 12
      )
    ),
    receiver = list(
      title = "Cell Type",
      title_gp = gpar(fontface = "bold", fontsize = 12),
      labels = c("Excitatory Neurons", "Inhibitory Neurons"),
      direction = "horizontal",
      labels_gp = gpar(fontface = "bold", fontsize = 12)
    )
  )
)

# Convert df to matrix for plotting
mat <- as.matrix(heatmap_matrix)

# Set heatmap colors
cols <- colorRamp2(c(-1, 0, 1), rev(brewer.pal(n = 3, name = "RdBu")))

# Plot heatmap
h2 <- Heatmap(mat,
  col = cols,
  top_annotation = anno,
  show_column_names = FALSE,
  show_row_dend = TRUE,
  show_column_dend = FALSE,
  cluster_columns = FALSE,
  row_title = "Overlapping Target Genes",
  row_title_gp = gpar(fontface = "bold"),
  row_names_gp = gpar(fontface = "bold"),
  heatmap_legend_param = list(
    direction = "horizontal",
    title = "Pseudo-bulk Expression",
    title_gp = gpar(fontface = "bold", fontsize = 12),
    labels_gp = gpar(fontface = "bold")
  )
)

h2
```

# Compile figure
```{r}
# Convert heatmap for plotting
h3 <- grid.grabExpr(
  draw(
    h2,
    heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom",
    merge_legend = TRUE
  )
)

# Arrange panel A
top <- ggarrange(astro,
  micro,
  oligo,
  opc,
  common.legend = TRUE,
  legend = "bottom"
)

# Arrange panels B and C
bottom <- plot_grid(lrt,
  h3,
  ncol = 2,
  labels = c("B", "C"),
  rel_widths = c(2, 1)
)

# Combine into 1 figure
fig4 <- plot_grid(top,
  bottom,
  nrow = 2,
  rel_heights = c(2, 1),
  labels = "A"
)

fig4
```

# Save figure
```{r}
png(
  here(
    "results",
    "figures",
    "figure4_final.png"
  ),
  width = 375,
  height = 450,
  units = "mm",
  res = 300
)
fig4
dev.off()
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2           styler_1.9.1          here_1.0.1            circlize_0.4.15       RColorBrewer_1.1-3   
 [6] cowplot_1.1.1         ggpubr_0.6.0          ComplexHeatmap_2.10.0 reshape2_1.4.4        ggalluvial_0.12.5    
[11] lubridate_1.9.2       forcats_1.0.0         stringr_1.5.0         dplyr_1.1.3           purrr_1.0.2          
[16] readr_2.1.4           tidyr_1.3.0           tibble_3.2.1          ggplot2_3.4.2         tidyverse_2.0.0      

loaded via a namespace (and not attached):
 [1] matrixStats_1.0.0   doParallel_1.0.17   rprojroot_2.0.3     R.cache_0.16.0      tools_4.1.3        
 [6] backports_1.4.1     utf8_1.2.3          R6_2.5.1            BiocGenerics_0.40.0 lazyeval_0.2.2     
[11] colorspace_2.1-0    GetoptLong_1.0.5    withr_2.5.0         gridExtra_2.3       tidyselect_1.2.0   
[16] processx_3.8.1      compiler_4.1.3      cli_3.6.1           xml2_1.3.5          desc_1.4.2         
[21] labeling_0.4.2      scales_1.2.1        callr_3.7.3         digest_0.6.33       rmarkdown_2.25     
[26] R.utils_2.12.2      pkgconfig_2.0.3     htmltools_0.5.6     fastmap_1.1.1       rlang_1.1.1        
[31] GlobalOptions_0.1.2 rstudioapi_0.14     shape_1.4.6         generics_0.1.3      farver_2.1.1       
[36] car_3.1-2           R.oo_1.25.0         magrittr_2.0.3      waldo_0.5.1         Rcpp_1.0.11        
[41] munsell_0.5.0       S4Vectors_0.32.4    fansi_1.0.4         abind_1.4-5         lifecycle_1.0.3    
[46] R.methodsS3_1.8.2   stringi_1.7.12      yaml_2.3.7          carData_3.0-5       plyr_1.8.8         
[51] parallel_4.1.3      crayon_1.5.2        hms_1.1.3           knitr_1.44          ps_1.7.5           
[56] pillar_1.9.0        rjson_0.2.21        ggsignif_0.6.4      codetools_0.2-18    stats4_4.1.3       
[61] glue_1.6.2          evaluate_0.21       rex_1.2.1           remotes_2.4.2       png_0.1-8          
[66] vctrs_0.6.3         tzdb_0.4.0          foreach_1.5.2       gtable_0.3.3        clue_0.3-64        
[71] xfun_0.40           broom_1.0.5         cyclocomp_1.1.0     rstatix_0.7.2       iterators_1.0.14   
[76] IRanges_2.28.0      cluster_2.1.2       timechange_0.2.0

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: 5 minutes
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "manuscript_figures",
  "figure_4.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "manuscript_figures",
  "figure_4.Rmd"
))
```

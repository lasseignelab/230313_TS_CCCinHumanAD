---
title: "figure_5"
author: "Tabea M. Soelter"
date: '2023-09-29'
output: html_document
---
**Plotting Main Figure 5**

__Goal__: This is a script for generating figure 5 of my manuscript.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.5
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 85GB per CPU

__Data__:
*DESeq2 outputs*
* Name: Inhibitory Neurons_group_id_AD_vs_CTRL_all_genes.csv
* Location: results/intermediate_outputs/geo/pseudobulk/, results/intermediate_outputs/gse/pseudobulk/
*TF activity output*
* Name: differential_tf_activity_filt.rds
* Location: results/final_outputs/comparison/
*Pathway activity output*
* Name: differential_pathway_activity_filt.rds
* Location: results/final_outputs/comparison/
 
__Analysis Plan__:
* Load necessary packages 
* Load data
  * DESeq2 outputs
  * Biological activity outputs
* Plot individual panels
  * A: heatmap of gex of signaling mediators in inhibitory neurons
  * B: heatmap of TF activity of signaling mediators that are also TFs in inhibitory neurons
  * C: heatmap of pathway activitiy in inhibitory neurons
* Compile figure
* Save figure

# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(ComplexHeatmap)
  library(reshape2)
  library(circlize)
  library(tidyverse)
  library(ggplot2)
  library(RColorBrewer)
  library(cowplot)
  library(ggpubr)
  library(here)
  library(styler)
  library(lintr)
})

source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
# DESeq2 outputs
deseq2_geo <- read_csv(here(
  "results",
  "intermediate_outputs",
  "geo",
  "pseudobulk",
  "Inhibitory Neurons_group_id_AD_vs_CTRL_all_genes_final.csv"
))

deseq2_gse <- read_csv(here(
  "results",
  "intermediate_outputs",
  "gse",
  "pseudobulk",
  "Inhibitory Neurons_group_id_AD_vs_CTRL_all_genes_final.csv"
))

# List of signaling mediators in inhibitory neurons
in_mediators <- c(
  "GSK3B", "IRAK1", "CD44", "ESR1", "JUN", "MYC", "SRC",
  "STAT3", "TLR2", "TP53", "AKT1", "CTNNB1", "ERBB2", "DAPK1", "RAC1", "LRP1",
  "MAPK8", "APP", "LCK", "PTK2", "STAT1", "STAT2", "PTEN", "CCNB1",
  "CCND1", "IFIT3", "NFIL3", "ERBB3", "CEBPD", "FST", "GFRA1", "ANGPTL4"
)

# TF activity output
tf_acts_filt <- readRDS(here(
  "results",
  "final_outputs",
  "comparison",
  "differential_tf_activity_filt_final.rds"
))

# Pathway activity output
acts <- readRDS(here(
  "results",
  "final_outputs",
  "comparison",
  "differential_pathway_activity_final.rds"
))
```

# Panel 5A
```{r}
# Add dataset identify
deseq2_geo$dataset <- "geo"
deseq2_gse$dataset <- "gse"

# Filter genes by mediators
geo_df <- deseq2_geo %>%
  filter(gene %in% in_mediators)

gse_df <- deseq2_gse %>%
  filter(gene %in% in_mediators)

combined_df <- rbind(geo_df, gse_df) %>%
  select(gene, log2FoldChange, pvalue, dataset) %>%
  pivot_wider(
    id_cols = gene,
    names_from = dataset,
    values_from = c(log2FoldChange, pvalue)
  ) %>%
  mutate(gene_sig = case_when(
    pvalue_geo < 0.05 & pvalue_gse < 0.05 ~ paste0(gene, "**"),
    pvalue_geo < 0.05 ~ paste0(gene, "*"),
    pvalue_gse < 0.05 ~ paste0(gene, "^"),
    TRUE ~ gene
  )) %>%
  select(-c(pvalue_geo, pvalue_gse, gene)) %>%
  column_to_rownames(var = "gene_sig")

# Prepare heatmap annotation
meta <- as.data.frame(colnames(combined_df))
rownames(meta) <- meta$`colnames(combined_df)`
meta <- meta[1:2, ]

dataset <- c("geo", "gse")
meta <- dataset %>% as.data.frame()
rownames(meta) <- c("geo", "gse")
colnames(meta) <- "dataset"

anno_cols <- list(
  "dataset" = c(
    "geo" = "grey75",
    "gse" = "grey36"
  )
)

# Generate annotation
anno <- HeatmapAnnotation(
  df = meta,
  show_annotation_name = FALSE,
  col = anno_cols,
  annotation_legend_param = list(
    dataset = list(
      title = "Dataset",
      direction = "horizontal",
      labels = c("Morabito", "Lau"),
      labels_gp = gpar(fontface = "bold")
    )
  )
)

# Convert df to matrix
mat <- as.matrix(combined_df)

# Set heatmap colors
cols <- colorRamp2(c(-0.5, 0, 0.5), rev(brewer.pal(n = 3, name = "RdBu")))

# TFs that are mediators
tfs <- c(
  "NFIL3", "ESR1", "STAT3", "STAT1", "TP53",
  "JUN", "STAT2", "CTNNB1", "MYC", "CEBPD"
)

# Grey out mediators that are not TFs
row_colors <- ifelse(rownames(mat) %in% tfs, "black", "grey45")

# Plot heatmap
gex_heatmap <- Heatmap(mat,
  col = cols,
  top_annotation = anno,
  show_column_names = FALSE,
  show_row_dend = TRUE,
  show_column_dend = FALSE,
  cluster_columns = TRUE,
  cluster_rows = TRUE,
  row_title = "Signaling Mediators",
  row_title_gp = gpar(fontface = "bold", fontsize = 12),
  row_names_gp = gpar(col = row_colors, fontface = "bold"),
  heatmap_legend_param = list(
    direction = "horizontal",
    title = "Differential Expression",
    labels_gp = gpar(fontface = "bold")
  )
)

draw(gex_heatmap,
  heatmap_legend_side = "bottom",
  annotation_legend_side = "bottom",
  merge_legend = TRUE
)

panel_a <- grid.grabExpr(
  draw(gex_heatmap,
    heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom",
    merge_legend = TRUE
  )
)
```

# Panel 5B
```{r}
# Prepare matrix for plotting
mat <- tf_acts_filt %>%
  select(source, condition, score) %>%
  pivot_wider(
    names_from = "source",
    values_from = "score"
  ) %>%
  column_to_rownames(var = "condition") %>%
  as.matrix()

# Prepare top annotation
dataset <- c("geo", "gse")
meta <- dataset %>% as.data.frame()
rownames(meta) <- c("geo", "gse")
colnames(meta) <- "dataset"

# Set annotation colors
anno_cols <- list("dataset" = c(
  "geo" = "grey75",
  "gse" = "grey36"
))

# Make heatmap annotation
anno <- HeatmapAnnotation(
  df = meta,
  show_annotation_name = FALSE,
  col = anno_cols,
  annotation_legend_param = list(
    dataset = list(
      title = "Dataset",
      direction = "horizontal",
      labels = c("Morabito", "Lau"),
      labels_gp = gpar(fontface = "bold")
    )
  )
)

# Set heatmap colors
cols <- colorRamp2(c(-4, 0, 4), brewer.pal(n = 3, name = "PRGn"))

# Plot heatmap
tf_activity_heatmap <- Heatmap(t(mat),
  col = cols,
  top_annotation = anno,
  show_column_names = FALSE,
  show_row_dend = TRUE,
  show_column_dend = FALSE,
  cluster_columns = TRUE,
  cluster_rows = TRUE,
  row_title = "Transcription Factors",
  row_title_gp = gpar(
    fontface = "bold",
    fontsize = 12
  ),
  row_names_gp = gpar(fontface = "bold"),
  heatmap_legend_param = list(
    direction = "horizontal",
    title = "TF Activity",
    labels_gp = gpar(fontface = "bold")
  )
)

draw(tf_activity_heatmap,
  heatmap_legend_side = "bottom",
  annotation_legend_side = "bottom",
  merge_legend = TRUE
)

panel_b <- grid.grabExpr(
  draw(tf_activity_heatmap,
    heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom",
    merge_legend = TRUE
  )
)
```

# Panel 5C
```{r}
# Prepare matrix for plotting
mat <- acts %>%
  select(source, score, condition) %>%
  pivot_wider(
    names_from = source,
    values_from = score
  ) %>%
  column_to_rownames(var = "condition") %>%
  as.matrix()

# Prepare top annotation
dataset <- c("geo", "gse")
meta <- dataset %>% as.data.frame()
rownames(meta) <- c("geo", "gse")
colnames(meta) <- "dataset"

# Set annotation colors
anno_cols <- list("dataset" = c(
  "geo" = "grey75",
  "gse" = "grey36"
))

# Make heatmap annotation
anno <- HeatmapAnnotation(
  df = meta,
  show_annotation_name = FALSE,
  col = anno_cols,
  annotation_legend_param = list(
    dataset = list(
      title = "Dataset",
      direction = "horizontal",
      labels = c("Morabito", "Lau"),
      labels_gp = gpar(fontface = "bold")
    )
  )
)

# Set heatmap colors and breaks
cols <- colorRamp2(c(-4, 0, 4), rev(brewer.pal(n = 3, name = "BrBG")))

# Plor
pathway_activity_heatmap <- Heatmap(t(mat),
  col = cols,
  top_annotation = anno,
  show_column_names = FALSE,
  show_row_dend = TRUE,
  show_column_dend = FALSE,
  cluster_columns = TRUE,
  cluster_rows = TRUE,
  row_title = "Pathways",
  row_title_gp = gpar(
    fontface = "bold",
    fontsize = 12
  ),
  row_names_gp = gpar(fontface = "bold"),
  heatmap_legend_param = list(
    direction = "horizontal",
    title = "Pathway Activity",
    labels_gp = gpar(fontface = "bold")
  )
)

draw(pathway_activity_heatmap,
  heatmap_legend_side = "bottom",
  annotation_legend_side = "bottom",
  merge_legend = TRUE
)

panel_c <- grid.grabExpr(
  draw(
    pathway_activity_heatmap,
    heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom",
    merge_legend = TRUE
  )
)
```

# Compile figure
```{r}
fig5 <- plot_grid(panel_a,
  panel_b,
  panel_c,
  ncol = 3,
  labels = c("A", "B", "C")
)

fig5
```

# Save figure
```{r}
png(
  here(
    "results",
    "figures",
    "figure5_final.png"
  ),
  width = 300,
  height = 200,
  units = "mm",
  res = 300
)
fig5
dev.off()
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] RColorBrewer_1.1-3    circlize_0.4.15       lintr_3.0.2           styler_1.9.1          cowplot_1.1.1        
 [6] ggpubr_0.6.0          ComplexHeatmap_2.10.0 reshape2_1.4.4        ggalluvial_0.12.5     lubridate_1.9.2      
[11] forcats_1.0.0         stringr_1.5.0         dplyr_1.1.3           purrr_1.0.2           readr_2.1.4          
[16] tidyr_1.3.0           tibble_3.2.1          ggplot2_3.4.2         tidyverse_2.0.0       here_1.0.1           

loaded via a namespace (and not attached):
 [1] matrixStats_1.0.0   bit64_4.0.5         doParallel_1.0.17   rprojroot_2.0.3     R.cache_0.16.0     
 [6] tools_4.1.3         backports_1.4.1     utf8_1.2.3          R6_2.5.1            lazyeval_0.2.2     
[11] BiocGenerics_0.40.0 colorspace_2.1-0    GetoptLong_1.0.5    withr_2.5.0         tidyselect_1.2.0   
[16] gridExtra_2.3       processx_3.8.1      bit_4.0.5           compiler_4.1.3      cli_3.6.1          
[21] xml2_1.3.5          desc_1.4.2          labeling_0.4.2      scales_1.2.1        callr_3.7.3        
[26] digest_0.6.33       rmarkdown_2.25      R.utils_2.12.2      pkgconfig_2.0.3     htmltools_0.5.6    
[31] fastmap_1.1.1       rlang_1.1.1         GlobalOptions_0.1.2 rstudioapi_0.14     shape_1.4.6        
[36] farver_2.1.1        generics_0.1.3      vroom_1.6.3         car_3.1-2           R.oo_1.25.0        
[41] magrittr_2.0.3      Rcpp_1.0.11         munsell_0.5.0       S4Vectors_0.32.4    fansi_1.0.4        
[46] abind_1.4-5         lifecycle_1.0.3     R.methodsS3_1.8.2   stringi_1.7.12      yaml_2.3.7         
[51] carData_3.0-5       plyr_1.8.8          parallel_4.1.3      crayon_1.5.2        hms_1.1.3          
[56] knitr_1.44          ps_1.7.5            pillar_1.9.0        rjson_0.2.21        ggsignif_0.6.4     
[61] codetools_0.2-18    stats4_4.1.3        glue_1.6.2          evaluate_0.21       rex_1.2.1          
[66] remotes_2.4.2       png_0.1-8           vctrs_0.6.3         tzdb_0.4.0          foreach_1.5.2      
[71] gtable_0.3.3        clue_0.3-64         xfun_0.40           broom_1.0.5         cyclocomp_1.1.0    
[76] rstatix_0.7.2       iterators_1.0.14    IRanges_2.28.0      cluster_2.1.2       timechange_0.2.0   
[81] xmlparsedata_1.0.5 

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: < 5 minutes
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "manuscript_figures",
  "figure_5.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "manuscript_figures",
  "figure_5.Rmd"
))
```

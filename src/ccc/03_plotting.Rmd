---
title: "03_nichenet_prioritization_plots"
author: "Tabea M. Soelter"
date: '2023-04-28'
output: html_document
---
**Plotting Differential Cell-Cell Communication Results**

__Goal__: Prioritize ligands, receptors, and target genes, then plot them for each dataset.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.1 
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU

__Data__: 
*NicheNet outputs*
* Name: nichenet_output.rds
* Location: results/intermediate_outputs/geo/ccc/, results/intermediate_outputs/vine/ccc/, results/intermediate_outputs/vine_cortex/ccc/
 
__Analysis Plan__: 
* Load necessary packages 
* Load data
  * NicheNet outputs
* Prioritize outputs
  * Using prioritization weights
* Generate plots
* Save plots

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(nichenetr)
  library(Seurat)
  library(here)
  library(styler)
  library(lintr)
})

# load functions
source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
* Loading NicheNet outputs for all datasets
```{r}
vine_cortex_output <- readRDS(here("results",
                                   "intermediate_outputs",
                                   "vine_cortex",
                                   "ccc",
                                   "nichenet_output.rds"
                                   )
                              )

vine_output <- readRDS(here("results",
                            "intermediate_outputs",
                            "vine",
                            "ccc",
                            "nichenet_output.rds"
                            )
                       )

geo_output <- readRDS(here("results",
                           "intermediate_outputs",
                           "geo",
                           "ccc",
                           "nichenet_output.rds"
                           )
                      )

# create a list of output objects
output_list <- tibble::lst(vine_output, geo_output, vine_cortex_output)
```

# Load NicheNet prior
```{r}
# load the ligand target matrix
ligand_target_matrix <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "ligand_target_matrix.rds"
))

# load and filter the ligand receptor network as recommended by developers
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "lr_network.rds"
)) %>%
  mutate(bonafide = !database %in% c("ppi_prediction", "ppi_prediction_go")) %>%
  dplyr::rename(ligand = from, receptor = to) %>%
  distinct(ligand, receptor, bonafide)

# set organism
organism <- "human"
```

# L-R prioritization
* Adapting these values can change what is favored. 
* These cut-offs will favor differentially expressed l-r pairs compared to activity.
* In-depth explanations of each factor can be found in the vignette for differential NicheNet. 
```{r}
prioritizing_weights = c("scaled_ligand_score" = 5,
                         "scaled_ligand_expression_scaled" = 1,
                         "ligand_fraction" = 1,
                         "scaled_ligand_score_spatial" = 0, 
                         "scaled_receptor_score" = 0.5,
                         "scaled_receptor_expression_scaled" = 0.5,
                         "receptor_fraction" = 1, 
                         "ligand_scaled_receptor_expression_fraction" = 1,
                         "scaled_receptor_score_spatial" = 0,
                         "scaled_activity" = 0,
                         "scaled_activity_normalized" = 1,
                         "bona_fide" = 1)

# Prioritize interactions based on weights and save outputs to respective dirs
prioritization_tables_ls <- prioritize_interactions(output_list,
                                                    file_path = here(
                                                      "results",
                                                      "intermediate_outputs/"
                                                      )
                                                    )
```

# Visualization
* Plotting the standard NicheNet plot which includes ligand expression and activity (scaled and normalized), as well as regulatory potential of predicted target genes
* After plotting, outputs will be saved to results/intermediate_outputs/{dataset}/ccc/

__vine__
```{r}
vine_plots <- make_nichenet_plot(vine_prioritization_tables,
                                 receiver_oi = "Excitatory Neurons_AD",
                                 lfc_cutoff = 0.15)

# save plots to vine intermediate_outputs results directory
pdf(here("results",
         "intermediate_outputs",
         "vine",
         "ccc",
         "nichenet_plots.pdf"
         )
    )

vine_plots$exprs_activity_target_plot$combined_plot
vine_plots$exprs_activity_target_plot$legends
vine_plots$lfc_plot

dev.off()
```

__geo__
```{r}
geo_plots <- make_nichenet_plot(geo_prioritization_tables,
                                receiver_oi = "Excitatory Neurons_AD",
                                lfc_cutoff = 0.15)

# save plots to geo results directory
pdf(here("results",
         "intermediate_outputs",
         "geo",
         "ccc",
         "nichenet_plots.pdf"
         )
    )

geo_plots$exprs_activity_target_plot$combined_plot
geo_plots$exprs_activity_target_plot$legends
geo_plots$lfc_plot

dev.off()
```

__vine_cortex__
```{r}
vine_cortex_plots <- make_nichenet_plot(vine_cortex_prioritization_tables,
                                        receiver_oi = "Excitatory Neurons_AD",
                                        lfc_cutoff = 0.15)

# save plots to vine_cortex intermediate results directory
pdf(here("results",
         "intermediate_outputs",
         "vine_cortex",
         "ccc",
         "nichenet_plots.pdf"
         )
    )

vine_cortex_plots$exprs_activity_target_plot$combined_plot
vine_cortex_plots$exprs_activity_target_plot$legends
vine_cortex_plots$lfc_plot

dev.off()
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2        styler_1.9.1       here_1.0.1         SeuratObject_4.1.3
 [5] Seurat_4.3.0.9002  nichenetr_1.1.1    lubridate_1.9.2    forcats_1.0.0     
 [9] stringr_1.5.0      dplyr_1.1.2        purrr_1.0.1        readr_2.1.4       
[13] tidyr_1.3.0        tibble_3.2.1       ggplot2_3.4.2      tidyverse_2.0.0   

loaded via a namespace (and not attached):
  [1] utf8_1.2.3             R.utils_2.12.2         spatstat.explore_3.1-0
  [4] reticulate_1.28        tidyselect_1.2.0       htmlwidgets_1.6.2     
  [7] grid_4.1.3             Rtsne_0.16             pROC_1.18.0           
 [10] munsell_0.5.0          codetools_0.2-18       ica_1.0-3             
 [13] future_1.32.0          miniUI_0.1.1.1         withr_2.5.0           
 [16] spatstat.random_3.1-4  colorspace_2.1-0       progressr_0.13.0      
 [19] knitr_1.42             rstudioapi_0.14        stats4_4.1.3          
 [22] ROCR_1.0-11            ggsignif_0.6.4         tensor_1.5            
 [25] listenv_0.9.0          labeling_0.4.2         polyclip_1.10-4       
 [28] farver_2.1.1           rprojroot_2.0.3        parallelly_1.35.0     
 [31] vctrs_0.6.2            generics_0.1.3         ipred_0.9-14          
 [34] xfun_0.39              timechange_0.2.0       randomForest_4.7-1.1  
 [37] R6_2.5.1               doParallel_1.0.17      clue_0.3-64           
 [40] rex_1.2.1              bitops_1.0-7           spatstat.utils_3.0-2  
 [43] promises_1.2.0.1       scales_1.2.1           nnet_7.3-17           
 [46] gtable_0.3.3           globals_0.16.2         processx_3.8.1        
 [49] goftest_1.2-3          timeDate_4022.108      rlang_1.1.0           
 [52] cyclocomp_1.1.0        GlobalOptions_0.1.2    splines_4.1.3         
 [55] rstatix_0.7.2          lazyeval_0.2.2         ModelMetrics_1.2.2.2  
 [58] broom_1.0.4            spatstat.geom_3.1-0    checkmate_2.1.0       
 [61] yaml_2.3.7             reshape2_1.4.4         abind_1.4-5           
 [64] backports_1.4.1        httpuv_1.6.9           Hmisc_5.0-1           
 [67] caret_6.0-94           DiagrammeR_1.0.9       tools_4.1.3           
 [70] lava_1.7.2.1           ellipsis_0.3.2         RColorBrewer_1.1-3    
 [73] proxy_0.4-27           BiocGenerics_0.40.0    ggridges_0.5.4        
 [76] Rcpp_1.0.10            plyr_1.8.8             base64enc_0.1-3       
 [79] visNetwork_2.1.2       ps_1.7.5               ggpubr_0.6.0          
 [82] rpart_4.1.16           deldir_1.0-6           pbapply_1.7-0         
 [85] GetoptLong_1.0.5       cowplot_1.1.1          S4Vectors_0.32.4      
 [88] zoo_1.8-12             ggrepel_0.9.3          cluster_2.1.2         
 [91] magrittr_2.0.3         data.table_1.14.8      scattermore_0.8       
 [94] circlize_0.4.15        lmtest_0.9-40          RANN_2.6.1            
 [97] fitdistrplus_1.1-11    R.cache_0.16.0         matrixStats_0.63.0    
[100] hms_1.1.3              patchwork_1.1.2        mime_0.12             
[103] evaluate_0.20          xtable_1.8-4           IRanges_2.28.0        
[106] gridExtra_2.3          shape_1.4.6            compiler_4.1.3        
[109] KernSmooth_2.23-20     crayon_1.5.2           R.oo_1.25.0           
[112] htmltools_0.5.5        later_1.3.0            tzdb_0.3.0            
[115] Formula_1.2-5          ComplexHeatmap_2.10.0  MASS_7.3-55           
[118] car_3.1-2              Matrix_1.5-4           cli_3.6.1             
[121] R.methodsS3_1.8.2      parallel_4.1.3         gower_1.0.1           
[124] igraph_1.4.2           pkgconfig_2.0.3        foreign_0.8-82        
[127] sp_1.6-0               plotly_4.10.1          spatstat.sparse_3.0-1 
[130] recipes_1.0.6          xml2_1.3.3             foreach_1.5.2         
[133] hardhat_1.3.0          prodlim_2023.03.31     callr_3.7.3           
[136] digest_0.6.31          sctransform_0.3.5.9002 RcppAnnoy_0.0.20      
[139] spatstat.data_3.0-1    rmarkdown_2.21         leiden_0.4.3          
[142] htmlTable_2.4.1        uwot_0.1.14            shiny_1.7.4           
[145] rjson_0.2.21           lifecycle_1.0.3        nlme_3.1-155          
[148] jsonlite_1.8.4         carData_3.0-5          desc_1.4.2            
[151] viridisLite_0.4.1      limma_3.50.3           fansi_1.0.4           
[154] pillar_1.9.0           lattice_0.20-45        fastmap_1.1.1         
[157] httr_1.4.5             survival_3.3-1         remotes_2.4.2         
[160] glue_1.6.2             fdrtool_1.2.17         png_0.1-8             
[163] iterators_1.0.14       class_7.3-20           stringi_1.7.12        
[166] caTools_1.18.2         irlba_2.3.5.1          e1071_1.7-13          
[169] future.apply_1.10.0

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: 55 minutes
# Hands-on time however is between 10-15 minutes!
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "ccc",
  "03_nichenet_prioritization_plots.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "ccc",
  "03_nichenet_prioritization_plots.Rmd"
))
```
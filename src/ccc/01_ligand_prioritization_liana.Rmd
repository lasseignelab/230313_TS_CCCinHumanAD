---
title: "01_ligand_prioritization_liana"
author: "Tabea M. Soelter"
date: '2023-04-20'
output: html_document
---
**Ligand prioritization using LIANA**

__Goal__: Identify and prioritize ligands using LIANA across all datasets.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.0 
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU

__Data__: 
* Name: vine_processed_seurat.rds, geo_processed_seurat.rds, vinecortex_processed_seurat.rds
* Location: /data/user/tsoelter/projects/230313_TS_CCCinHumanAD/data/
 
__Analysis Plan__: 
* Load necessary packages 
* Load data 
* Identify ligands using liana
* Load NicheNet's prior knowledge 
* Filter liana ligands using NicheNet's prior
* Save filtered ligands

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(Seurat)
  library(tidyverse)
  library(liana)
  library(here)
  library(lintr)
  library(styler)
})

# load functions
source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
vine <- readRDS(here("data", "vine_processed_seurat.rds"))

geo <- readRDS(here("data", "geo_processed_seurat.rds"))

vine_cortex <- readRDS(here("data", "vinecortex_processed_seurat.rds"))
```

# Prepare data
```{r}
# create a list of all objects
object_list <- tibble::lst(vine, geo, vine_cortex)

# UMAPs split by condition saved to results/final_outputs/ dir by dataset
prep_liana(object_list = object_list)

# split objects by condition for liana
split_object_list <- lapply(object_list, split_objects)
```
* The split_object_list should include all objects and show both AD and CTRL for each.

# Prioritize ligands
* Sender cell populations: Astrocytes, Oligodendrocytes, Microglia, OPCs
* Receiver cell population: Excitatory Neurons
```{r}
liana_ligands <- lapply(split_object_list,
  lapply,
  liana_prioritization,
  sender = c(
    "Astrocytes",
    "Oligodendrocytes",
    "Microglia",
    "OPCs"
  ),
  receiver = "Excitatory Neurons"
)

# save list of ligands
saveRDS(liana_ligands, file = here(
  "data",
  "ccc",
  "liana_ligands_unfiltered.rds"
))
```

# Load and filter NicheNet prior
* The GRN and PPI matrices provided by the Saeys lab were downloaded here: https://zenodo.org/record/3260758#.ZEgJROxuf0o
```{r}
# load the ligand target matrix
ligand_target_matrix <- readRDS(here("data",
                                     "ccc",
                                     "nichenet_prior",
                                     "ligand_target_matrix.rds"))

# load and filter the ligand receptor network as recommended by developers
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "lr_network.rds")) %>%
  mutate(bonafide = !database %in% c("ppi_prediction", "ppi_prediction_go")) %>%
  dplyr::rename(ligand = from, receptor = to) %>%
  distinct(ligand, receptor, bonafide)

# set organism
organism <- "human"
```

# Filter LIANA ligands
* I am filtering ligands identified using LIANA by what is within NicheNet's prior.
```{r}
# filter ligands of each dataset and condition
liana_ligands_filt <- lapply(
  liana_ligands,
  lapply,
  filter_ligands
)

# number of unique ligands: 58 52 133 142 49 51

# unlist and add objects to global environment
list2env(liana_ligands_filt, globalenv())
``` 

# Collapse and save ligands
* All ligands for each dataset will be in a single vector irrespecvtive of the sender cell type or the condition. These ligands will be used in the NicheNet approach downstream.
* To do so, I unlisted each dataset and only kept unique ligands. 
__vine__
```{r}
vine_ligands <- unique(unlist(vine))
length(vine_ligands) # 59

# save ligands
saveRDS(vine_ligands, file = here(
  "results",
  "intermediate_outputs",
  "vine",
  "ccc",
  "liana_ligands.rds"
))
```

__geo__
```{r}
geo_ligands <- unique(unlist(geo))
length(geo_ligands) # 142

# save ligands
saveRDS(geo_ligands, file = here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "liana_ligands.rds"
))
```

__vine_cortex__
```{r}
vine_cortex_ligands <- unique(unlist(vine_cortex))
length(vine_cortex_ligands) # 60

# save ligands
saveRDS(vine_cortex_ligands, file = here(
  "results",
  "intermediate_outputs",
  "vine_cortex",
  "ccc",
  "liana_ligands.rds"
))
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.5 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] styler_1.9.1       lintr_3.0.2        here_1.0.1         liana_0.1.12       lubridate_1.9.2    forcats_1.0.0     
 [7] stringr_1.5.0      dplyr_1.1.0        purrr_1.0.1        readr_2.1.4        tidyr_1.3.0        tibble_3.2.0      
[13] ggplot2_3.4.1      tidyverse_2.0.0    SeuratObject_4.1.3 Seurat_4.3.0.9002 

loaded via a namespace (and not attached):
  [1] rappdirs_0.3.3              scattermore_0.8             R.methodsS3_1.8.2           ragg_1.2.5                 
  [5] knitr_1.42                  irlba_2.3.5.1               DelayedArray_0.20.0         R.utils_2.12.2             
  [9] data.table_1.14.8           RCurl_1.98-1.10             doParallel_1.0.17           generics_0.1.3             
 [13] BiocGenerics_0.40.0         ScaledMatrix_1.2.0          callr_3.7.3                 cowplot_1.1.1              
 [17] RANN_2.6.1                  future_1.32.0               tzdb_0.3.0                  spatstat.data_3.0-1        
 [21] xml2_1.3.3                  httpuv_1.6.9                SummarizedExperiment_1.24.0 viridis_0.6.2              
 [25] xfun_0.37                   hms_1.1.2                   evaluate_0.20               promises_1.2.0.1           
 [29] fansi_1.0.4                 progress_1.2.2              readxl_1.4.2                igraph_1.4.1               
 [33] htmlwidgets_1.6.1           spatstat.geom_3.1-0         stats4_4.1.3                ellipsis_0.3.2             
 [37] backports_1.4.1             deldir_1.0-6                sparseMatrixStats_1.6.0     MatrixGenerics_1.6.0       
 [41] vctrs_0.5.2                 SingleCellExperiment_1.16.0 Biobase_2.54.0              remotes_2.4.2              
 [45] ROCR_1.0-11                 abind_1.4-5                 withr_2.5.0                 progressr_0.13.0           
 [49] checkmate_2.1.0             sctransform_0.3.5.9002      prettyunits_1.1.1           scran_1.22.1               
 [53] goftest_1.2-3               cluster_2.1.2               cyclocomp_1.1.0             dir.expiry_1.2.0           
 [57] lazyeval_0.2.2              crayon_1.5.2                basilisk.utils_1.11.2       spatstat.explore_3.0-6     
 [61] edgeR_3.36.0                pkgconfig_2.0.3             labeling_0.4.2              GenomeInfoDb_1.30.1        
 [65] nlme_3.1-155                vipor_0.4.5                 xmlparsedata_1.0.5          rlang_1.0.6                
 [69] globals_0.16.2              lifecycle_1.0.3             miniUI_0.1.1.1              filelock_1.0.2             
 [73] rex_1.2.1                   rsvd_1.0.5                  cellranger_1.1.0            rprojroot_2.0.3            
 [77] polyclip_1.10-4             matrixStats_0.63.0          lmtest_0.9-40               Matrix_1.5-3               
 [81] zoo_1.8-11                  beeswarm_0.4.0              ggridges_0.5.4              GlobalOptions_0.1.2        
 [85] processx_3.8.0              png_0.1-8                   viridisLite_0.4.1           rjson_0.2.21               
 [89] bitops_1.0-7                R.oo_1.25.0                 KernSmooth_2.23-20          DelayedMatrixStats_1.16.0  
 [93] shape_1.4.6                 parallelly_1.34.0           spatstat.random_3.1-3       R.cache_0.16.0             
 [97] S4Vectors_0.32.4            beachmat_2.10.0             scales_1.2.1                magrittr_2.0.3             
[101] plyr_1.8.8                  ica_1.0-3                   zlibbioc_1.40.0             compiler_4.1.3             
[105] dqrng_0.3.0                 RColorBrewer_1.1-3          clue_0.3-64                 fitdistrplus_1.1-8         
[109] cli_3.6.0                   XVector_0.34.0              listenv_0.9.0               patchwork_1.1.2            
[113] pbapply_1.7-0               ps_1.7.2                    MASS_7.3-55                 tidyselect_1.2.0           
[117] stringi_1.7.12              textshaping_0.3.6           yaml_2.3.7                  BiocSingular_1.10.0        
[121] locfit_1.5-9.7              ggrepel_0.9.3               grid_4.1.3                  tools_4.1.3                
[125] timechange_0.2.0            future.apply_1.10.0         parallel_4.1.3              circlize_0.4.15            
[129] rstudioapi_0.14             bluster_1.4.0               foreach_1.5.2               metapod_1.2.0              
[133] gridExtra_2.3               farver_2.1.1                Rtsne_0.16                  digest_0.6.31              
[137] shiny_1.7.4                 Rcpp_1.0.10                 GenomicRanges_1.46.1        scuttle_1.4.0              
[141] later_1.3.0                 RcppAnnoy_0.0.20            httr_1.4.5                  ComplexHeatmap_2.10.0      
[145] colorspace_2.1-0            rvest_1.0.3                 tensor_1.5                  reticulate_1.28            
[149] IRanges_2.28.0              splines_4.1.3               uwot_0.1.14                 statmod_1.5.0              
[153] OmnipathR_3.7.2             spatstat.utils_3.0-2        scater_1.22.0               sp_1.6-0                   
[157] basilisk_1.11.2             plotly_4.10.1               systemfonts_1.0.4           xtable_1.8-4               
[161] jsonlite_1.8.4              R6_2.5.1                    pillar_1.8.1                htmltools_0.5.4            
[165] mime_0.12                   glue_1.6.2                  fastmap_1.1.1               BiocParallel_1.28.3        
[169] BiocNeighbors_1.12.0        codetools_0.2-18            utf8_1.2.3                  lattice_0.20-45            
[173] spatstat.sparse_3.0-1       logger_0.2.2                curl_5.0.0                  ggbeeswarm_0.7.1           
[177] leiden_0.4.3                survival_3.3-1              limma_3.50.3                rmarkdown_2.20             
[181] desc_1.4.2                  munsell_0.5.0               GetoptLong_1.0.5            GenomeInfoDbData_1.2.7     
[185] iterators_1.0.14            reshape2_1.4.4              gtable_0.3.1

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: 45 minutes
# Hands-on time however is between 5-15 minutes!
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "ccc",
  "01_ligand_prioritization_liana.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "ccc",
  "01_ligand_prioritization_liana.Rmd"
))
```

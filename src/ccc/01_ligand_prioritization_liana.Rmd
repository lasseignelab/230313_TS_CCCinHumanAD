---
title: "01_ligand_prioritization_liana"
author: "Tabea M. Soelter"
date: '2023-04-20'
output: html_document
---
**Ligand prioritization using LIANA**

__Goal__: Identify and prioritize ligands using LIANA across all datasets.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.0 
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU

__Data__: 
* Name: vine_processed_seurat.rds, geo_processed_seurat.rds, vinecortex_processed_seurat.rds
* Location: /data/user/tsoelter/projects/230313_TS_CCCinHumanAD/data/
 
__Analysis Plan__: 
* Load necessary packages 
* Load data 
* Identify ligands using liana
* Load NicheNet's prior knowledge 
* Filter liana ligands using NicheNet's prior
* Save filtered ligands

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(Seurat)
  library(tidyverse)
  library(liana)
  library(here)
  library(lintr)
  library(styler)
})

# load functions
source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
vine <- readRDS(here("data", "vine_processed_seurat.rds"))

geo <- readRDS(here("data", "geo_processed_seurat.rds"))

vine_cortex <- readRDS(here("data", "vinecortex_processed_seurat.rds"))
```

# Prepare data
```{r}
# create a list of all objects
object_list <- tibble::lst(vine, geo, vine_cortex)

# UMAPs split by condition saved to results/final_outputs/ dir by dataset
prep_liana(object_list = object_list)

# split objects by condition for liana
split_object_list <- lapply(object_list, split_objects)
```
* The split_object_list should include all objects and show both AD and CTRL for each.

# Prioritize ligands
* Sender cell populations: Astrocytes, Oligodendrocytes, Microglia, OPCs
* Receiver cell population: Excitatory Neurons
```{r}
liana_ligands <- lapply(split_object_list,
  lapply,
  liana_prioritization,
  sender = c(
    "Astrocytes",
    "Oligodendrocytes",
    "Microglia",
    "OPCs"
  ),
  receiver = "Excitatory Neurons"
)

# save list of ligands
saveRDS(liana_ligands, file = here(
  "data",
  "ccc",
  "liana_ligands_unfiltered.rds"
))
```

# Load and filter NicheNet prior
* The GRN and PPI matrices provided by the Saeys lab were downloaded here: https://zenodo.org/record/3260758#.ZEgJROxuf0o
```{r}
# load the ligand target matrix
ligand_target_matrix <- readRDS(here("data",
                                     "ccc",
                                     "nichenet_prior",
                                     "ligand_target_matrix.rds"))

# load and filter the ligand receptor network as recommended by developers
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "lr_network.rds"
)) %>%
  mutate(bonafide = !database %in% c("ppi_prediction", "ppi_prediction_go")) %>%
  dplyr::rename(ligand = from, receptor = to) %>%
  distinct(ligand, receptor, bonafide)

# set organism
organism <- "human"
```

# Filter LIANA ligands
* I am filtering ligands identified using LIANA by what is within NicheNet's prior.
```{r}
# filter ligands of each dataset and condition
liana_ligands_filt <- lapply(
  liana_ligands,
  lapply,
  filter_ligands
)

# number of unique ligands: 33 32 91 101 34 34

# unlist and add objects to global environment
list2env(liana_ligands_filt, globalenv())
``` 

# Collapse and save ligands
* All ligands for each dataset will be in a single vector irrespecvtive of the sender cell type or the condition. These ligands will be used in the NicheNet approach downstream.
* To do so, I unlisted each dataset and only kept unique ligands. 
__vine__
```{r}
vine_ligands <- unique(unlist(vine))
length(vine_ligands) # 33

# save ligands
saveRDS(vine_ligands, file = here(
  "results",
  "intermediate_outputs",
  "vine",
  "ccc",
  "liana_ligands.rds"
))
```

__geo__
```{r}
geo_ligands <- unique(unlist(geo))
length(geo_ligands) # 101

# save ligands
saveRDS(geo_ligands, file = here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "liana_ligands.rds"
))
```

__vine_cortex__
```{r}
vine_cortex_ligands <- unique(unlist(vine_cortex))
length(vine_cortex_ligands) # 41

# save ligands
saveRDS(vine_cortex_ligands, file = here(
  "results",
  "intermediate_outputs",
  "vine_cortex",
  "ccc",
  "liana_ligands.rds"
))
```

# Session info
```{r}
sessionInfo() # see output below
```

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to hours
(fptm[3] / 60) / 60

# Time elapsed:  hours
# Hands-on time however is between  minutes!
```

# Reproducibility
```{r eval=FALSE, include=FALSE}
# styler
style_file(here(
  "src",
  "ccc",
  "01_ligand_prioritization_liana.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "ccc",
  "01_ligand_prioritization_liana.Rmd"
))
```

---
title: "04_nichenet_control"
author: "Tabea M. Soelter"
date: '2023-05-11'
output: html_document
---
**Title**

Following this vignette: https://github.com/saeyslab/nichenetr/blob/master/vignettes/seurat_steps.md 

#__Goal__: EDIT THIS

__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.1 
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU

#__Data__: EDIT THIS
**
* Name: 
* Location: 
 
#__Analysis Plan__: EDIT THIS
* Load necessary packages 
* Load data
  * NicheNet outputs
* Prioritize outputs
  * Using prioritization weights
* Generate plots
* Save plots

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(nichenetr)
  library(Seurat)
  library(UpSetR)
  library(here)
  library(styler)
  library(lintr)
})

# load functions
source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
vinecortex_object <- readRDS(here("data", "vinecortex_processed_seurat.rds"))

geo_object <- readRDS(here("data", "geo_processed_seurat.rds"))
```

# Load NicheNet prior
```{r}
# load the ligand target matrix
ligand_target_matrix <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "ligand_target_matrix.rds"
))

# load and filter the ligand receptor network as recommended by developers
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "lr_network.rds"
)) %>%
  mutate(bonafide = !database %in% c("ppi_prediction", "ppi_prediction_go")) %>%
  dplyr::rename(ligand = from, receptor = to) %>%
  distinct(ligand, receptor, bonafide)

# set organism
organism <- "human"
```

# Split data by condition
* We want only CTRL data (do we? I don't think so anymore, so might have to clean up later and remove this code chunk)
```{r}
# VINE cortex
vinecortex_split <- SplitObject(vinecortex_object, split.by = "orig.ident")
vinecortex_control <- vinecortex_split$CTRL

vinecortex_control@active.ident %>% table()

# GEO
geo_split <- SplitObject(geo_object, split.by = "orig.ident")
geo_control <- geo_split$CTRL

geo_control@active.ident %>% table()
```

# Define sender and receiver niches
## Set receiver cell type
```{r}
receiver <- "Excitatory Neurons"

expressed_genes_receiver_geo <- get_expressed_genes(receiver, geo_object, pct = 0.10)
expressed_genes_receiver_vinec <- get_expressed_genes(receiver, vinecortex_object, pct = 0.10)

background_expressed_genes_geo <- expressed_genes_receiver_geo %>% .[. %in% rownames(ligand_target_matrix)]
background_expressed_genes_vinec <- expressed_genes_receiver_vinec %>% .[. %in% rownames(ligand_target_matrix)]
```

## Set sender cell types
```{r}
sender_celltypes <- c("Astrocytes", "Oligodendrocytes", "OPCs", "Microglia")

list_expressed_genes_sender_geo <- sender_celltypes %>% unique() %>% lapply(get_expressed_genes, geo_object, 0.10)
list_expressed_genes_sender_vinec <- sender_celltypes %>% unique() %>% lapply(get_expressed_genes, vinecortex_object, 0.10)

expressed_genes_sender_geo <- list_expressed_genes_sender_geo %>% unlist() %>% unique()
expressed_genes_sender_vinec <- list_expressed_genes_sender_vinec %>% unlist() %>% unique()
```

# Define gene set of interest
* condition of interest: CTRL
```{r}
# set conditions
condition_oi <- "CTRL"
condition_reference <- "AD" 

# geo
geo_obj_receiver <- subset(geo_object, idents = receiver)
geo_obj_receiver <- SetIdent(geo_obj_receiver, value = geo_obj_receiver[["orig.ident"]])
  
DE_table_receiver_geo <- FindMarkers(object = geo_obj_receiver, ident.1 = condition_oi, ident.2 = condition_reference, min.pct = 0.10) %>% rownames_to_column("gene")

geneset_oi_geo <- DE_table_receiver_geo %>% filter(p_val_adj <= 0.05 & abs(avg_log2FC) >= 0.25) %>% pull(gene)
geneset_oi_geo <- geneset_oi_geo %>% .[. %in% rownames(ligand_target_matrix)]

# vine cortex
vinec_obj_receiver <- subset(vinecortex_object, idents = receiver)
vinec_obj_receiver <- SetIdent(vinec_obj_receiver, value = vinec_obj_receiver[["orig.ident"]])
  
DE_table_receiver_vinec <- FindMarkers(object = vinec_obj_receiver, ident.1 = condition_oi, ident.2 = condition_reference, min.pct = 0.10) %>% rownames_to_column("gene")

geneset_oi_vinec <- DE_table_receiver_vinec %>% filter(p_val_adj <= 0.05 & abs(avg_log2FC) >= 0.25) %>% pull(gene)
geneset_oi_vinec <- geneset_oi_vinec %>% .[. %in% rownames(ligand_target_matrix)]
```

# Define gene set of potential ligands
```{r}
ligands <- lr_network %>% pull(ligand) %>% unique()
receptors <- lr_network %>% pull(receptor) %>% unique()

# geo
expressed_ligands_geo <- intersect(ligands, expressed_genes_sender_geo)
expressed_receptors_geo <- intersect(receptors, expressed_genes_receiver_geo)

potential_ligands_geo <- lr_network %>% filter(ligand %in% expressed_ligands_geo & receptor %in% expressed_receptors_geo) %>% pull(ligand) %>% unique()

# vine cortex
expressed_ligands_vinec <- intersect(ligands, expressed_genes_sender_vinec)
expressed_receptors_vinec <- intersect(receptors, expressed_genes_receiver_vinec)

potential_ligands_vinec <- lr_network %>% filter(ligand %in% expressed_ligands_vinec & receptor %in% expressed_receptors_vinec) %>% pull(ligand) %>% unique()
```

# upset of identified ligands
```{r}
geo_ligands <- ligand_activities_geo$test_ligand
vinec_ligands <- ligand_activities_vinec$test_ligand

n <- max(length(geo_ligands), length(vinec_ligands))
length(geo_ligands) <- n 
length(vinec_ligands) <- n

ligands <- data.frame(geo_ligands, vinec_ligands)

ligands_ls <- as.list(ligands) 

ligands_lst <- lapply(ligands_ls, function(x) x[!is.na(x)]) 

ligands_upset <- upset(fromList(ligands_lst),
                       order.by = "freq")

ligands_upset
```



# Ligand activity analysis
```{r}
# geo
ligand_activities_geo <- predict_ligand_activities(geneset = geneset_oi_geo, background_expressed_genes = background_expressed_genes_geo, ligand_target_matrix = ligand_target_matrix, potential_ligands = potential_ligands_geo)

ligand_activities_geo <- ligand_activities_geo %>% arrange(-pearson) %>% mutate(rank = rank(desc(pearson)))
ligand_activities_geo

best_upstream_ligands_geo <- ligand_activities_geo %>% top_n(20, pearson) %>% arrange(-pearson) %>% pull(test_ligand) %>% unique()

# vine cortex
ligand_activities_vinec <- predict_ligand_activities(geneset = geneset_oi_vinec, background_expressed_genes = background_expressed_genes_vinec, ligand_target_matrix = ligand_target_matrix, potential_ligands = potential_ligands_vinec)

ligand_activities_vinec <- ligand_activities_vinec %>% arrange(-pearson) %>% mutate(rank = rank(desc(pearson)))
ligand_activities_vinec

best_upstream_ligands_vinec <- ligand_activities_vinec %>% top_n(20, pearson) %>% arrange(-pearson) %>% pull(test_ligand) %>% unique()


# plot ligands for both datasets
DotPlot(geo_object, features = best_upstream_ligands_geo) + RotatedAxis()

DotPlot(vinecortex_object, features = best_upstream_ligands_vinec) + RotatedAxis()
```

# Infer receptors and top predicted target genes
```{r}
best_upstream_ligands_geo <- ligand_activities_geo %>% top_n(200, pearson) %>% arrange(-pearson) %>% pull(test_ligand) %>% unique()

best_upstream_ligands_vinec <- ligand_activities_vinec %>% top_n(200, pearson) %>% arrange(-pearson) %>% pull(test_ligand) %>% unique()

# geo -----------------
active_ligand_target_links_df_geo <- best_upstream_ligands_geo %>%
  lapply(get_weighted_ligand_target_links,
         geneset = geneset_oi_geo,
         ligand_target_matrix = ligand_target_matrix,
         n = 500) %>% bind_rows() %>%
  drop_na()

active_ligand_target_links_geo <- prepare_ligand_target_visualization(
  ligand_target_df = active_ligand_target_links_df_geo,
  ligand_target_matrix = ligand_target_matrix,
  cutoff = 0.33)

order_ligands_geo <- intersect(best_upstream_ligands_geo,
                          colnames(active_ligand_target_links_geo)) %>%
  rev() %>%
  make.names()

order_targets_geo <- active_ligand_target_links_df_geo$target %>%
  unique() %>%
  intersect(rownames(active_ligand_target_links_geo)) %>%
  make.names()

rownames(active_ligand_target_links_geo) <- rownames(active_ligand_target_links_geo) %>%
  make.names() # make.names() for heatmap visualization of genes like H2-T23
colnames(active_ligand_target_links_geo) <- colnames(active_ligand_target_links_geo) %>%
  make.names() # make.names() for heatmap visualization of genes like H2-T23

vis_ligand_target_geo <- active_ligand_target_links_geo[order_targets_geo,
                                                           order_ligands_geo] %>%
  t()

p_ligand_target_network_geo <- vis_ligand_target_geo %>%
  make_heatmap_ggplot("Prioritized ligands","Predicted target genes",
                      color = "purple",
                      legend_position = "top",
                      x_axis_position = "top",
                      legend_title = "Regulatory potential")  +
  theme(axis.text.x = element_text(face = "italic")) +
  scale_fill_gradient2(low = "whitesmoke",
                       high = "purple",
                       breaks = c(0,0.0045,0.0090))
p_ligand_target_network_geo

# vine cortex -------------
active_ligand_target_links_df_vinec <- best_upstream_ligands_vinec %>%
  lapply(get_weighted_ligand_target_links,
         geneset = geneset_oi_vinec,
         ligand_target_matrix = ligand_target_matrix,
         n = 500) %>% bind_rows() %>%
  drop_na()

active_ligand_target_links_vinec <- prepare_ligand_target_visualization(
  ligand_target_df = active_ligand_target_links_df_vinec,
  ligand_target_matrix = ligand_target_matrix,
  cutoff = 0.33)

order_ligands_vinec <- intersect(best_upstream_ligands_vinec,
                          colnames(active_ligand_target_links_vinec)) %>%
  rev() %>%
  make.names()

order_targets_vinec <- active_ligand_target_links_df_vinec$target %>%
  unique() %>%
  intersect(rownames(active_ligand_target_links_vinec)) %>%
  make.names()

rownames(active_ligand_target_links_vinec) <- rownames(active_ligand_target_links_vinec) %>%
  make.names() # make.names() for heatmap visualization of genes like H2-T23
colnames(active_ligand_target_links_vinec) <- colnames(active_ligand_target_links_vinec) %>%
  make.names() # make.names() for heatmap visualization of genes like H2-T23

vis_ligand_target_vinec <- active_ligand_target_links_vinec[order_targets_vinec,
                                                            order_ligands_vinec] %>%
  t()

p_ligand_target_network_vinec = vis_ligand_target_vinec %>%
  make_heatmap_ggplot("Prioritized ligands","Predicted target genes",
                      color = "purple",
                      legend_position = "top",
                      x_axis_position = "top",
                      legend_title = "Regulatory potential")  +
  theme(axis.text.x = element_text(face = "italic")) +
  scale_fill_gradient2(low = "whitesmoke",
                       high = "purple",
                       breaks = c(0,0.0045,0.0090))
p_ligand_target_network_vinec
```

# compare targets
```{r}
geo_targets <- active_ligand_target_links_df_geo$target
vinec_targets <- active_ligand_target_links_df_vinec$target

n <- max(length(geo_targets), length(vinec_targets))
length(geo_targets) <- n 
length(vinec_targets) <- n

targets <- data.frame(geo_targets, vinec_targets)

targets_ls <- as.list(targets) 

targets_lst <- lapply(targets_ls, function(x) x[!is.na(x)]) 

targets_upset <- upset(fromList(targets_lst),
                       order.by = "freq")

targets_upset
```

# Determine receptors of ligands
```{r}
# geo ----------
lr_network_top_geo <- lr_network %>% filter(ligand %in% best_upstream_ligands_geo & receptor %in% expressed_receptors_geo) %>% distinct(ligand, receptor)

best_upstream_receptors_geo <- lr_network_top_geo %>% pull(receptor) %>% unique()

lr_network_top_df_large_geo <- weighted_networks_lr %>% filter(from %in% best_upstream_ligands_geo & to %in% best_upstream_receptors_geo)

lr_network_top_df_geo <- lr_network_top_df_large_geo %>% spread("from","weight",fill = 0)

lr_network_top_matrix_geo <- lr_network_top_df_geo %>% select(-to) %>% as.matrix() %>% magrittr::set_rownames(lr_network_top_df_geo$to)

dist_receptors_geo <- dist(lr_network_top_matrix_geo, method = "binary")

hclust_receptors_geo <- hclust(dist_receptors_geo, method = "ward.D2")

order_receptors_geo <- hclust_receptors_geo$labels[hclust_receptors_geo$order]
    
dist_ligands_geo <- dist(lr_network_top_matrix_geo %>% t(), method = "binary")

hclust_ligands_geo <- hclust(dist_ligands_geo, method = "ward.D2")

order_ligands_receptor_geo <- hclust_ligands_geo$labels[hclust_ligands_geo$order]

order_receptors_geo <- order_receptors_geo %>% intersect(rownames(lr_network_top_matrix_geo))

order_ligands_receptor_geo <- order_ligands_receptor_geo %>% intersect(colnames(lr_network_top_matrix_geo))

vis_ligand_receptor_network_geo <- lr_network_top_matrix_geo[order_receptors_geo, order_ligands_receptor_geo]
rownames(vis_ligand_receptor_network_geo) <- order_receptors_geo %>% make.names()
colnames(vis_ligand_receptor_network_geo) <- order_ligands_receptor_geo %>% make.names()

# vine cortex ----------
lr_network_top_vinec <- lr_network %>% filter(ligand %in% best_upstream_ligands_vinec & receptor %in% expressed_receptors_vinec) %>% distinct(ligand, receptor)

best_upstream_receptors_vinec <- lr_network_top_vinec %>% pull(receptor) %>% unique()

lr_network_top_df_large_vinec <- weighted_networks_lr %>% filter(from %in% best_upstream_ligands_vinec & to %in% best_upstream_receptors_vinec)

lr_network_top_df_vinec <- lr_network_top_df_large_vinec %>% spread("from","weight",fill = 0)

lr_network_top_matrix_vinec <- lr_network_top_df_vinec %>% select(-to) %>% as.matrix() %>% magrittr::set_rownames(lr_network_top_df_vinec$to)

dist_receptors_vinec <- dist(lr_network_top_matrix_vinec, method = "binary")

hclust_receptors_vinec <- hclust(dist_receptors_vinec, method = "ward.D2")

order_receptors_vinec <- hclust_receptors_vinec$labels[hclust_receptors_vinec$order]
    
dist_ligands_vinec <- dist(lr_network_top_matrix_vinec %>% t(), method = "binary")

hclust_ligands_vinec <- hclust(dist_ligands_vinec, method = "ward.D2")

order_ligands_receptor_vinec <- hclust_ligands_vinec$labels[hclust_ligands_vinec$order]

order_receptors_vinec <- order_receptors_vinec %>% intersect(rownames(lr_network_top_matrix_vinec))

order_ligands_receptor_vinec <- order_ligands_receptor_vinec %>% intersect(colnames(lr_network_top_matrix_vinec))

vis_ligand_receptor_network_vinec <- lr_network_top_matrix_vinec[order_receptors_vinec, order_ligands_receptor_vinec]
rownames(vis_ligand_receptor_network_vinec) <- order_receptors_vinec %>% make.names()
colnames(vis_ligand_receptor_network_vinec) <- order_ligands_receptor_vinec %>% make.names()

# upset plot 
geo_receptors <- best_upstream_receptors_geo
vinec_receptors <- best_upstream_receptors_vinec

n <- max(length(geo_receptors), length(vinec_receptors))
length(geo_receptors) <- n 
length(vinec_receptors) <- n

receptors <- data.frame(geo_receptors, vinec_receptors)

receptors_ls <- as.list(receptors) 

receptors_lst <- lapply(receptors_ls, function(x) x[!is.na(x)]) 

receptors_upset <- upset(fromList(receptors_lst),
                       order.by = "freq")

receptors_upset
```






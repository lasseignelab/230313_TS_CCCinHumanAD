---
title: "03_nichenet_prioritization_plots"
author: "Tabea M. Soelter"
date: '2023-04-28'
output: html_document
---
**Plotting Differential Cell-Cell Communication Results**

__Goal__: Prioritize ligands, receptors, and target genes, then plot them for each dataset.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.1 
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU

__Data__: 
*NicheNet outputs*
* Name: ex_neurons_nichenet_output.rds, in_neurons_nichenet_output.rds
* Location: results/intermediate_outputs/geo/ccc/, results/intermediate_outputs/vine/ccc/, results/intermediate_outputs/vine_cortex/ccc/
 
__Analysis Plan__: 
* Load necessary packages 
* Load data
  * NicheNet outputs
* Prioritize outputs
  * Using prioritization weights
* Generate plots
* Save plots

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(nichenetr)
  library(Seurat)
  library(here)
  library(styler)
  library(lintr)
})

# load functions
source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
* Loading NicheNet outputs for all datasets
```{r}
vine_cortex_output_ex <- readRDS(here(
  "results",
  "intermediate_outputs",
  "vine_cortex",
  "ccc",
  "ex_neurons_nichenet_output.rds"
))

vine_output_ex <- readRDS(here(
  "results",
  "intermediate_outputs",
  "vine",
  "ccc",
  "ex_neurons_nichenet_output.rds"
))

geo_output_ex <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "ex_neurons_nichenet_output.rds"
))

vine_cortex_output_in <- readRDS(here(
  "results",
  "intermediate_outputs",
  "vine_cortex",
  "ccc",
  "in_neurons_nichenet_output.rds"
))

vine_output_in <- readRDS(here(
  "results",
  "intermediate_outputs",
  "vine",
  "ccc",
  "in_neurons_nichenet_output.rds"
))

geo_output_in <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "in_neurons_nichenet_output.rds"
))

# create a list of output objects
output_list <- tibble::lst(
  vine_output_ex,
  geo_output_ex,
  vine_cortex_output_ex,
  vine_output_in,
  geo_output_in,
  vine_cortex_output_in
)
```

# Load NicheNet prior
```{r}
# load the ligand target matrix
ligand_target_matrix <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "ligand_target_matrix.rds"
))

# load and filter the ligand receptor network as recommended by developers
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "lr_network.rds"
)) %>%
  mutate(bonafide = !database %in% c("ppi_prediction", "ppi_prediction_go")) %>%
  dplyr::rename(ligand = from, receptor = to) %>%
  distinct(ligand, receptor, bonafide)

# set organism
organism <- "human"
```

# L-R prioritization
* Adapting these values can change what is favored. 
* These cut-offs will favor differentially expressed l-r pairs compared to activity.
* In-depth explanations of each factor can be found in the vignette for differential NicheNet. 
```{r}
prioritizing_weights <- c(
  "scaled_ligand_score" = 5,
  "scaled_ligand_expression_scaled" = 1,
  "ligand_fraction" = 1,
  "scaled_ligand_score_spatial" = 0,
  "scaled_receptor_score" = 0.5,
  "scaled_receptor_expression_scaled" = 0.5,
  "receptor_fraction" = 1,
  "ligand_scaled_receptor_expression_fraction" = 1,
  "scaled_receptor_score_spatial" = 0,
  "scaled_activity" = 0,
  "scaled_activity_normalized" = 1,
  "bona_fide" = 1
)

# Prioritize interactions based on weights and save outputs to respective dirs
prioritization_tables_ls <- prioritize_interactions(output_list,
  file_path = here(
    "results",
    "intermediate_outputs/"
  )
)

# unlist and add objects to global environment
list2env(prioritization_tables_ls, globalenv())
```

# Visualization
* Plotting the standard NicheNet plot which includes ligand expression and activity (scaled and normalized), as well as regulatory potential of predicted target genes
* After plotting, outputs will be saved to results/intermediate_outputs/{dataset}/ccc/

__vine__
```{r}
# excitatory neurons
ex_vine_plots <- make_nichenet_plot(vine_prioritization_tbl_ex,
  output = vine_output_ex,
  receiver_oi = "Excitatory Neurons_AD",
  lfc_cutoff = 0.15
)

# inhibitory neurons
in_vine_plots <- make_nichenet_plot(vine_prioritization_tbl_in,
  output = vine_output_in,
  receiver_oi = "Inhibitory Neurons_AD",
  lfc_cutoff = 0.15
)

# save plots to vine intermediate_outputs results directory
pdf(
  here(
    "results",
    "intermediate_outputs",
    "vine",
    "ccc",
    "nichenet_plots.pdf"
  ),
  width = 8.5,
  height = 11
)

ex_vine_plots$exprs_activity_target_plot$combined_plot
ex_vine_plots$exprs_activity_target_plot$legends
ex_vine_plots$lfc_plot

in_vine_plots$exprs_activity_target_plot$combined_plot
in_vine_plots$exprs_activity_target_plot$legends
in_vine_plots$lfc_plot

dev.off()
```

__geo__
```{r}
# excitatory neurons
ex_geo_plots <- make_nichenet_plot(geo_prioritization_tbl_ex,
  output = geo_output_ex,
  receiver_oi = "Excitatory Neurons_AD",
  lfc_cutoff = 0.15
)

# inhibitory neurons
in_geo_plots <- make_nichenet_plot(geo_prioritization_tbl_in,
  output = geo_output_in,
  receiver_oi = "Inhibitory Neurons_AD",
  lfc_cutoff = 0.15
)

# save plots to geo results directory
pdf(
  here(
    "results",
    "intermediate_outputs",
    "geo",
    "ccc",
    "nichenet_plots.pdf"
  ),
  width = 8.5,
  height = 11
)

ex_geo_plots$exprs_activity_target_plot$combined_plot
ex_geo_plots$exprs_activity_target_plot$legends
ex_geo_plots$lfc_plot

in_geo_plots$exprs_activity_target_plot$combined_plot
in_geo_plots$exprs_activity_target_plot$legends
in_geo_plots$lfc_plot

dev.off()
```

__vine_cortex__
```{r}
# excitatory neurons
ex_vine_cortex_plots <- make_nichenet_plot(vine_cortex_prioritization_tbl_ex,
  output = vine_cortex_output_ex,
  receiver_oi = "Excitatory Neurons_AD",
  lfc_cutoff = 0.15
)

# inhibitory neurons
in_vine_cortex_plots <- make_nichenet_plot(vine_cortex_prioritization_tbl_in,
  output = vine_cortex_output_in,
  receiver_oi = "Inhibitory Neurons_AD",
  lfc_cutoff = 0.15
)

# save plots to vine_cortex intermediate results directory
pdf(
  here(
    "results",
    "intermediate_outputs",
    "vine_cortex",
    "ccc",
    "nichenet_plots.pdf"
  ),
  width = 8.5,
  height = 11
)

ex_vine_cortex_plots$exprs_activity_target_plot$combined_plot
ex_vine_cortex_plots$exprs_activity_target_plot$legends
ex_vine_cortex_plots$lfc_plot

in_vine_cortex_plots$exprs_activity_target_plot$combined_plot
in_vine_cortex_plots$exprs_activity_target_plot$legends
in_vine_cortex_plots$lfc_plot

dev.off()
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2        styler_1.9.1       here_1.0.1         SeuratObject_4.1.3 Seurat_4.3.0.9002 
 [6] nichenetr_1.1.1    lubridate_1.9.2    forcats_1.0.0      stringr_1.5.0      dplyr_1.1.2       
[11] purrr_1.0.1        readr_2.1.4        tidyr_1.3.0        tibble_3.2.1       ggplot2_3.4.2     
[16] tidyverse_2.0.0   

loaded via a namespace (and not attached):
  [1] utf8_1.2.3             spatstat.explore_3.1-0 reticulate_1.28        R.utils_2.12.2        
  [5] tidyselect_1.2.0       htmlwidgets_1.6.2      grid_4.1.3             Rtsne_0.16            
  [9] pROC_1.18.0            munsell_0.5.0          codetools_0.2-18       ica_1.0-3             
 [13] future_1.32.0          miniUI_0.1.1.1         withr_2.5.0            spatstat.random_3.1-4 
 [17] colorspace_2.1-0       progressr_0.13.0       knitr_1.42             rstudioapi_0.14       
 [21] stats4_4.1.3           ROCR_1.0-11            ggsignif_0.6.4         tensor_1.5            
 [25] listenv_0.9.0          labeling_0.4.2         polyclip_1.10-4        farver_2.1.1          
 [29] rprojroot_2.0.3        parallelly_1.35.0      vctrs_0.6.2            generics_0.1.3        
 [33] ipred_0.9-14           xfun_0.39              timechange_0.2.0       randomForest_4.7-1.1  
 [37] R6_2.5.1               doParallel_1.0.17      clue_0.3-64            rex_1.2.1             
 [41] bitops_1.0-7           spatstat.utils_3.0-2   promises_1.2.0.1       scales_1.2.1          
 [45] nnet_7.3-17            gtable_0.3.3           globals_0.16.2         processx_3.8.1        
 [49] goftest_1.2-3          timeDate_4022.108      rlang_1.1.0            cyclocomp_1.1.0       
 [53] GlobalOptions_0.1.2    splines_4.1.3          rstatix_0.7.2          lazyeval_0.2.2        
 [57] ModelMetrics_1.2.2.2   broom_1.0.4            spatstat.geom_3.1-0    checkmate_2.1.0       
 [61] reshape2_1.4.4         abind_1.4-5            backports_1.4.1        httpuv_1.6.9          
 [65] Hmisc_5.0-1            caret_6.0-94           DiagrammeR_1.0.9       tools_4.1.3           
 [69] lava_1.7.2.1           ellipsis_0.3.2         RColorBrewer_1.1-3     proxy_0.4-27          
 [73] BiocGenerics_0.40.0    ggridges_0.5.4         Rcpp_1.0.10            plyr_1.8.8            
 [77] base64enc_0.1-3        visNetwork_2.1.2       ps_1.7.5               ggpubr_0.6.0          
 [81] rpart_4.1.16           deldir_1.0-6           pbapply_1.7-0          GetoptLong_1.0.5      
 [85] cowplot_1.1.1          S4Vectors_0.32.4       zoo_1.8-12             ggrepel_0.9.3         
 [89] cluster_2.1.2          magrittr_2.0.3         data.table_1.14.8      scattermore_0.8       
 [93] circlize_0.4.15        lmtest_0.9-40          RANN_2.6.1             fitdistrplus_1.1-11   
 [97] R.cache_0.16.0         matrixStats_0.63.0     hms_1.1.3              patchwork_1.1.2       
[101] mime_0.12              evaluate_0.20          xtable_1.8-4           IRanges_2.28.0        
[105] gridExtra_2.3          shape_1.4.6            compiler_4.1.3         KernSmooth_2.23-20    
[109] crayon_1.5.2           R.oo_1.25.0            htmltools_0.5.5        later_1.3.0           
[113] tzdb_0.3.0             Formula_1.2-5          ComplexHeatmap_2.10.0  MASS_7.3-55           
[117] car_3.1-2              Matrix_1.5-4           cli_3.6.1              R.methodsS3_1.8.2     
[121] parallel_4.1.3         gower_1.0.1            igraph_1.4.2           pkgconfig_2.0.3       
[125] foreign_0.8-82         sp_1.6-0               plotly_4.10.1          spatstat.sparse_3.0-1 
[129] recipes_1.0.6          xml2_1.3.3             foreach_1.5.2          hardhat_1.3.0         
[133] prodlim_2023.03.31     callr_3.7.3            digest_0.6.31          sctransform_0.3.5.9002
[137] RcppAnnoy_0.0.20       spatstat.data_3.0-1    rmarkdown_2.21         leiden_0.4.3          
[141] htmlTable_2.4.1        uwot_0.1.14            shiny_1.7.4            rjson_0.2.21          
[145] lifecycle_1.0.3        nlme_3.1-155           jsonlite_1.8.4         carData_3.0-5         
[149] desc_1.4.2             viridisLite_0.4.1      limma_3.50.3           fansi_1.0.4           
[153] pillar_1.9.0           lattice_0.20-45        fastmap_1.1.1          httr_1.4.5            
[157] survival_3.3-1         remotes_2.4.2          glue_1.6.2             fdrtool_1.2.17        
[161] png_0.1-8              iterators_1.0.14       class_7.3-20           stringi_1.7.12        
[165] caTools_1.18.2         irlba_2.3.5.1          e1071_1.7-13           future.apply_1.10.0

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: < 5 minutes
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "ccc",
  "03_nichenet_prioritization_plots.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "ccc",
  "03_nichenet_prioritization_plots.Rmd"
))
```


####### MultiNicheNet plotting code -- NEEDS EDITING #######
# Visualization
```{r}
prioritized_tbl_oi_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, rank_per_group = FALSE)

prioritized_tbl_oi = multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  filter(id %in% prioritized_tbl_oi_all$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% left_join(prioritized_tbl_oi_all)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique()) %>% sort()

colors_sender = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)
colors_receiver = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)

circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver)
```

# Visualize interactions in AD
```{r}
group_oi <- "AD"

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad.png", width = 1000, height = 800)
plot_oi
dev.off()



prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi, receivers_oi = "Excitatory.Neurons")

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad_ex.png", width = 1000, height = 800)
plot_oi
dev.off()

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi, receivers_oi = "Inhibitory.Neurons")

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad_in.png", width = 1000, height = 800)
plot_oi
dev.off()


# correct senders and receievrs
prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi, receivers_oi = c("Inhibitory.Neurons", "Excitatory.Neurons"), senders_oi = c("Astrocytes", "Oligodendrocytes", "Microglia", "OPCs"))

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad_all.png", width = 1000, height = 800)
plot_oi
dev.off()
```

# Visualization of ligand activity
```{r}
group_oi = "AD"
receiver_oi = "Excitatory.Neurons"
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_M_10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
pdf("combined_plot_ex.pdf", width = 20, height = 10)
combined_plot
dev.off()

receiver_oi = "Inhibitory.Neurons"
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_M_10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
pdf("combined_plot_in.pdf", width = 20, height = 10)
combined_plot
dev.off()
```

# Visualization of expr-correlated target genes of ligand-receptor pairs
```{r}
group_oi = "AD"
receiver_oi = "Excitatory.Neurons"

lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>%
  inner_join(ligand_activities_targets_DEgenes$ligand_activities %>%
               distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl) %>%
  filter(group == group_oi, receiver == receiver_oi)

lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "up") %>%
  filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))

lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "down") %>%
  filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50)) # downregulation -- negative correlation

lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)

prioritized_tbl_oi = get_top_n_lr_pairs(prioritization_tables, 50, groups_oi = group_oi, receivers_oi = receiver_oi)

lr_target_prior_cor_heatmap = make_lr_target_prior_cor_heatmap(lr_target_prior_cor_filtered_up %>% filter(receiver == receiver_oi & id %in% prioritized_tbl_oi$id), add_grid = TRUE)


lr_target_prior_cor_heatmap2 = make_lr_target_prior_cor_heatmap(lr_target_prior_cor_filtered_down %>% filter(receiver == receiver_oi & id %in% prioritized_tbl_oi$id), add_grid = TRUE)


#png("up_exprs_ligand_act_heatmap.png", width = 1000, height = 800)
lr_target_prior_cor_heatmap
#dev.off()

#png("down_exprs_ligand_act_heatmap.png", width = 1000, height = 800)
lr_target_prior_cor_heatmap2
#dev.off()
```

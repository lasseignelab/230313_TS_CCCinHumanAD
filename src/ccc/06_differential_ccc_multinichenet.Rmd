---
title: "06_differential_ccc_multinichenet"
author: "Tabea M. Soelter"
date: '2023-07-19'
output: html_document
---

# load packages
```{r}
library(nichenetr)
library(multinichenetr)
library(SingleCellExperiment)
library(tidyverse)
library(Seurat)
library(here)

set.seed(42)
```

# NicheNet-v2 prior
* downloaded here: https://zenodo.org/record/7074291
```{r}
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_v2_prior",
  "lr_network_human_21122021.rds")) %>% 
  dplyr::rename(ligand = from, receptor = to) %>% 
  distinct(ligand, receptor) %>%
  mutate(ligand = make.names(ligand), receptor = make.names(receptor))

ligand_target_matrix <- readRDS(here(
  "data",
  "ccc",
  "nichenet_v2_prior",
  "ligand_target_matrix_nsga2r_final.rds"))

colnames(ligand_target_matrix) = colnames(ligand_target_matrix) %>% make.names()
rownames(ligand_target_matrix) = rownames(ligand_target_matrix) %>% make.names()
```

# Load seurat object
```{r}
gse_object <- readRDS(here(
  "data",
  "seurat_preprocessing",
  "gse_processed_seurat.rds"))
```

# Convert seurat object
```{r}
gse <- Seurat::as.SingleCellExperiment(gse_object, assay = "RNA")

gse <- alias_to_symbol_SCE(gse, "human") %>% makenames_SCE()
```

check the number of cells per cell type condition combination and number of patients per condition
```{r}
table(SummarizedExperiment::colData(gse)$ident, SummarizedExperiment::colData(gse)$sample)

table(SummarizedExperiment::colData(gse)$ident, SummarizedExperiment::colData(gse)$orig.ident) # cell types vs conditions
```

# make all names syntactically valid
```{r}
SummarizedExperiment::colData(gse)$ident <- SummarizedExperiment::colData(gse)$ident %>% make.names()
SummarizedExperiment::colData(gse)$orig.ident <- SummarizedExperiment::colData(gse)$orig.ident %>% make.names()
SummarizedExperiment::colData(gse)$sample <- SummarizedExperiment::colData(gse)$sample %>% make.names()
```

# prepare NicheNet settings
```{r}
sample_id = "sample"
group_id = "orig.ident"
celltype_id = "ident"
covariates = NA
batches = NA

senders_oi = SummarizedExperiment::colData(gse)[,celltype_id] %>% unique()
receivers_oi = SummarizedExperiment::colData(gse)[,celltype_id] %>% unique()

gse = gse[, SummarizedExperiment::colData(gse)[,celltype_id] %in% c(senders_oi, receivers_oi)]
```

# Step 1
```{r}
min_cells = 10

abundance_expression_info = get_abundance_expression_info(sce = gse, sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, min_cells = min_cells, senders_oi = senders_oi, receivers_oi = receivers_oi, lr_network = lr_network, batches = batches)

abundance_expression_info$abund_plot_sample
abundance_expression_info$abund_plot_group

```

# Step 2
```{r}
contrasts_oi <- c("'AD-CTRL','CTRL-AD'")

contrast_tbl <- tibble(contrast = c("AD-CTRL", "CTRL-AD"),
                       group = c("AD", "CTRL"))

DE_info = get_DE_info(sce = gse, sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, batches = batches, covariates = covariates, contrasts_oi = contrasts_oi, min_cells = min_cells)

DE_info$celltype_de$de_output_tidy %>% arrange(p_adj) %>% head()
```

```{r}
empirical_pval = TRUE
if(empirical_pval == TRUE){
  DE_info_emp = get_empirical_pvals(DE_info$celltype_de$de_output_tidy)
} 

DE_info$hist_pvals
DE_info_emp$hist_pvals_emp
```

```{r}
empirical_pval = FALSE
if(empirical_pval == FALSE){
  celltype_de = DE_info$celltype_de$de_output_tidy
} else {
  celltype_de = DE_info_emp$de_output_tidy_emp %>% dplyr::select(-p_val, -p_adj) %>% dplyr::rename(p_val = p_emp, p_adj = p_adj_emp)
}

sender_receiver_de = combine_sender_receiver_de(
  sender_de = celltype_de,
  receiver_de = celltype_de,
  senders_oi = senders_oi,
  receivers_oi = receivers_oi,
  lr_network = lr_network
)

sender_receiver_de %>% head(20)
```

# Step 3
```{r}
logFC_threshold = 0.50
p_val_threshold = 0.05
fraction_cutoff = 0.05
p_val_adj = FALSE
top_n_target = 250
verbose = TRUE
cores_system = 8
n.cores = min(cores_system, sender_receiver_de$receiver %>% unique() %>% length()) # use one core per receiver cell type

ligand_activities_targets_DEgenes = suppressMessages(suppressWarnings(get_ligand_activities_targets_DEgenes(
  receiver_de = celltype_de,
  receivers_oi = receivers_oi,
  ligand_target_matrix = ligand_target_matrix,
  logFC_threshold = logFC_threshold,
  p_val_threshold = p_val_threshold,
  p_val_adj = p_val_adj,
  top_n_target = top_n_target,
  verbose = verbose, 
  n.cores = n.cores
)))

ligand_activities_targets_DEgenes$de_genes_df %>% head(20)
ligand_activities_targets_DEgenes$ligand_activities %>% head(20)
```

# Define prioritization weights
```{r}
prioritizing_weights_DE = c("de_ligand" = 1,
                         "de_receptor" = 1)
prioritizing_weights_activity = c("activity_scaled" = 2)

prioritizing_weights_expression_specificity = c("exprs_ligand" = 2,
                         "exprs_receptor" = 2)

prioritizing_weights_expression_sufficiency = c("frac_exprs_ligand_receptor" = 1)

prioritizing_weights_relative_abundance = c( "abund_sender" = 0,
                         "abund_receiver" = 0)

prioritizing_weights = c(prioritizing_weights_DE, 
                         prioritizing_weights_activity, 
                         prioritizing_weights_expression_specificity,
                         prioritizing_weights_expression_sufficiency, 
                         prioritizing_weights_relative_abundance)

sender_receiver_tbl = sender_receiver_de %>% dplyr::distinct(sender, receiver)

metadata_combined = SummarizedExperiment::colData(geo) %>% tibble::as_tibble()

if(!is.na(batches)){
  grouping_tbl = metadata_combined[,c(sample_id, group_id, batches)] %>% tibble::as_tibble() %>% dplyr::distinct()
  colnames(grouping_tbl) = c("sample","group",batches)
} else {
  grouping_tbl = metadata_combined[,c(sample_id, group_id)] %>% tibble::as_tibble() %>% dplyr::distinct()
  colnames(grouping_tbl) = c("sample","group")
}

prioritization_tables = suppressMessages(generate_prioritization_tables(
  sender_receiver_info = abundance_expression_info$sender_receiver_info,
  sender_receiver_de = sender_receiver_de,
  ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
  contrast_tbl = contrast_tbl,
  sender_receiver_tbl = sender_receiver_tbl,
  grouping_tbl = grouping_tbl,
  prioritizing_weights = prioritizing_weights,
  fraction_cutoff = fraction_cutoff, 
  abundance_data_receiver = abundance_expression_info$abundance_data_receiver,
  abundance_data_sender = abundance_expression_info$abundance_data_sender
))

prioritization_tables$group_prioritization_tbl %>% head(20)
prioritization_tables$sample_prioritization_tbl %>% head(20)
```

# Step 5
```{r}
lr_target_prior_cor = lr_target_prior_cor_inference(prioritization_tables$group_prioritization_tbl$receiver %>% unique(), abundance_expression_info, celltype_de, grouping_tbl, prioritization_tables, ligand_target_matrix, logFC_threshold = logFC_threshold, p_val_threshold = p_val_threshold, p_val_adj = p_val_adj)

path = "./"

multinichenet_output = list(
    celltype_info = abundance_expression_info$celltype_info,
    celltype_de = celltype_de,
    sender_receiver_info = abundance_expression_info$sender_receiver_info,
    sender_receiver_de =  sender_receiver_de,
    ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
    prioritization_tables = prioritization_tables,
    grouping_tbl = grouping_tbl,
    lr_target_prior_cor = lr_target_prior_cor
  ) 
multinichenet_output_lite = make_lite_output(multinichenet_output)

save = FALSE
if(save == TRUE){
  saveRDS(multinichenet_output, paste0(path, "multinichenet_output.rds"))

}
```

# Visualization
```{r}
prioritized_tbl_oi_all = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, rank_per_group = FALSE)

prioritized_tbl_oi = multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  filter(id %in% prioritized_tbl_oi_all$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% left_join(prioritized_tbl_oi_all)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique()) %>% sort()

colors_sender = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)
colors_receiver = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)

circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver)
```

# Visualize interactions in AD
```{r}
group_oi <- "AD"

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi)

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad.png", width = 1000, height = 800)
plot_oi
dev.off()



prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi, receivers_oi = "Excitatory.Neurons")

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad_ex.png", width = 1000, height = 800)
plot_oi
dev.off()

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi, receivers_oi = "Inhibitory.Neurons")

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad_in.png", width = 1000, height = 800)
plot_oi
dev.off()


# correct senders and receievrs
prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 50, groups_oi = group_oi, receivers_oi = c("Inhibitory.Neurons", "Excitatory.Neurons"), senders_oi = c("Astrocytes", "Oligodendrocytes", "Microglia", "OPCs"))

plot_oi = make_sample_lr_prod_activity_plots(multinichenet_output$prioritization_tables, prioritized_tbl_oi_M_50)
png("plot_oi_ad_all.png", width = 1000, height = 800)
plot_oi
dev.off()
```

# Visualization of ligand activity
```{r}
group_oi = "AD"
receiver_oi = "Excitatory.Neurons"
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_M_10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
pdf("combined_plot_ex.pdf", width = 20, height = 10)
combined_plot
dev.off()

receiver_oi = "Inhibitory.Neurons"
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(multinichenet_output$prioritization_tables, 10, groups_oi = group_oi, receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(group_oi, receiver_oi, prioritized_tbl_oi_M_10, multinichenet_output$prioritization_tables, multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, multinichenet_output$grouping_tbl, multinichenet_output$celltype_info, ligand_target_matrix, plot_legend = FALSE)
pdf("combined_plot_in.pdf", width = 20, height = 10)
combined_plot
dev.off()
```

# Visualization of expr-correlated target genes of ligand-receptor pairs
```{r}
group_oi = "AD"
receiver_oi = "Excitatory.Neurons"

lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>%
  inner_join(ligand_activities_targets_DEgenes$ligand_activities %>%
               distinct(ligand, target, direction_regulation, contrast)) %>%
  inner_join(contrast_tbl) %>%
  filter(group == group_oi, receiver == receiver_oi)

lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "up") %>%
  filter( (rank_of_target < top_n_target) & (pearson > 0.50 | spearman > 0.50))

lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>%
  filter(direction_regulation == "down") %>%
  filter( (rank_of_target < top_n_target) & (pearson < -0.50 | spearman < -0.50)) # downregulation -- negative correlation

lr_target_prior_cor_filtered = bind_rows(lr_target_prior_cor_filtered_up, lr_target_prior_cor_filtered_down)

prioritized_tbl_oi = get_top_n_lr_pairs(prioritization_tables, 50, groups_oi = group_oi, receivers_oi = receiver_oi)

lr_target_prior_cor_heatmap = make_lr_target_prior_cor_heatmap(lr_target_prior_cor_filtered_up %>% filter(receiver == receiver_oi & id %in% prioritized_tbl_oi$id), add_grid = TRUE)


lr_target_prior_cor_heatmap2 = make_lr_target_prior_cor_heatmap(lr_target_prior_cor_filtered_down %>% filter(receiver == receiver_oi & id %in% prioritized_tbl_oi$id), add_grid = TRUE)


png("up_exprs_ligand_act_heatmap.png", width = 1000, height = 800)
lr_target_prior_cor_heatmap
dev.off()

png("down_exprs_ligand_act_heatmap.png", width = 1000, height = 800)
lr_target_prior_cor_heatmap2
dev.off()
```


```{r}
saveRDS(multinichenet_output, here("data", "ccc", "gse_multinichenet_output.rds"))
```














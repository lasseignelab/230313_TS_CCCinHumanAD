---
title: "04_dataset_comparisons"
author: "Tabea M. Soelter"
date: '2023-05-24'
output: html_document
---
**Plotting Differential Cell-Cell Communication Results**

__Goal__: Prioritize ligands, receptors, and target genes, then plot them for each dataset.
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.1 
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU

__Data__: 
*NicheNet outputs*
* Name: nichenet_output.rds
* Location: results/intermediate_outputs/geo/ccc/, results/intermediate_outputs/vine/ccc/, results/intermediate_outputs/vine_cortex/ccc/
 
__Analysis Plan__: 
* Load necessary packages 
* Load data
  * NicheNet outputs
* Prioritize outputs
  * Using prioritization weights
* Generate plots
* Save plots

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(nichenetr)
  library(Seurat)
  library(here)
  library(styler)
  library(lintr)
})

# load functions
source(here("src", "functions_CCCinAD_tms.R"))
```

# Comparisons  - **CLEAN THIS UP APPROPRIATELY** I now also have 2 receiver cell types!!
* Since we are using 2 cortex datasets which include different patients, we are interested in the overlap between these 2 datasets. 
* I am also comparing the hippocampal dataset to the cortex datasets to further investigate that overlap as well.
```{r}
# load package
library(UpSetR)


geo_ligands <- geo_prioritization_tbl$prioritization_tbl_ligand_target$ligand %>% unique()
vine_ligands <- vine_prioritization_tbl$prioritization_tbl_ligand_target$ligand %>% unique()
vine_cortex_ligands <- vine_cortex_prioritization_tbl$prioritization_tbl_ligand_target$ligand %>% unique()

n <- max(length(geo_ligands), length(vine_ligands), length(vine_cortex_ligands))
length(geo_ligands) <- n                      
length(vine_ligands) <- n
length(vine_cortex_ligands) <- n

ligands <- data.frame(geo_ligands, vine_ligands, vine_cortex_ligands)



ligands_ls <- as.list(ligands) 

ligands_lst <- lapply(ligands_ls, function(x) x[!is.na(x)])

ligands_upset <- upset(fromList(ligands_lst),
                       sets = c("geo_ligands", "vine_ligands", "vine_cortex_ligands"),
                       order.by = "freq")
  
  
# ---------------------------------------------------------------------

geo_receptors <- geo_prioritization_tbl$prioritization_tbl_ligand_target$receptor %>% unique()
vine_receptors <- vine_prioritization_tbl$prioritization_tbl_ligand_target$receptor %>% unique()
vine_cortex_receptors <- vine_cortex_prioritization_tbl$prioritization_tbl_ligand_target$receptor %>% unique()

n <- max(length(geo_receptors), length(vine_receptors), length(vine_cortex_receptors))
length(geo_receptors) <- n
length(vine_receptors) <- n
length(vine_cortex_receptors) <- n

receptors <- data.frame(geo_receptors, vine_receptors, vine_cortex_receptors)

receptors_ls <- as.list(receptors) 

receptors_lst <- lapply(receptors_ls, function(x) x[!is.na(x)])

receptors_upset <- upset(fromList(receptors_lst),
      sets = c("geo_receptors", "vine_receptors", "vine_cortex_receptors"),
      order.by = "freq")

# -------------------------------------------------------------------

geo_targets <- geo_prioritization_tbl$prioritization_tbl_ligand_target$target %>% unique()
vine_targets <- vine_prioritization_tbl$prioritization_tbl_ligand_target$target %>% unique()
vine_cortex_targets <- vine_cortex_prioritization_tbl$prioritization_tbl_ligand_target$target %>% unique()

n <- max(length(geo_targets), length(vine_targets), length(vine_cortex_targets))
length(geo_targets) <- n
length(vine_targets) <- n
length(vine_cortex_targets) <- n

targets <- data.frame(geo_targets, vine_targets, vine_cortex_targets)

targets_ls <- as.list(targets) 

targets_lst <- lapply(targets_ls, function(x) x[!is.na(x)])

targets_upset <- upset(fromList(targets_lst),
      sets = c("geo_targets", "vine_targets", "vine_cortex_targets"),
      order.by = "freq")


# plot all upset plots 
pdf(file = here(
  "results",
  "intermediate_outputs",
  "comparisons",
  "ccc",
  "ligand_receptor_target_upset.pdf"
  ), width = 12, height = 8)
ligands_upset
receptors_upset
targets_upset
dev.off()

# compare only cortex data
ligands_cortex_upset <- upset(fromList(ligands_lst),
                       sets = c("geo_ligands", "vine_cortex_ligands"),
                       order.by = "freq")

receptors_cortex_upset <- upset(fromList(receptors_lst),
      sets = c("geo_receptors", "vine_cortex_receptors"),
      order.by = "freq")

targets_cortex_upset <- upset(fromList(targets_lst),
      sets = c("geo_targets", "vine_cortex_targets"),
      order.by = "freq")


pdf(file = here(
  "results",
  "intermediate_outputs",
  "comparisons",
  "ccc",
  "ligand_receptor_target_cortex_upset.pdf"
  ), width = 12, height = 8)

ligands_cortex_upset
receptors_cortex_upset
targets_cortex_upset

dev.off()

# pull out the ones that are 
```


# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2        styler_1.9.1       here_1.0.1         SeuratObject_4.1.3 Seurat_4.3.0.9002 
 [6] nichenetr_1.1.1    lubridate_1.9.2    forcats_1.0.0      stringr_1.5.0      dplyr_1.1.2       
[11] purrr_1.0.1        readr_2.1.4        tidyr_1.3.0        tibble_3.2.1       ggplot2_3.4.2     
[16] tidyverse_2.0.0   

loaded via a namespace (and not attached):
  [1] utf8_1.2.3             spatstat.explore_3.1-0 reticulate_1.28        R.utils_2.12.2        
  [5] tidyselect_1.2.0       htmlwidgets_1.6.2      grid_4.1.3             Rtsne_0.16            
  [9] pROC_1.18.0            munsell_0.5.0          codetools_0.2-18       ica_1.0-3             
 [13] future_1.32.0          miniUI_0.1.1.1         withr_2.5.0            spatstat.random_3.1-4 
 [17] colorspace_2.1-0       progressr_0.13.0       knitr_1.42             rstudioapi_0.14       
 [21] stats4_4.1.3           ROCR_1.0-11            ggsignif_0.6.4         tensor_1.5            
 [25] listenv_0.9.0          labeling_0.4.2         polyclip_1.10-4        farver_2.1.1          
 [29] rprojroot_2.0.3        parallelly_1.35.0      vctrs_0.6.2            generics_0.1.3        
 [33] ipred_0.9-14           xfun_0.39              timechange_0.2.0       randomForest_4.7-1.1  
 [37] R6_2.5.1               doParallel_1.0.17      clue_0.3-64            rex_1.2.1             
 [41] bitops_1.0-7           spatstat.utils_3.0-2   promises_1.2.0.1       scales_1.2.1          
 [45] nnet_7.3-17            gtable_0.3.3           globals_0.16.2         processx_3.8.1        
 [49] goftest_1.2-3          timeDate_4022.108      rlang_1.1.0            cyclocomp_1.1.0       
 [53] GlobalOptions_0.1.2    splines_4.1.3          rstatix_0.7.2          lazyeval_0.2.2        
 [57] ModelMetrics_1.2.2.2   broom_1.0.4            spatstat.geom_3.1-0    checkmate_2.1.0       
 [61] reshape2_1.4.4         abind_1.4-5            backports_1.4.1        httpuv_1.6.9          
 [65] Hmisc_5.0-1            caret_6.0-94           DiagrammeR_1.0.9       tools_4.1.3           
 [69] lava_1.7.2.1           ellipsis_0.3.2         RColorBrewer_1.1-3     proxy_0.4-27          
 [73] BiocGenerics_0.40.0    ggridges_0.5.4         Rcpp_1.0.10            plyr_1.8.8            
 [77] base64enc_0.1-3        visNetwork_2.1.2       ps_1.7.5               ggpubr_0.6.0          
 [81] rpart_4.1.16           deldir_1.0-6           pbapply_1.7-0          GetoptLong_1.0.5      
 [85] cowplot_1.1.1          S4Vectors_0.32.4       zoo_1.8-12             ggrepel_0.9.3         
 [89] cluster_2.1.2          magrittr_2.0.3         data.table_1.14.8      scattermore_0.8       
 [93] circlize_0.4.15        lmtest_0.9-40          RANN_2.6.1             fitdistrplus_1.1-11   
 [97] R.cache_0.16.0         matrixStats_0.63.0     hms_1.1.3              patchwork_1.1.2       
[101] mime_0.12              evaluate_0.20          xtable_1.8-4           IRanges_2.28.0        
[105] gridExtra_2.3          shape_1.4.6            compiler_4.1.3         KernSmooth_2.23-20    
[109] crayon_1.5.2           R.oo_1.25.0            htmltools_0.5.5        later_1.3.0           
[113] tzdb_0.3.0             Formula_1.2-5          ComplexHeatmap_2.10.0  MASS_7.3-55           
[117] car_3.1-2              Matrix_1.5-4           cli_3.6.1              R.methodsS3_1.8.2     
[121] parallel_4.1.3         gower_1.0.1            igraph_1.4.2           pkgconfig_2.0.3       
[125] foreign_0.8-82         sp_1.6-0               plotly_4.10.1          spatstat.sparse_3.0-1 
[129] recipes_1.0.6          xml2_1.3.3             foreach_1.5.2          hardhat_1.3.0         
[133] prodlim_2023.03.31     callr_3.7.3            digest_0.6.31          sctransform_0.3.5.9002
[137] RcppAnnoy_0.0.20       spatstat.data_3.0-1    rmarkdown_2.21         leiden_0.4.3          
[141] htmlTable_2.4.1        uwot_0.1.14            shiny_1.7.4            rjson_0.2.21          
[145] lifecycle_1.0.3        nlme_3.1-155           jsonlite_1.8.4         carData_3.0-5         
[149] desc_1.4.2             viridisLite_0.4.1      limma_3.50.3           fansi_1.0.4           
[153] pillar_1.9.0           lattice_0.20-45        fastmap_1.1.1          httr_1.4.5            
[157] survival_3.3-1         remotes_2.4.2          glue_1.6.2             fdrtool_1.2.17        
[161] png_0.1-8              iterators_1.0.14       class_7.3-20           stringi_1.7.12        
[165] caTools_1.18.2         irlba_2.3.5.1          e1071_1.7-13           future.apply_1.10.0

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: < 5 minutes
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "ccc",
  "04_dataset_comparisons.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "ccc",
  "04_dataset_comparisons.Rmd"
))
```
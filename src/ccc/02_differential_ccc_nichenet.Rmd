---
title: "02_differential_ccc_nichenet"
author: "Tabea M. Soelter"
date: '2023-04-25'
output: html_document
---
**Differential Cell-Cell Communication Analysis using NicheNet**

__Goal__: For every dataset, perform differential NicheNet analyses between AD and CTRL to identify ligands, receptors, and potential downstream target genes between glia (Astrocytes, Oligodendrocytes, Microglia, and OPCs - senders) and Excitatory/Inhibitory Neurons (receivers).
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.1 
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU

__Data__: 
*Seurat objects*
* Name: vine_processed_seurat.rds, geo_processed_seurat.rds, vinecortex_processed_seurat.rds
* Location: data/
*LIANA ligands*
* Name: liana_ligands.rds
* Location: results/intermediate_outputs/geo/ccc/, results/intermediate_outputs/vine/ccc/, results/intermediate_outputs/vine_cortex/ccc/
 
__Analysis Plan__: 
* Load necessary packages 
* Load data
  * Seurat objects
  * LIANA ligands
* Load and filter NicheNet prior
* Prepare for NicheNet
  * Split objects by condition
  * Create celltype_aggregate column
* Define niches of interest
* Differential NicheNet
  * Save output using wrapper

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# set seed
set.seed(42)

# load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(nichenetr)
  library(Seurat)
  library(ggrepel)
  library(cowplot)
  library(RColorBrewer)
  library(here)
  library(styler)
  library(lintr)
})

# load functions
source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
# load all seurat objects
vine <- readRDS(here("data", "vine_processed_seurat.rds"))

geo <- readRDS(here("data", "geo_processed_seurat.rds"))

vine_cortex <- readRDS(here("data", "vinecortex_processed_seurat.rds"))

# create a list of all objects
object_list <- tibble::lst(vine, geo, vine_cortex)

# load liana ligands
vine_ligands <- readRDS(here(
  "results",
  "intermediate_outputs",
  "vine",
  "ccc",
  "liana_ligands.rds"
))

geo_ligands <- readRDS(here(
  "results",
  "intermediate_outputs",
  "geo",
  "ccc",
  "liana_ligands.rds"
))

vine_cortex_ligands <- readRDS(here(
  "results",
  "intermediate_outputs",
  "vine_cortex",
  "ccc",
  "liana_ligands.rds"
))
```

# Load NicheNet prior
```{r}
# load the ligand target matrix
ligand_target_matrix <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "ligand_target_matrix.rds"
))

# load and filter the ligand receptor network as recommended by developers
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_prior",
  "lr_network.rds"
)) %>%
  mutate(bonafide = !database %in% c("ppi_prediction", "ppi_prediction_go")) %>%
  dplyr::rename(ligand = from, receptor = to) %>%
  distinct(ligand, receptor, bonafide)

# set organism
organism <- "human"
```

# Split objects by condition
* Each individual object and cluster within needs to be split by condition in order to apply NicheNet across conditions.
* I have added a metadata column with that information and made it the identity of the object.
* I am also plotting UMAPs of the split and saving them to results/intermediate_outputs/{object_name}/ccc/
* This is done for each object in the split_object_list
```{r warning=FALSE}
# Making cell-type aggregate object list and save celltype aggregate UMAPs
ca_object_list <- prep_nichenet(object_list,
  file_path = "results/intermediate_outputs/"
)

# unlist and add objects to global environment for downstream use
list2env(ca_object_list, globalenv())
```

# Define niches - Excitatory Neurons
* Since I am interested in differences across conditions, my niches are AD and CTRL. 
* Within each niche, the sender and receiver cell types are also specified. 
```{r}
## Set niches
user_niches <- list(
  "AD_niche" = list(
    "sender" = c(
      "Astrocytes_AD",
      "Oligodendrocytes_AD",
      "OPCs_AD",
      "Microglia_AD"
    ),
    "receiver" = c("Excitatory Neurons_AD")
  ),
  "CTRL_niche" = list(
    "sender" = c(
      "Astrocytes_CTRL",
      "Oligodendrocytes_CTRL",
      "OPCs_CTRL",
      "Microglia_CTRL"
    ),
    "receiver" = c("Excitatory Neurons_CTRL")
  )
)
```

# Differential NicheNet - Excitatory Neurons
* Ligand-receptor and target identification
* The resulting object ("output") gets saved to results/intermediate_outputs/{dataset}/ccc/
* Output include all identified ligands, receptors, and target genes across conditions and between sender and receiver cell types.
* I also use ligands identified by liana in 01_ligand_prioritization_liana.Rmd to filter NicheNet inputs to only include ligands identified by 2 methods.
```{r}
# vine
nichenet_wrapper(vine,
  user_niches = user_niches,
  lr_network = lr_network,
  ligands = vine_ligands,
  file_path = "results/intermediate_outputs/vine/ccc/",
  file_name = "ex_neurons_nichenet_output.rds"
)

# geo
nichenet_wrapper(geo,
  user_niches = user_niches,
  lr_network = lr_network,
  ligands = geo_ligands,
  file_path = "results/intermediate_outputs/geo/ccc/",
  file_name = "ex_neurons_nichenet_output.rds"
)

# vine_cortex
nichenet_wrapper(vine_cortex,
  user_niches = user_niches,
  lr_network = lr_network,
  ligands = vine_cortex_ligands,
  file_path = "results/intermediate_outputs/vine_cortex/ccc/",
  file_name = "ex_neurons_nichenet_output.rds"
)
```

# Define niches - Inhibitory Neurons
```{r}
user_niches <- list(
  "AD_niche" = list(
    "sender" = c(
      "Astrocytes_AD",
      "Oligodendrocytes_AD",
      "OPCs_AD",
      "Microglia_AD"
    ),
    "receiver" = c("Inhibitory Neurons_AD")
  ),
  "CTRL_niche" = list(
    "sender" = c(
      "Astrocytes_CTRL",
      "Oligodendrocytes_CTRL",
      "OPCs_CTRL",
      "Microglia_CTRL"
    ),
    "receiver" = c("Inhibitory Neurons_CTRL")
  )
)
```

# Differential NicheNet - Inhibitory Neurons
```{r}
# vine
nichenet_wrapper(vine,
  user_niches = user_niches,
  lr_network = lr_network,
  ligands = vine_ligands,
  file_path = "results/intermediate_outputs/vine/ccc/",
  file_name = "in_neurons_nichenet_output.rds"
)

# geo
nichenet_wrapper(geo,
  user_niches = user_niches,
  lr_network = lr_network,
  ligands = geo_ligands,
  file_path = "results/intermediate_outputs/geo/ccc/",
  file_name = "in_neurons_nichenet_output.rds"
)

# vine_cortex
nichenet_wrapper(vine_cortex,
  user_niches = user_niches,
  lr_network = lr_network,
  ligands = vine_cortex_ligands,
  file_path = "results/intermediate_outputs/vine_cortex/ccc/",
  file_name = "in_neurons_nichenet_output.rds"
)
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] RColorBrewer_1.1-3 cowplot_1.1.1      ggrepel_0.9.3      nichenetr_1.1.1   
 [5] lintr_3.0.2        styler_1.9.1       here_1.0.1         scCustomize_1.1.1 
 [9] clustree_0.5.0     ggraph_2.1.0       harmony_0.1.0      Rcpp_1.0.10       
[13] lubridate_1.9.2    forcats_1.0.0      stringr_1.5.0      dplyr_1.1.2       
[17] purrr_1.0.1        readr_2.1.4        tidyr_1.3.0        tibble_3.2.1      
[21] ggplot2_3.4.2      tidyverse_2.0.0    SeuratObject_4.1.3 Seurat_4.3.0.9002 

loaded via a namespace (and not attached):
  [1] utf8_1.2.3             spatstat.explore_3.1-0 reticulate_1.28       
  [4] R.utils_2.12.2         tidyselect_1.2.0       htmlwidgets_1.6.2     
  [7] grid_4.1.3             Rtsne_0.16             pROC_1.18.0           
 [10] munsell_0.5.0          ragg_1.2.5             codetools_0.2-18      
 [13] ica_1.0-3              future_1.32.0          miniUI_0.1.1.1        
 [16] withr_2.5.0            spatstat.random_3.1-4  colorspace_2.1-0      
 [19] progressr_0.13.0       knitr_1.42             rstudioapi_0.14       
 [22] stats4_4.1.3           ROCR_1.0-11            tensor_1.5            
 [25] listenv_0.9.0          labeling_0.4.2         polyclip_1.10-4       
 [28] farver_2.1.1           rprojroot_2.0.3        parallelly_1.35.0     
 [31] vctrs_0.6.2            generics_0.1.3         ipred_0.9-14          
 [34] xfun_0.39              timechange_0.2.0       randomForest_4.7-1.1  
 [37] doParallel_1.0.17      R6_2.5.1               clue_0.3-64           
 [40] ggbeeswarm_0.7.1       graphlayouts_0.8.4     rex_1.2.1             
 [43] bitops_1.0-7           spatstat.utils_3.0-2   promises_1.2.0.1      
 [46] scales_1.2.1           nnet_7.3-17            beeswarm_0.4.0        
 [49] gtable_0.3.3           globals_0.16.2         processx_3.8.1        
 [52] goftest_1.2-3          tidygraph_1.2.3        timeDate_4022.108     
 [55] rlang_1.1.0            cyclocomp_1.1.0        systemfonts_1.0.4     
 [58] GlobalOptions_0.1.2    splines_4.1.3          lazyeval_0.2.2        
 [61] ModelMetrics_1.2.2.2   checkmate_2.1.0        spatstat.geom_3.1-0   
 [64] yaml_2.3.7             reshape2_1.4.4         abind_1.4-5           
 [67] backports_1.4.1        httpuv_1.6.9           Hmisc_5.0-1           
 [70] DiagrammeR_1.0.9       caret_6.0-94           lava_1.7.2.1          
 [73] tools_4.1.3            ellipsis_0.3.2         BiocGenerics_0.40.0   
 [76] proxy_0.4-27           ggridges_0.5.4         plyr_1.8.8            
 [79] base64enc_0.1-3        visNetwork_2.1.2       ps_1.7.5              
 [82] rpart_4.1.16           deldir_1.0-6           GetoptLong_1.0.5      
 [85] pbapply_1.7-0          viridis_0.6.2          S4Vectors_0.32.4      
 [88] zoo_1.8-12             cluster_2.1.2          magrittr_2.0.3        
 [91] data.table_1.14.8      scattermore_0.8        circlize_0.4.15       
 [94] lmtest_0.9-40          RANN_2.6.1             fitdistrplus_1.1-11   
 [97] R.cache_0.16.0         matrixStats_0.63.0     hms_1.1.3             
[100] patchwork_1.1.2        mime_0.12              evaluate_0.20         
[103] xtable_1.8-4           IRanges_2.28.0         gridExtra_2.3         
[106] shape_1.4.6            compiler_4.1.3         KernSmooth_2.23-20    
[109] crayon_1.5.2           R.oo_1.25.0            htmltools_0.5.5       
[112] later_1.3.0            tzdb_0.3.0             Formula_1.2-5         
[115] ggprism_1.0.4          tweenr_2.0.2           ComplexHeatmap_2.10.0 
[118] MASS_7.3-55            Matrix_1.5-4           cli_3.6.1             
[121] R.methodsS3_1.8.2      parallel_4.1.3         gower_1.0.1           
[124] igraph_1.4.2           pkgconfig_2.0.3        foreign_0.8-82        
[127] sp_1.6-0               plotly_4.10.1          spatstat.sparse_3.0-1 
[130] recipes_1.0.6          xml2_1.3.3             paletteer_1.5.0       
[133] foreach_1.5.2          vipor_0.4.5            hardhat_1.3.0         
[136] prodlim_2023.03.31     snakecase_0.11.0       callr_3.7.3           
[139] digest_0.6.31          sctransform_0.3.5.9002 RcppAnnoy_0.0.20      
[142] janitor_2.2.0          spatstat.data_3.0-1    rmarkdown_2.21        
[145] leiden_0.4.3           htmlTable_2.4.1        uwot_0.1.14           
[148] shiny_1.7.4            rjson_0.2.21           lifecycle_1.0.3       
[151] nlme_3.1-155           jsonlite_1.8.4         limma_3.50.3          
[154] desc_1.4.2             viridisLite_0.4.1      fansi_1.0.4           
[157] pillar_1.9.0           lattice_0.20-45        ggrastr_1.0.1         
[160] fastmap_1.1.1          httr_1.4.5             survival_3.3-1        
[163] glue_1.6.2             remotes_2.4.2          fdrtool_1.2.17        
[166] png_0.1-8              iterators_1.0.14       ggforce_0.4.1         
[169] class_7.3-20           stringi_1.7.12         rematch2_2.1.2        
[172] textshaping_0.3.6      caTools_1.18.2         e1071_1.7-13          
[175] irlba_2.3.5.1          future.apply_1.10.0

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: 81 minutes
# Hands-on time however is between 10-15 minutes!
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "ccc",
  "02_differential_ccc_nichenet.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "ccc",
  "02_differential_ccc_nichenet.Rmd"
))
```

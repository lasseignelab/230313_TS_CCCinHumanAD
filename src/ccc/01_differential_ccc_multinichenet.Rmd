---
title: "01_differential_ccc_multinichenet"
author: "Tabea M. Soelter"
date: '2023-07-19'
output: html_document
---
**Differential Cell-Cell Communication Analysis using MultiNicheNet**

__Goal__: For every dataset, perform MultiNicheNet analyses between AD and CTRL to identify ligands, receptors, and potential downstream target genes between glia (Astrocytes, Oligodendrocytes, Microglia, and OPCs - senders) and Excitatory/Inhibitory Neurons (receivers).
  
__Reproducibility__: 
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.3 
* HPC: Yes
  * Resources: long partition (150hrs), 10 CPUs, 65GB per CPU

__Data__:
*Seurat objects*
* Name: geo_processed_seurat.rds, gse_processed_seurat.rds
* Location: data/seurat_preprocessing/
 
__Analysis Plan__:
* Load necessary packages 
* Load data
  * Seurat objects
* Load and filter NicheNet v2 prior
* Prepare for NicheNet
  * Determine cut-offs and comparisons
* Differential NicheNet using MultiNicheNet
  * Wrapper function
* Save outputs
  
# load packages
```{r}
# Time tracking
ptm <- proc.time()

# Setting seed
set.seed(42)

# Setting locale
options(encoding = "UTF-8")

# Load packages
suppressPackageStartupMessages({
  library(nichenetr)
  library(multinichenetr)
  library(SingleCellExperiment)
  library(tidyverse)
  library(tibble)
  library(Seurat)
  library(here)
  library(styler)
  library(lintr)
})

source(here("src", "functions_CCCinAD_tms.R"))
```

# NicheNet-v2 prior
* downloaded here: https://zenodo.org/record/7074291
```{r}
lr_network <- readRDS(here(
  "data",
  "ccc",
  "nichenet_v2_prior",
  "lr_network_human_21122021.rds"
)) %>%
  dplyr::rename(ligand = from, receptor = to) %>%
  distinct(ligand, receptor) %>%
  mutate(ligand = make.names(ligand), receptor = make.names(receptor))

ligand_target_matrix <- readRDS(here(
  "data",
  "ccc",
  "nichenet_v2_prior",
  "ligand_target_matrix_nsga2r_final.rds"
))

# format row and column names
colnames(ligand_target_matrix) <- colnames(ligand_target_matrix) %>%
  make.names()
rownames(ligand_target_matrix) <- rownames(ligand_target_matrix) %>%
  make.names()
```

# Load data
```{r}
geo_object <- readRDS(here(
  "data",
  "seurat_preprocessing",
  "geo_processed_seurat.rds"
))

gse_object <- readRDS(here(
  "data",
  "seurat_preprocessing",
  "gse_processed_seurat.rds"
))
```

# Convert seurat objects
```{r}
# GEO
geo <- Seurat::as.SingleCellExperiment(geo_object, assay = "RNA")
geo <- alias_to_symbol_SCE(geo, "human") %>% makenames_SCE()

# GSE
gse <- Seurat::as.SingleCellExperiment(gse_object, assay = "RNA")
gse <- alias_to_symbol_SCE(gse, "human") %>% makenames_SCE()
```

# Create object list
```{r}
object_list <- lst(geo, gse)
```

# Make names syntactically valid
```{r}
object_list <- lapply(object_list, make_names_valid)

list2env(object_list, globalenv())
```

# Set variables for wrapper
```{r}
# sample IDs
sample_id <- "sample"

# condition information
group_id <- "orig.ident"

# cell type information
celltype_id <- "ident"

# Other DE variables were denoted as `NA`
covariates <- NA
batches <- NA

# Since we have small sample numbers, we do not use adjusted p-values
empirical_pval <- FALSE
p_val_adj <- FALSE

# Number of cores of the HPC session
cores_system <- 10
```

# Prioritization weights
* These weights are recommended by the developers of MultiNicheNet. There are more detailed descriptions in the following step-by-step vignette:
  * https://github.com/saeyslab/multinichenetr/blob/main/vignettes/pairwise_analysis_MISC.md 
```{r}
prioritizing_weights_DE <- c(
  "de_ligand" = 1,
  "de_receptor" = 1
)

prioritizing_weights_activity <- c(
  "activity_scaled" = 2
)

prioritizing_weights_expression_specificity <- c(
  "exprs_ligand" = 2,
  "exprs_receptor" = 2
)

prioritizing_weights_expression_sufficiency <- c(
  "frac_exprs_ligand_receptor" = 1
)

prioritizing_weights_relative_abundance <- c(
  "abund_sender" = 0,
  "abund_receiver" = 0
)

# Combine all weights into 1 variable
prioritizing_weights <- c(
  prioritizing_weights_DE,
  prioritizing_weights_activity,
  prioritizing_weights_expression_specificity,
  prioritizing_weights_expression_sufficiency,
  prioritizing_weights_relative_abundance
)
```

# Contrast table
* The format of the contrast table (1st line of code in the following chunk) requires no spacing, therefore ensure that the contrast_oi table has no unnecessary spaces or characters. 
```{r}
contrasts_oi <- c("'AD-CTRL','CTRL-AD'")

contrast_tbl <- tibble(
  contrast = c("AD-CTRL", "CTRL-AD"),
  group = c("AD", "CTRL")
)
```

# CCC identification
```{r}
# path for abundance expression plots
results_path <- "results/intermediate_outputs/"

# this runs for approx 45 minutes
multinichenet_outputs <- multinichenet_wrapper(
  object_list = object_list,
  results_path = results_path,
  celltype_id = celltype_id,
  sample_id = sample_id,
  group_id = group_id,
  lr_network = lr_network,
  batches = batches,
  contrasts_oi = contrasts_oi,
  contrast_tbl = contrast_tbl,
  covariates = covariates,
  empirical_pval = empirical_pval,
  p_val_adj = p_val_adj,
  cores_system = cores_system,
  ligand_target_matrix = ligand_target_matrix,
  prioritizing_weights = prioritizing_weights
)

# unlist geo and gse objects
list2env(multinichenet_outputs, globalenv())
```

# Save outputs
```{r}
saveRDS(geo_multinichenet_output, here(
  "data",
  "ccc",
  "geo_multinichenet_output.rds"))

saveRDS(gse_multinichenet_output, here(
  "data",
  "ccc",
  "gse_multinichenet_output.rds"))
```

# Session info
```{r}
sessionInfo() # see output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] here_1.0.1                  SeuratObject_4.1.3          Seurat_4.3.0.9011          
 [4] lubridate_1.9.2             forcats_1.0.0               stringr_1.5.0              
 [7] dplyr_1.1.2                 purrr_1.0.1                 readr_2.1.4                
[10] tidyr_1.3.0                 tibble_3.2.1                ggplot2_3.4.2              
[13] tidyverse_2.0.0             SingleCellExperiment_1.16.0 SummarizedExperiment_1.24.0
[16] Biobase_2.54.0              GenomicRanges_1.46.1        GenomeInfoDb_1.30.1        
[19] IRanges_2.28.0              S4Vectors_0.32.4            BiocGenerics_0.40.0        
[22] MatrixGenerics_1.6.0        matrixStats_1.0.0           multinichenetr_1.0.0       
[25] nichenetr_2.0.0            

loaded via a namespace (and not attached):
  [1] rsvd_1.0.5                Hmisc_5.1-0               ica_1.0-3                
  [4] class_7.3-20              rprojroot_2.0.3           foreach_1.5.2            
  [7] lmtest_0.9-40             crayon_1.5.2              rbibutils_2.2.13         
 [10] MASS_7.3-55               rhdf5filters_1.6.0        nlme_3.1-155             
 [13] backports_1.4.1           sva_3.42.0                rlang_1.1.1              
 [16] XVector_0.34.0            caret_6.0-94              ROCR_1.0-11              
 [19] irlba_2.3.5.1             nloptr_2.0.3              limma_3.50.3             
 [22] scater_1.22.0             BiocParallel_1.28.3       rjson_0.2.21             
 [25] bit64_4.0.5               glue_1.6.2                sctransform_0.3.5.9006   
 [28] pbkrtest_0.5.2            parallel_4.1.3            vipor_0.4.5              
 [31] spatstat.sparse_3.0-2     AnnotationDbi_1.56.2      UpSetR_1.4.0             
 [34] muscat_1.8.2              spatstat.geom_3.2-2       tidyselect_1.2.0         
 [37] fitdistrplus_1.1-11       variancePartition_1.24.1  XML_3.99-0.14            
 [40] zoo_1.8-12                ggpubr_0.6.0              xtable_1.8-4             
 [43] magrittr_2.0.3            evaluate_0.21             Rdpack_2.4               
 [46] scuttle_1.4.0             cli_3.6.1                 zlibbioc_1.40.0          
 [49] diffobj_0.3.5             rstudioapi_0.14           miniUI_0.1.1.1           
 [52] sp_2.0-0                  rpart_4.1.16              aod_1.3.2                
 [55] locfdr_1.1-8              shiny_1.7.4.1             BiocSingular_1.10.0      
 [58] xfun_0.39                 clue_0.3-64               cluster_2.1.2            
 [61] caTools_1.18.2            tidygraph_1.2.3           KEGGREST_1.34.0          
 [64] ggrepel_0.9.3             listenv_0.9.0             Biostrings_2.62.0        
 [67] png_0.1-8                 future_1.33.0             ipred_0.9-14             
 [70] withr_2.5.0               bitops_1.0-7              ggforce_0.4.1            
 [73] plyr_1.8.8                hardhat_1.3.0             e1071_1.7-13             
 [76] dqrng_0.3.0               pROC_1.18.2               coda_0.19-4              
 [79] pillar_1.9.0              gplots_3.1.3              GlobalOptions_0.1.2      
 [82] cachem_1.0.8              GetoptLong_1.0.5          DelayedMatrixStats_1.16.0
 [85] vctrs_0.6.3               ellipsis_0.3.2            generics_0.1.3           
 [88] lava_1.7.2.1              tools_4.1.3               foreign_0.8-82           
 [91] beeswarm_0.4.0            munsell_0.5.0             tweenr_2.0.2             
 [94] emmeans_1.8.6             proxy_0.4-27              DelayedArray_0.20.0      
 [97] fastmap_1.1.1             compiler_4.1.3            abind_1.4-5              
[100] httpuv_1.6.11             plotly_4.10.2             GenomeInfoDbData_1.2.7   
[103] prodlim_2023.03.31        gridExtra_2.3             glmmTMB_1.1.7            
[106] edgeR_3.36.0              lattice_0.20-45           ggnewscale_0.4.9         
[109] deldir_1.0-9              visNetwork_2.1.2          utf8_1.2.3               
[112] later_1.3.1               recipes_1.0.6             jsonlite_1.8.7           
[115] scales_1.2.1              ScaledMatrix_1.2.0        carData_3.0-5            
[118] pbapply_1.7-2             sparseMatrixStats_1.6.0   estimability_1.4.1       
[121] genefilter_1.76.0         lazyeval_0.2.2            promises_1.2.0.1         
[124] car_3.1-2                 doParallel_1.0.17         R.utils_2.12.2           
[127] goftest_1.2-3             spatstat.utils_3.0-3      reticulate_1.30          
[130] checkmate_2.2.0           rmarkdown_2.23            cowplot_1.1.1            
[133] blme_1.0-5                statmod_1.5.0             Rtsne_0.16               
[136] uwot_0.1.16               igraph_1.5.0              HDF5Array_1.22.1         
[139] survival_3.3-1            numDeriv_2016.8-1.1       yaml_2.3.7               
[142] htmltools_0.5.5           memoise_2.0.1             locfit_1.5-9.8           
[145] graphlayouts_1.0.0        viridisLite_0.4.2         RhpcBLASctl_0.23-42      
[148] digest_0.6.33             mime_0.12                 RSQLite_2.3.1            
[151] future.apply_1.11.0       data.table_1.14.8         blob_1.2.4               
[154] R.oo_1.25.0               DiagrammeR_1.0.10         labeling_0.4.2           
[157] splines_4.1.3             Formula_1.2-5             rematch2_2.1.2           
[160] Rhdf5lib_1.16.0           RCurl_1.98-1.12           broom_1.0.5              
[163] hms_1.1.3                 rhdf5_2.38.1              colorspace_2.1-0         
[166] DropletUtils_1.14.2       base64enc_0.1-3           ggbeeswarm_0.7.2         
[169] shape_1.4.6               nnet_7.3-17               Rcpp_1.0.11              
[172] RANN_2.6.1                mvtnorm_1.2-2             circlize_0.4.15          
[175] fansi_1.0.4               tzdb_0.4.0                waldo_0.5.1              
[178] parallelly_1.36.0         ModelMetrics_1.2.2.2      R6_2.5.1                 
[181] grid_4.1.3                factoextra_1.0.7          ggridges_0.5.4           
[184] lifecycle_1.0.3           bluster_1.4.0             ggsignif_0.6.4           
[187] minqa_1.2.5               leiden_0.4.3              Matrix_1.5-4             
[190] RcppAnnoy_0.0.21          RColorBrewer_1.1-3        iterators_1.0.14         
[193] spatstat.explore_3.2-1    TMB_1.9.4                 gower_1.0.1              
[196] htmlwidgets_1.6.2         beachmat_2.10.0           polyclip_1.10-4          
[199] shadowtext_0.1.2          timechange_0.2.0          mgcv_1.8-39              
[202] ComplexHeatmap_2.10.0     globals_0.16.2            htmlTable_2.4.1          
[205] patchwork_1.1.2           spatstat.random_3.1-5     progressr_0.13.0         
[208] codetools_0.2-18          metapod_1.2.0             randomForest_4.7-1.1     
[211] gtools_3.9.4              prettyunits_1.1.1         R.methodsS3_1.8.2        
[214] gtable_0.3.3              DBI_1.1.3                 tensor_1.5               
[217] httr_1.4.6                KernSmooth_2.23-20        stringi_1.7.12           
[220] progress_1.2.2            reshape2_1.4.4            farver_2.1.1             
[223] annotate_1.72.0           viridis_0.6.3             fdrtool_1.2.17           
[226] timeDate_4022.108         boot_1.3-28               BiocNeighbors_1.12.0     
[229] lme4_1.1-33               geneplotter_1.72.0        scattermore_1.2          
[232] scran_1.22.1              DESeq2_1.34.0             bit_4.0.5                
[235] spatstat.data_3.0-1       ggraph_2.1.0              pkgconfig_2.0.3          
[238] lmerTest_3.1-3            rstatix_0.7.2             knitr_1.43

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: 60 minutes
# Hands-on time however is between 15 minutes!
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "ccc",
  "01_differential_ccc_multinichenet.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "ccc",
  "01_differential_ccc_multinichenet.Rmd"
))
```

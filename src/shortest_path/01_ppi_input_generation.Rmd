---
title: "01_ppi_input_generation"
author: "Tabea M. Soelter"
date: '2023-05-15'
output: html_document
---
**PPI input generation**
__Goal__: Generating all of the required inputs and txt files for generating PPIs with condition-specific edge weights in order to calculate the shortest path between all nodes of interest.

__Reproducibility__:
* GitHub: lasseignelab/230313_TS_CCCinHumanAD
* Docker: tsoelter/rstudio_ccc_ad
    * Version: 1.0.3
* HPC: Yes
  * Resources: long partition (150hrs), 6 CPUs, 65GB per CPU
  
__Data__: 
*Seurat objects*
* Name: geo_processed_seurat.rds, gse_processed_seurat.rds
* Location: /data/user/tsoelter/projects/230313_TS_CCCinHumanAD/data/

*AD-risk genes*
* Name: ad_gene_list.csv
* Location: /data/user/tsoelter/projects/230313_TS_CCCinHumanAD/data/ccc/


__Analysis Plan__:
* Load necessary packages 
* Load data 
* Download STRINGdb interactions
* Process STRINGdb interactions
* Save outputs to be used as inputs for PPI construction
* Create and save txt files with paths to files for array jobs

__Analysis__:
# Load packages
```{r}
# Time tracking
ptm <- proc.time()

# Setting seed
set.seed(42)

# Load packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(STRINGdb)
  library(here)
  library(styler)
  library(lintr)
})

source(here("src", "functions_CCCinAD_tms.R"))
```

# Load data
```{r}
# Seurat objects
geo_object <- readRDS(here(
  "data",
  "seurat_preprocessing",
  "geo_processed_seurat.rds"
))

gse_object <- readRDS(here(
  "data",
  "seurat_preprocessing",
  "gse_processed_seurat.rds"
))

# AD-risk gene list
ad_gene_list <- read.csv(
  here(
    "data",
    "ccc",
    "ad_gene_list.csv"
  ),
  header = FALSE
) %>% unique()
```

# Download STRINGdb interactions
* I am including interactions with any confidence score
* The human species code is 9606
* Version 11.5 as of 230724
```{r}
ppi <- STRINGdb$new(
  version = "11.5",
  species = as.numeric(9606),
  score_threshold = 0
)
```

# Array input generation
* Since the array job within the docker was not allowing me to access STRINGdb, I generated necessary inputs for PPI construction beforehand.
* The outputs generated below were used as inputs for the PPI construction and shortest path array jobs.
* Here I mapped genes from STRINGdb and created a temporary ppi.
```{r}
# create list of all Seurat objects
object_list <- tibble::lst(
  geo_object,
  gse_object
)

# loop generation 2 necessary inputs for each Seurat object and saves them
for (name in names(object_list)) {
  # grab object from global environment -----
  object <- get(name)
  # change name for saving purposes -----
  name <- sub("_object.*", "", name)
  # grab all genes detected in Seurat object -----
  all_genes <- object@assays[["RNA"]]@counts@Dimnames[[1]] %>%
    as.data.frame() %>%
    rename("target" = ".")
  # map genes (all and AD-risk) -----
  mapped_genes <- map_genes(all_genes,
    gene_list = ad_gene_list
  )
  # save mapped genes -----
  saveRDS(mapped_genes, file = here(paste0(
    "results/intermediate_outputs/inputs/",
    name,
    "_mapped_genes.rds"
  )))
  # create temporary ppi object -----
  ppi_tmp <- ppi$get_interactions(mapped_genes$STRING_id)
  # save temporary ppi object -----
  saveRDS(ppi_tmp, file = here(paste0(
    "results/intermediate_outputs/inputs/",
    name,
    "_ppi_tmp.rds"
  )))
}
```
__Output of above for loop__
Warning:  we couldn't map to STRING 43% of your identifiers
Warning:  we couldn't map to STRING 44% of your identifiers

# Txt input file generation
* I created txt files with the paths to the objects needed in all PPI and shortest path array jobs. 

_ppi construction: gex inputs_
```{r}
ppi_construction_gex_inputs <- dir(
  here(
    "data",
    "seurat_preprocessing"
  ),
  full.names = TRUE,
  recursive = FALSE,
  pattern = "_processed_seurat.rds"
)



write.table(ppi_construction_gex_inputs,
  file = here(
    "results",
    "intermediate_outputs",
    "inputs",
    "ppi_construction_gex_inputs.txt"
  ),
  row.names = FALSE,
  col.names = FALSE,
  quote = FALSE,
  sep = "\t"
)
```

_ppi construction: gene inputs_
```{r}
ppi_construction_gene_inputs <- dir(
  here(
    "results",
    "intermediate_outputs",
    "inputs"
  ),
  full.names = TRUE,
  recursive = FALSE,
  pattern = "_mapped_genes.rds"
)

write.table(ppi_construction_gene_inputs,
  file = here(
    "results",
    "intermediate_outputs",
    "inputs",
    "ppi_construction_gene_inputs.txt"
  ),
  row.names = FALSE,
  col.names = FALSE,
  quote = FALSE,
  sep = "\t"
)
```

_ppi construction: tmp ppi inputs_
```{r}
ppi_construction_ppi_inputs <- dir(
  here(
    "results",
    "intermediate_outputs",
    "inputs"
  ),
  full.names = TRUE,
  recursive = FALSE,
  pattern = "_ppi_tmp.rds"
)

write.table(ppi_construction_ppi_inputs,
  file = here(
    "results",
    "intermediate_outputs",
    "inputs",
    "ppi_construction_ppi_inputs.txt"
  ),
  row.names = FALSE,
  col.names = FALSE,
  quote = FALSE,
  sep = "\t"
)
```

# Session Info
```{r}
sessionInfo() # output below
```
R version 4.1.3 (2022-03-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.6 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
[1] C

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lintr_3.0.2     styler_1.9.1    here_1.0.1      STRINGdb_2.6.5  lubridate_1.9.2
 [6] forcats_1.0.0   stringr_1.5.0   dplyr_1.1.2     purrr_1.0.1     readr_2.1.4    
[11] tidyr_1.3.0     tibble_3.2.1    ggplot2_3.4.2   tidyverse_2.0.0

loaded via a namespace (and not attached):
  [1] plyr_1.8.8             igraph_1.5.0           lazyeval_0.2.2        
  [4] sp_2.0-0               splines_4.1.3          listenv_0.9.0         
  [7] scattermore_1.2        digest_0.6.33          htmltools_0.5.5       
 [10] fansi_1.0.4            magrittr_2.0.3         memoise_2.0.1         
 [13] tensor_1.5             cluster_2.1.2          ROCR_1.0-11           
 [16] tzdb_0.4.0             remotes_2.4.2          globals_0.16.2        
 [19] matrixStats_1.0.0      R.utils_2.12.2         spatstat.sparse_3.0-2 
 [22] timechange_0.2.0       colorspace_2.1-0       blob_1.2.4            
 [25] ggrepel_0.9.3          xfun_0.39              callr_3.7.3           
 [28] crayon_1.5.2           RCurl_1.98-1.12        jsonlite_1.8.7        
 [31] progressr_0.13.0       spatstat.data_3.0-1    survival_3.3-1        
 [34] zoo_1.8-12             glue_1.6.2             hash_2.2.6.2          
 [37] polyclip_1.10-4        gtable_0.3.3           leiden_0.4.3          
 [40] R.cache_0.16.0         future.apply_1.11.0    abind_1.4-5           
 [43] scales_1.2.1           DBI_1.1.3              spatstat.random_3.1-5 
 [46] miniUI_0.1.1.1         Rcpp_1.0.11            plotrix_3.8-2         
 [49] viridisLite_0.4.2      xtable_1.8-4           reticulate_1.30       
 [52] bit_4.0.5              sqldf_0.4-11           htmlwidgets_1.6.2     
 [55] rex_1.2.1              httr_1.4.6             gplots_3.1.3          
 [58] RColorBrewer_1.1-3     ellipsis_0.3.2         Seurat_4.3.0.9011     
 [61] ica_1.0-3              pkgconfig_2.0.3        R.methodsS3_1.8.2     
 [64] uwot_0.1.16            deldir_1.0-9           utf8_1.2.3            
 [67] tidyselect_1.2.0       rlang_1.1.1            reshape2_1.4.4        
 [70] later_1.3.1            munsell_0.5.0          tools_4.1.3           
 [73] cachem_1.0.8           cli_3.6.1              gsubfn_0.7            
 [76] generics_0.1.3         RSQLite_2.3.1          ggridges_0.5.4        
 [79] evaluate_0.21          fastmap_1.1.1          goftest_1.2-3         
 [82] yaml_2.3.7             processx_3.8.1         knitr_1.43            
 [85] bit64_4.0.5            fitdistrplus_1.1-11    caTools_1.18.2        
 [88] RANN_2.6.1             nlme_3.1-155           pbapply_1.7-2         
 [91] future_1.33.0          mime_0.12              R.oo_1.25.0           
 [94] xml2_1.3.3             compiler_4.1.3         rstudioapi_0.14       
 [97] plotly_4.10.2          png_0.1-8              spatstat.utils_3.0-3  
[100] stringi_1.7.12         cyclocomp_1.1.0        ps_1.7.5              
[103] desc_1.4.2             lattice_0.20-45        Matrix_1.5-4          
[106] vctrs_0.6.3            pillar_1.9.0           lifecycle_1.0.3       
[109] spatstat.geom_3.2-2    lmtest_0.9-40          RcppAnnoy_0.0.21      
[112] data.table_1.14.8      cowplot_1.1.1          bitops_1.0-7          
[115] irlba_2.3.5.1          httpuv_1.6.11          patchwork_1.1.2       
[118] R6_2.5.1               promises_1.2.0.1       KernSmooth_2.23-20    
[121] gridExtra_2.3          parallelly_1.36.0      codetools_0.2-18      
[124] MASS_7.3-55            gtools_3.9.4           chron_2.3-60          
[127] proto_1.0.0            rprojroot_2.0.3        withr_2.5.0           
[130] SeuratObject_4.1.3     sctransform_0.3.5.9006 parallel_4.1.3        
[133] hms_1.1.3              grid_4.1.3             rmarkdown_2.23        
[136] Rtsne_0.16             spatstat.explore_3.2-1 shiny_1.7.4.1

# Time tracking
```{r}
fptm <- proc.time() - ptm

# convert to minutes
(fptm[3] / 60)

# Time elapsed: 15 minutes
```

# Reproducibility
```{r}
# styler
style_file(here(
  "src",
  "shortest_path",
  "01_ppi_input_generation.Rmd"
))

# lintr
lint(filename = here(
  "src",
  "shortest_path",
  "01_ppi_input_generation.Rmd"
))
```
